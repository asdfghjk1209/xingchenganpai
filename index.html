<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>è¡Œç¨‹å®‰æ’</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script>
      window._AMapSecurityConfig = {
        securityJsCode: '6da6d6eb1afc97f8609795ec43fbec9f',
      };

      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ios: {
                blue: '#007AFF',
                gray: '#F2F2F7',
                card: 'rgba(255, 255, 255, 0.72)',
                text: '#1C1C1E',
                subtext: '#8E8E93',
                destruct: '#FF3B30',
                success: '#34C759',
              }
            },
            fontFamily: {
              sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
            }
          }
        }
      }
    </script>

    <style>
      body { background-color: #F2F2F7; -webkit-tap-highlight-color: transparent; }
      .glass { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0, 0, 0, 0.05); }
      .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.05); }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      @media (min-width: 768px) {
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: transparent; border-radius: 20px; transition: background-color 0.3s ease; }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.15); }
      }

      /* Time Picker Scroll Snap */
      .time-scroll-col {
        scroll-snap-type: y mandatory;
        overscroll-behavior: contain;
      }
      .time-scroll-item {
        scroll-snap-align: center;
      }

      /* Drag and Drop Styles */
      .dragging {
          opacity: 0.5;
          border: 4px dashed #007AFF !important;
          background: rgba(255, 255, 255, 0.4) !important;
          /* FIX: Added visual transformation for mobile stability */
          transform: scale(0.98); 
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
          transition: all 0.1s ease-out;
      }
      .drag-over {
          border-top: 4px solid #007AFF !important;
      }
      
      .amap-logo, .amap-copyright { z-index: 1 !important; display: block !important; pointer-events: none; }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calendar, Map, Share2, Settings, ChevronLeft, ChevronRight, Edit3, Check, Copy, Download, Upload, Menu,
            Navigation2, Map as MapIcon, RefreshCw, Loader2, ExternalLink,
            Clock, MapPin, Coffee, Camera, MoveVertical, Image as ImageIcon, Trash2,
            CloudRain, Search, X, Plus, CalendarDays, LocateFixed, AlertCircle, Info, MapPinOff, Image, Eye, EyeOff,
            Navigation, RotateCw, ArrowDown, Lightbulb, ChevronUp, ChevronDown, FileText, FileUp, FileDown, ArrowUp, ArrowDown as ArrowDownIcon
        } from 'lucide-react';

        // --- UTILS & DATA ---

        const extractLocation = (l, title) => {
            if (l && l.includes('query=')) {
                try { return decodeURIComponent(l.split('query=')[1].split('&')[0]); } catch (e) { return title.split('(')[0]; }
            }
            let clean = title.split('(')[0].split('ï¼ˆ')[0].trim();
            clean = clean.replace(/^(æ™šé¤|åˆé¤|æ—©é¤|ä½å®¿|å…¥ä½|é…’åº—)[:ï¼š]\s*/, '');
            return clean;
        };

        const ACTIVITY_TYPES = ['spot', 'food', 'rest', 'transport', 'other'];
        
        const getTypeClasses = (type) => {
            switch (type) {
                case 'spot':
                    return 'bg-blue-100 text-blue-700'; // æ™¯ç‚¹/æ´»åŠ¨: è“è‰²
                case 'food':
                    return 'bg-red-100 text-red-700'; // ç¾é£Ÿ: çº¢è‰²/æ©™è‰²
                case 'rest':
                    return 'bg-green-100 text-green-700'; // ä½å®¿/ä¼‘æ¯: ç»¿è‰²
                case 'transport':
                    return 'bg-yellow-100 text-yellow-700'; // äº¤é€š: é»„è‰²
                case 'other':
                    return 'bg-gray-200 text-gray-700'; // å…¶ä»–: ç°è‰²
                default:
                    return 'bg-gray-100 text-gray-600';
            }
        };


        const RAW_DATA = [
            {"id":"p1","name":"A: è½åœ° & å¸‚åŒºæ¼«æ¸¸","days":[{"title":"è½åœ° & ä¼‘æ¯","items":[{"t":"14:30","tit":"å…¥ä½é…’åº—","desc":"æ¨èæ˜¥ç†™è·¯/å¤ªå¤é‡Œã€‚å…ˆæ•´ç†ä¼‘æ¯ï¼Œä¸æ€¥å‡ºé—¨ã€‚\né…’åº—æ¨èï¼šå…¨å­£/äºšæœµ","l":"","lt":"","imgs":[],"trans":"","type":"rest"},{"t":"17:00","tit":"å¤ªå¤é‡Œæ¼«æ­¥","desc":"çœ‹IFSç†ŠçŒ«å±è‚¡ï¼Œå¤§æ…ˆå¯ºçº¢å¢™æ‹ç…§ã€‚","l":"https://ditu.amap.com/search?query=å¤ªå¤é‡Œ","lt":"ğŸ“ å¯¼èˆª","imgs":[],"trans":"ğŸš¶ æ­¥è¡Œ","type":"spot"},{"t":"19:00","tit":"æ™šé¤: å¥æ˜Ÿæ¥¼è¡—","desc":"å†’æ¤’ç«è¾£ï¼ˆå†·é”…ä¸²ä¸²ï¼Œå°èœå¾ˆå¥½åƒï¼›äººå¤šæ’é˜Ÿæ—©å»ï¼‰ã€\nç³–æ²¹æœå­ï¼ˆåœ¨å†’æ¤’ç«è¾£æ—è¾¹ä¸€æ¡è¡— æ—©ç‚¹å»ï¼Œå»æ™šäº†å°±å–å®Œäº†ï¼‰ã€\nè›‹çƒ˜ç³•","l":"https://ditu.amap.com/search?query=å¥æ˜Ÿæ¥¼è¡—","lt":"ğŸ“ å¯¼èˆª","imgs":[],"trans":"ğŸš— æ‰“è½¦ 15å…ƒ","type":"food"}]}]},
            {"id":"p2","name":"B: é’åŸå±±é—®é“","days":[{"title":"é—®é“é’åŸå±±","items":[{"t":"09:00","tit":"é’åŸå±±","desc":"é«˜é“ç›´è¾¾ï¼ŒçŠ€æµ¦ç«™å‡ºå‘ï¼Œå¯é€‰æ‹©å‰å±±æˆ–åå±±\nå‰å±±ï¼šå¯ºåº™ä¹‹ç±»ã€ä½“éªŒé“å®¶æ–‡åŒ–\nåå±±ï¼šé£æ™¯","l":"","lt":"","imgs":[],"trans":"ğŸš„ é«˜é“","type":"spot"}]}]},
            {"id":"p1763809470975","name":"C: ç»å…¸å¿…æ‰“å¡","days":[{"title":"ç»å…¸ä¸€æ—¥æ¸¸","items":[{"t":"10:00","tit":"é”¦é‡Œ/å®½çª„å··å­","desc":"","l":"","lt":"","imgs":[],"trans":"","type":"spot"},{"t":"12:00","tit":"åˆé¥­","desc":"éšä¾¿æ‰¾å®¶è‹è‡é¦†å­","l":"","lt":"","imgs":[],"trans":"","type":"food"},{"t":"14:00","tit":"äººæ°‘å…¬å›­","desc":"å–èŒ¶","l":"","lt":"","imgs":[],"trans":"","type":"spot"},{"t":"17:00","tit":"æ™šé¤","desc":"","l":"","lt":"","imgs":[],"trans":"","type":"food"}]}]},
            {"id":"p1763816913099","name":"D: ç†ŠçŒ« & ç”µå½±","days":[{"title":"ç†ŠçŒ« & ç”œå“","items":[{"t":"09:30","tit":"ç†ŠçŒ«åŸºåœ°(å—é—¨)","desc":"æ‰“è½¦ç›´è¾¾å—é—¨ï¼Œä¸æ’é˜Ÿã€‚","l":"https://ditu.amap.com/search?query=ç†ŠçŒ«åŸºåœ°å—é—¨","lt":"ğŸ“ å¯¼èˆª","imgs":[],"trans":"","type":"spot"},{"t":"16:00","tit":"å°±è¿‘å¸‚åŒºåƒé¥­","desc":"","l":"https://ditu.amap.com/search?query=å¥æ˜Ÿæ¥¼è¡—","lt":"ğŸ“ å¯¼èˆª","imgs":[],"trans":"","type":"food"},{"t":"18:00","tit":"çœ‹ç”µå½±","desc":"ç–¯ç‹‚åŠ¨ç‰©åŸï¼ˆè®°å¾—ä¹°imaxåŸå£°ï¼‰","l":"","lt":"","imgs":[],"trans":"","type":"spot"}]}]},
            {"id":"p1763816971141","name":"E: æ–‡è‰ºæ‰“å¡","days":[{"title":"æ–‡è‰ºæˆéƒ½","items":[{"t":"10:00","tit":"äººæ°‘å…¬å›­","desc":"å–èŒ¶ï¼Œæ„Ÿå—æˆéƒ½äººæ°‘æ…¢ç”Ÿæ´»","l":"","lt":"","imgs":[],"trans":"","type":"spot"},{"t":"13:00","tit":"å®½çª„å··å­","desc":"","l":"","lt":"","imgs":[],"trans":"","type":"spot"},{"t":"16:00","tit":"ä¸œéƒŠè®°å¿†","desc":"ç‰¹è‰²å·¥ä¸šå›­åŒºï¼Œæ‹ç…§å‡ºç‰‡","l":"","lt":"","imgs":[],"trans":"","type":"spot"},{"t":"18:00","tit":"å»ºè®¾è·¯","desc":"é›†ç»“å„ç§å°åƒï¼Œè¾¹é€›è¾¹åƒ","l":"","lt":"","imgs":[],"trans":"","type":"food"}]}]},
            {"id":"p1763817288235","name":"F: æ‰‹ä½œæ—¶å…‰","days":[{"title":"å®‰é™åˆå","items":[{"t":"10:00","tit":"æ‰‹å·¥DIY","desc":"é“¶é¥°/é™¶è‰º","l":"","lt":"","imgs":[],"trans":"","type":"spot"}]}]},
            {"id":"p1763828749511","name":"G: ç‰¹ç§å…µ(ä¼ª) Day1","days":[{"title":"ç†ŠçŒ« & å¥æ˜Ÿæ¥¼","items":[{"t":"07:30","tit":"å¤§ç†ŠçŒ«åŸºåœ°(å—é—¨)","desc":"âš ï¸é‡ç‚¹ï¼šä¸€å®šè¦èµ°å—é—¨ï¼è¿›é—¨åšæ‘†æ¸¡è½¦ç›´å†²æœ€ä¸Šé¢ï¼Œç„¶åèµ°ä¸‹æ¥çœ‹ã€‚\nå¿…çœ‹ï¼šèŠ±èŠ±ï¼ˆæ’é˜Ÿä¹…ï¼‰ã€èŒå…°ã€‚\nå»ºè®®ï¼šæ—©å»ï¼Œç†ŠçŒ«ä¸­åˆå°±ç¡è§‰äº†ã€‚","l":"","trans":"ğŸš— æ‰“è½¦ 40min","imgs":[],"lt":"","type":"spot"},{"t":"12:30","tit":"å»ºè®¾è·¯/å¥æ˜Ÿæ¥¼","desc":"çœ‹å®Œç†ŠçŒ«é¥¿äº†ç›´æ¥å»åƒï¼\næ¨èï¼šå†’æ¤’ç«è¾£ã€è›‹çƒ˜ç³•ã€å†°ç²‰ã€‚\né¿é›·ï¼šä¸è¦ä¹°è·¯è¾¹çš„é‡‘è¥¿æ¢…ï¼ˆæŸ“è‰²çš„ï¼‰ã€‚","l":"","trans":"ğŸš‡ åœ°é“3å·çº¿","imgs":[],"lt":"","type":"food"},{"t":"15:30","tit":"å®½çª„å··å­","desc":"åªé€›ä¸ä¹°ï¼æ„Ÿå—ä¸€ä¸‹å»ºç­‘é£æ ¼å°±è¡Œã€‚\næ¸¸å®¢ç…§æ‰“å¡ç‚¹ï¼Œå•†ä¸šåŒ–æ¯”è¾ƒé‡ï¼Œä¸å»ºè®®åœ¨é‡Œé¢åƒé¥­ã€‚","l":"","trans":"ğŸš¶ æ­¥è¡Œ","imgs":[],"lt":"","type":"spot"},{"t":"19:00","tit":"å°é¾™å/èœ€å¤§ä¾ ","desc":"æ™šä¸Šæ•´é¡¿æ­£å®—ç«é”…ã€‚\næç¤ºï¼šä¸èƒ½åƒè¾£ç‚¹å¾®è¾£+å”¯æ€¡è±†å¥¶ã€‚","l":"å°é¾™åè€ç«é”…(æ˜¥ç†™è·¯åº—)","trans":"ğŸš— æ‰“è½¦","imgs":[],"lt":"","type":"food"}]}]},
            {"id":"p1763828750759","name":"H: ç¥ˆç¦ & å¤ªå¤é‡Œ","days":[{"title":"ç¥ˆç¦ & å¤ªå¤é‡Œ","items":[{"t":"10:00","tit":"æ–‡æ®Šé™¢","desc":"çº¢å¢™æ‹ç…§å·¨å‡ºç‰‡ï¼\nç‰¹è‰²ï¼šæ‘¸â€œç¦â€å­—ï¼Œåƒæ´å­å£å¼ è€äºŒå‡‰ç²‰ï¼ˆç”œæ°´é¢ä¸€ç»ï¼‰ã€‚\nä¸ç”¨é—¨ç¥¨ï¼Œé—¨å£å¯ä»¥é¢†é¦™ã€‚","l":"æ–‡æ®Šé™¢","trans":"ğŸš‡ åœ°é“1å·çº¿","imgs":[],"lt":"","type":"spot"},{"t":"14:00","tit":"IFS & å¤ªå¤é‡Œ","desc":"å¿…æ‰“å¡ï¼šIFSæ¥¼ä¸‹çš„ç†ŠçŒ«å±è‚¡ï¼ˆä¸ç”¨ä¸Šæ¥¼æ’é˜Ÿï¼‰ã€‚\nå¤§æ…ˆå¯ºï¼šå°±åœ¨å¤ªå¤é‡Œé‡Œé¢ï¼Œé—¹ä¸­å–é™ï¼Œå–ä¸ªç›–ç¢—èŒ¶ã€‚","l":"IFSå›½é™…é‡‘èä¸­å¿ƒ","trans":"ğŸš‡ åœ°é“2å·çº¿","imgs":[],"lt":"","type":"spot"},{"t":"19:00","tit":"ä¹çœ¼æ¡¥/å®‰é¡ºå»Šæ¡¥","desc":"çœ‹å¤œæ™¯ç»ç»å­ï¼\nå¯ä»¥åœ¨æ²³è¾¹çš„å°é…’é¦†ååï¼Œå¹å¹æ™šé£ï¼Œé€‚åˆæƒ…ä¾£ã€‚","l":"å®‰é¡ºå»Šæ¡¥","lt":"","imgs":[],"trans":"ğŸš— æ‰“è½¦ 15å…ƒ","type":"spot"}]}]},
            {"id":"p1763829583148","name":"I: æ…¢ç”Ÿæ´» Day1","days":[{"title":"äººæ°‘å…¬å›­ & ç‰æ—","items":[{"t":"10:30","tit":"äººæ°‘å…¬å›­","desc":"æ ¸å¿ƒï¼šä½“éªŒæˆéƒ½æ…¢ç”Ÿæ´»ã€‚\nå¿…åšï¼šé¹¤é¸£èŒ¶ç¤¾å–èŒ¶ï¼ˆ30å…ƒ/æ¯ï¼‰ï¼Œä½“éªŒé‡‡è€³ï¼ˆèˆ’çˆ½ï¼‰ã€‚\né¿é›·ï¼šæ™¯åŒºé—¨å£çš„â€œä¸‰å¤§ç‚®â€ä¸ç”¨ä¹°ã€‚","l":"äººæ°‘å…¬å›­","trans":"ğŸš‡ åœ°é“","imgs":[],"lt":"","type":"spot"},{"t":"13:30","tit":"æˆéƒ½åšç‰©é¦†","desc":"æ–°é¦†éå¸¸éœ‡æ’¼ï¼Œäº†è§£èœ€æ–‡åŒ–ã€‚\nâš ï¸æ³¨æ„ï¼šéœ€è¦æå‰åœ¨å…¬ä¼—å·é¢„çº¦ï¼å‘¨ä¸€é—­é¦†ã€‚","l":"æˆéƒ½åšç‰©é¦†æ–°é¦†","trans":"ğŸš¶ æ­¥è¡Œå¯è¾¾","imgs":[],"lt":"","type":"spot"},{"t":"18:00","tit":"ç‰æ—è·¯å°é…’é¦†","desc":"ã€Šæˆéƒ½ã€‹æ­Œé‡Œçš„ç‰æ—è·¯ã€‚\nå¾ˆå¤šç‰¹è‰²Bistroå’Œå°åƒï¼Œä¸åƒå¤ªå¤é‡Œé‚£ä¹ˆå•†ä¸šï¼Œå¾ˆæœ‰çƒŸç«æ°”ã€‚","l":"å°é…’é¦†(ç‰æ—åº—)","trans":"ğŸš— æ‰“è½¦","imgs":[],"lt":"","type":"food"}]}]},
            {"id":"p1763829708510","name":"J: æ…¢ç”Ÿæ´» Day2","days":[{"title":"ä¸œéƒŠè®°å¿† & å»ºè®¾è·¯","items":[{"t":"11:00","tit":"ä¸œéƒŠè®°å¿†","desc":"åŸæœ¬çš„å·¥å‚æ”¹å»ºçš„ï¼Œç±»ä¼¼åŒ—äº¬798ã€‚\néå¸¸é€‚åˆç»™å¥³æœ‹å‹æ‹ç…§ï¼æœ‰å¾ˆå¤šå¤å¤çš„å¢™ç»˜å’Œè£…ç½®ã€‚","l":"ä¸œéƒŠè®°å¿†","trans":"ğŸš— æ‰“è½¦","imgs":[],"lt":"","type":"spot"},{"t":"15:00","tit":"å»ºè®¾è·¯å°åƒè¡—","desc":"å…¨æˆéƒ½æ’é˜Ÿæœ€ç‹ çš„å°åƒè¡—ã€‚\næ¨èï¼šçƒ¤çŒªè¹„ã€é”…å·´åœŸè±†ã€é¸¡ç¿…åŒ…è‚¥è‚ ã€‚\nå»ºè®®ï¼šä¸¤ä¸ªäººåˆ†å¤´æ’é˜Ÿï¼Œæ•ˆç‡ç¿»å€ã€‚","l":"å»ºè®¾è·¯å°åƒè¡—","trans":"ğŸš¶ æ­¥è¡Œ","imgs":[],"lt":"","type":"food"},{"t":"20:00","tit":"339ç”µè§†å¡”","desc":"æˆéƒ½çš„åœ°æ ‡å¡”ï¼Œæ™šä¸Šäº®ç¯å¾ˆå¥½çœ‹ã€‚é™„è¿‘æœ‰å¾ˆå¤šæ¸…å§ã€‚","l":"339ç”µè§†å¡”","trans":"ğŸš— æ‰“è½¦","imgs":[],"lt":"","type":"spot"}]}]},
            {"id":"p1763829720206","name":"K: å†å²æ–‡åŒ–","days":[{"title":"æ­¦ä¾¯ç¥  & é”¦é‡Œ","items":[{"t":"13:00","tit":"æ­¦ä¾¯ç¥ ","desc":"çº¢å¢™ç«¹å½±ï¼Œéå¸¸æœ‰å†å²æ„Ÿã€‚\né€‚åˆæ…¢æ…¢é€›ï¼Œå¬å¬è®²è§£ã€‚","l":"æ­¦ä¾¯ç¥ ","trans":"ğŸš— æ‰“è½¦","imgs":[],"lt":"","type":"spot"},{"t":"16:00","tit":"é”¦é‡Œå¤è¡—","desc":"å°±åœ¨æ­¦ä¾¯ç¥ éš”å£ã€‚\nå»ºè®®ï¼šå‚æ™šå»ï¼Œçº¢ç¯ç¬¼äº®èµ·æ¥å¾ˆç¾ã€‚å°åƒåè´µï¼Œå°å°å°±è¡Œã€‚","l":"é”¦é‡Œå¤è¡—","trans":"ğŸš¶ æ­¥è¡Œ","imgs":[],"lt":"","type":"spot"},{"t":"19:00","tit":"èŠ³è‰è¡—","desc":"ç¦»é”¦é‡Œä¸è¿œï¼Œå¾ˆå¤šå¾ˆå¤šå¥½åƒçš„è‹è‡é¦†å­ï¼Œæ¯”æ™¯åŒºä¾¿å®œå¥½åƒã€‚","l":"èŠ³è‰è¡—","trans":"ğŸš² å…±äº«å•è½¦","imgs":[],"lt":"","type":"food"}]}]},
            {"id":"p_xhs_j_ren","name":"ğŸ”¥ L: Jäººéœ‡æ’¼æ”»ç•¥ (å…¨4å¤©)","days":[
                {"title":"Day1: æ—¶å°šä¸å¤œæ™¯","items":[
                    {"t":"10:00","tit":"æ˜¥ç†™è·¯","desc":"æˆéƒ½æœ€ç¹åçš„å•†ä¸šè¡—ï¼Œæ‰“å¡åœ°æ ‡ã€‚\næ¨èç¾é£Ÿï¼šè¥¿æœˆåŸè°­è±†èŠ±ï¼ˆå°åƒï¼‰ã€‚","l":"æ˜¥ç†™è·¯","lt":"","imgs":[],"trans":"ğŸš‡ åœ°é“2/3å·çº¿","type":"spot"},
                    {"t":"11:30","tit":"IFSå›½é™…é‡‘èä¸­å¿ƒ","desc":"å¿…æ‰“å¡ï¼šçˆ¬æ¥¼ç†ŠçŒ«ï¼ˆ7æ¥¼ç©ºä¸­èŠ±å›­ï¼‰ã€‚\nå¯ä»¥æ‹åˆ°ç†ŠçŒ«æ­£è„¸ã€‚","l":"æˆéƒ½IFS","lt":"","imgs":[],"trans":"ğŸš¶ æ­¥è¡Œ","type":"spot"},
                    {"t":"13:00","tit":"å¤ªå¤é‡Œ & å¤§æ…ˆå¯º","desc":"æ—¶å°šä¸å¤è€ç»“åˆã€‚å¤§æ…ˆå¯ºå°±åœ¨å¤ªå¤é‡Œé‡Œé¢ï¼Œçº¢å¢™æ‹ç…§å¾ˆå¥½çœ‹ã€‚\nåˆé¤å¯ä»¥åœ¨é™„è¿‘è§£å†³ã€‚","l":"è¿œæ´‹å¤ªå¤é‡Œ","lt":"","imgs":[],"trans":"ğŸš¶ æ­¥è¡Œ","type":"spot"},
                    {"t":"16:00","tit":"æœ›å¹³è¡—","desc":"æ²¿æ²³çš„ç½‘çº¢è¡—åŒºï¼Œå¾ˆå¤šå’–å•¡åº—ã€é›†å¸‚ï¼Œé€‚åˆCitywalkã€‚","l":"æœ›å¹³è¡—","lt":"","imgs":[],"trans":"ğŸš— æ‰“è½¦/æ­¥è¡Œ","type":"spot"},
                    {"t":"19:30","tit":"å®‰é¡ºå»Šæ¡¥","desc":"ä¹çœ¼æ¡¥é™„è¿‘ï¼Œçœ‹å¤œæ™¯ç»ç»å­ï¼\né€‚åˆå¹æ™šé£ï¼Œå»é…’å§è¡—ååã€‚","l":"å®‰é¡ºå»Šæ¡¥","lt":"","imgs":[],"trans":"ğŸš¶ æ²¿æ²³æ­¥è¡Œ","type":"spot"}
                ]},
                {"title":"Day2: ç†ŠçŒ«ä¸å†å²","items":[
                    {"t":"07:30","tit":"å¤§ç†ŠçŒ«åŸºåœ°(å—é—¨)","desc":"âš ï¸é‡ç‚¹ï¼šä¸€å®šè¦èµ°å—é—¨ï¼æ’é˜Ÿäººå°‘ã€‚\nå¿…çœ‹ï¼šèŠ±èŠ±ã€èŒå…°ã€‚\nå»ºè®®æ—©èµ·ï¼Œç†ŠçŒ«ä¸Šåˆæ´»è·ƒã€‚","l":"æˆéƒ½å¤§ç†ŠçŒ«ç¹è‚²ç ”ç©¶åŸºåœ°(å—é—¨)","lt":"","imgs":[],"trans":"ğŸš— æ‰“è½¦å‰å¾€","type":"spot"},
                    {"t":"12:30","tit":"æ–‡æ®Šé™¢","desc":"å…é—¨ç¥¨ã€‚çº¢å¢™æ‹ç…§å‡ºç‰‡ï¼Œå¯ä»¥æ‘¸â€œç¦â€å­—ã€‚\nå¿…åƒï¼šé—¨å£çš„å®«å»·ç³•ç‚¹ã€æ´å­å£å¼ è€äºŒå‡‰ç²‰ã€‚","l":"æ–‡æ®Šé™¢","lt":"","imgs":[],"trans":"ğŸš‡ åœ°é“","type":"spot"},
                    {"t":"15:00","tit":"æœç”«è‰å ‚ & æµ£èŠ±æºª","desc":"æ„Ÿå—è¯—åœ£æƒ…æ€€ï¼Œçº¢å¢™ç«¹æ—å¾ˆç¾ã€‚\næµ£èŠ±æºªå…¬å›­å°±åœ¨æ—è¾¹ï¼Œç¯å¢ƒæ¸…å¹½ã€‚","l":"æœç”«è‰å ‚","lt":"","imgs":[],"trans":"ğŸš— æ‰“è½¦","type":"spot"},
                    {"t":"17:30","tit":"æ­¦ä¾¯ç¥ ","desc":"ä¸‰å›½è¿·å¿…å»ï¼Œè‘—åçš„â€œçº¢å¢™ç«¹å½±â€æœºä½å°±åœ¨è¿™é‡Œã€‚","l":"æ­¦ä¾¯ç¥ ","lt":"","imgs":[],"trans":"ğŸš‡ åœ°é“/æ‰“è½¦","type":"spot"},
                    {"t":"19:30","tit":"é”¦é‡Œå¤è¡—","desc":"å°±åœ¨æ­¦ä¾¯ç¥ éš”å£ã€‚æ™šä¸Šäº®ç¯åå¾ˆæ¼‚äº®ï¼Œé€‚åˆçœ‹å¤œæ™¯ã€‚\nå°åƒåè´µï¼Œå»ºè®®åªé€›ä¸åƒæˆ–å°‘åƒã€‚","l":"é”¦é‡Œå¤è¡—","lt":"","imgs":[],"trans":"ğŸš¶ æ­¥è¡Œ","type":"spot"}
                ]},
                {"title":"Day3: æ…¢æ´»ä¸æ–‡è‰º","items":[
                    {"t":"09:30","tit":"äººæ°‘å…¬å›­","desc":"å¿…åšï¼šé¹¤é¸£èŒ¶ç¤¾å–ç›–ç¢—èŒ¶ï¼Œä½“éªŒé‡‡è€³ã€‚\næ„Ÿå—æˆéƒ½çœŸæ­£çš„æ…¢ç”Ÿæ´»ã€‚","l":"äººæ°‘å…¬å›­","lt":"","imgs":[],"trans":"ğŸš‡ åœ°é“","type":"spot"},
                    {"t":"11:30","tit":"å®½çª„å··å­","desc":"æ ‡å¿—æ€§æ™¯ç‚¹ï¼Œçœ‹çœ‹è€å»ºç­‘ã€‚\näººå¤šå•†ä¸šåŒ–é‡ï¼Œé€›é€›å°±è¡Œã€‚","l":"å®½çª„å··å­","lt":"","imgs":[],"trans":"ğŸš¶ æ­¥è¡Œ","type":"spot"},
                    {"t":"14:00","tit":"æˆéƒ½åšç‰©é¦†","desc":"âš ï¸éœ€æå‰åœ¨å…¬ä¼—å·é¢„çº¦ï¼\néå¸¸å€¼å¾—ä¸€çœ‹ï¼Œäº†è§£æˆéƒ½å†å²æ–‡åŒ–ã€‚","l":"æˆéƒ½åšç‰©é¦†æ–°é¦†","lt":"","imgs":[],"trans":"ğŸš¶ æ­¥è¡Œ","type":"spot"},
                    {"t":"16:30","tit":"ä¸œéƒŠè®°å¿†","desc":"æ—§å·¥å‚æ”¹å»ºçš„åˆ›æ„å›­åŒºï¼Œå·¥ä¸šé£æ»¡æ»¡ã€‚\néå¸¸é€‚åˆæ‹ç…§ï¼Œæœ‰å¾ˆå¤šå¤å¤è£…ç½®ã€‚","l":"ä¸œéƒŠè®°å¿†","lt":"","imgs":[],"trans":"ğŸš— æ‰“è½¦","type":"spot"},
                    {"t":"18:30","tit":"å»ºè®¾è·¯å°åƒè¡—","desc":"åƒè´§å¤©å ‚ï¼\næ¨èï¼šçƒ¤çŒªè¹„ã€é”…å·´åœŸè±†ã€é¸¡ç¿…åŒ…è‚¥è‚ ã€‚\nå»ºè®®ï¼šä¸¤ä¸ªäººåˆ†å¤´æ’é˜Ÿï¼Œæ•ˆç‡ç¿»å€ã€‚","l":"å»ºè®¾è·¯å°åƒè¡—","lt":"","imgs":[],"trans":"ğŸš— æ‰“è½¦","type":"food"},
                    {"t":"20:30","tit":"ç‰æ—è·¯","desc":"ã€Šæˆéƒ½ã€‹æ­Œé‡Œçš„åœ°æ–¹ã€‚\nå¾ˆå¤šå°é…’é¦†å’ŒBistroï¼Œæ„Ÿå—æˆéƒ½çš„çƒŸç«æ°”ã€‚","l":"ç‰æ—è¥¿è·¯","lt":"","imgs":[],"trans":"ğŸš— æ‰“è½¦","type":"food"}
                ]},
                {"title":"Day4: éƒ½æ±Ÿå °ä¸€æ—¥","items":[
                    {"t":"09:00","tit":"ä»°å¤©çªå¹¿åœº","desc":"æ‰“å¡è¿ªä¸½çƒ­å·´åŒæ¬¾â€œè‡ªæ‹å¤§ç†ŠçŒ«â€ã€‚\nå»ºè®®é«˜é“ååˆ°ã€ç¦»å †å…¬å›­ç«™ã€‘ã€‚","l":"ä»°å¤©çªå¹¿åœº","lt":"","imgs":[],"trans":"ğŸš„ é«˜é“","type":"transport"},
                    {"t":"10:30","tit":"ç†ŠçŒ«è°·","desc":"å¯ä»¥çœ‹åˆ°æ•£å…»çš„å°ç†ŠçŒ«ï¼Œäººæ¯”åŸºåœ°å°‘å¾ˆå¤šï¼Œä½“éªŒæ›´å¥½ã€‚","l":"ç†ŠçŒ«è°·","lt":"","imgs":[],"trans":"ğŸš— æ‰“è½¦","type":"spot"},
                    {"t":"13:00","tit":"çŒå¿å¤åŸ","desc":"åƒåˆé¥­ï¼Œé€›å¤åŸã€‚æ¨èï¼šåŒ—è¡—ç±³çº¿ã€å¶å©†å©†è±†æµ†é¦é¦ã€‚","l":"çŒå¿å¤åŸ","lt":"","imgs":[],"trans":"ğŸš— æ‰“è½¦","type":"food"},
                    {"t":"15:00","tit":"éƒ½æ±Ÿå °æ™¯åŒº","desc":"â€œæ‹œæ°´éƒ½æ±Ÿå °â€ï¼Œéœ‡æ’¼çš„æ°´åˆ©å·¥ç¨‹ã€‚\nå»ºè®®è·¯çº¿ï¼šç¦»å †å…¬å›­å…¥å£è¿› -> ä¼é¾™è§‚ -> å®ç“¶å£ -> é£æ²™å ° -> é±¼å˜´ -> å®‰æ¾œç´¢æ¡¥ã€‚","l":"éƒ½æ±Ÿå °æ™¯åŒº","lt":"","imgs":[],"trans":"ğŸš¶ æ­¥è¡Œ","type":"spot"},
                    {"t":"18:00","tit":"æ–‡åº™è¡—","desc":"æœ‰å¾ˆå¤šæ—§ç‰©ä»¶å’Œå¤å¤åº—é“ºï¼Œæ‹ç…§å¾ˆæœ‰æ„Ÿè§‰ã€‚","l":"æ–‡åº™è¡—","lt":"","imgs":[],"trans":"ğŸš¶ æ­¥è¡Œ","type":"spot"},
                    {"t":"20:00","tit":"å—æ¡¥","desc":"å¿…çœ‹ï¼æ™šä¸Šå¼€ç¯åçš„â€œè“çœ¼æ³ªâ€å¤œæ™¯ï¼Œéå¸¸éœ‡æ’¼ã€‚","l":"å—æ¡¥","lt":"","imgs":[],"trans":"ğŸš¶ æ­¥è¡Œ","type":"spot"}
                ]}
            ]},
            {"id":"p_citywalk_autumn","name":"M: ğŸ‚ é“¶æçº¢å¶Citywalkæ•£æ­¥æŒ‡å—","days":[
                {"title":"é‡‘è‰²è€è¡—å··å¼„ä¸€æ—¥æ¼«æ­¥","items":[
                    {"t":"10:00","tit":"æœ›æ±Ÿæ¥¼å…¬å›­","desc":"ä»¥æ¸…å¹½å¤é›…çš„æ°›å›´å¼€å¯ä¸€å¤©çš„æ¼«æ­¥ã€‚è¿™é‡Œæœ‰æ ‡å¿—æ€§çš„çº¢å¢™ç«¹å½±ï¼Œåœ¨ç§‹å¤©ä¸é‡‘é»„çš„é“¶æäº¤ç»‡ï¼Œå¤é£æ°›å›´æ„Ÿåè¶³ã€‚","l":"æœ›æ±Ÿæ¥¼å…¬å›­","trans":"ğŸš— æ‰“è½¦æˆ–å…¬äº¤ç›´è¾¾","imgs":[],"lt":"","type":"spot"},
                    {"t":"12:30","tit":"åˆé¤ï¼šé“¶æè·¯å‘¨è¾¹","desc":"åœ¨å‰å¾€é“¶æè·¯çš„é€”ä¸­æˆ–é™„è¿‘æ‰¾ä¸€å®¶å®‰é™çš„é¤å…æˆ–å’–å•¡é¦†ï¼Œäº«å—ä¼‘é—²çš„åˆé¤æ—¶å…‰ã€‚","l":"é“¶æè·¯ï¼ˆå‘¨è¾¹é¤å…ï¼‰","trans":"ğŸš¶æ­¥è¡Œ","imgs":[],"lt":"","type":"food"},
                    {"t":"14:00","tit":"é“¶æè·¯æ¼«æ­¥","desc":"æ•´æ¡è¡—è¢«é‡‘é»„çš„é“¶æå¶è¦†ç›–ï¼Œç¾åˆ°å‘å…‰ã€‚å»ºè®®æ”¾æ…¢è„šæ­¥ï¼Œæ„Ÿå—è½å¶ä¸æ‰«çš„æµªæ¼«ï¼Œè¸©ä¸Šå»æ²™æ²™ä½œå“ã€‚","l":"é“¶æè·¯","trans":"ğŸš¶ æ­¥è¡Œ","imgs":[],"lt":"","type":"spot"},
                    {"t":"15:30","tit":"ç™¾èŠ±å··æ¢ç§˜","desc":"å°ä¼—ä¸”å……æ»¡ç”Ÿæ´»æ°”æ¯çš„å··å­ï¼Œå±‹æªä¸‹æŒ‚æ»¡è—¤è”“ç§‹å¶ã€‚åœ¨è¿™é‡Œå¯ä»¥å¶é‡æ™’å¤ªé˜³çš„çŒ«çŒ«ï¼Œä½“éªŒè€æˆéƒ½çš„æ…¢ç”Ÿæ´»ã€‚","l":"ç™¾èŠ±å··","trans":"ğŸš¶ æ­¥è¡Œ","imgs":[],"lt":"","type":"spot"},
                    {"t":"16:30","tit":"é”¦ç»£æ¡¥èµæ™¯","desc":"æ¡¥è¾¹çš„æ¢§æ¡å¶ä¸é“¶æå¶å½¢æˆåŒæ‹¼è‰²æ™¯è§‚ï¼Œè§†è§‰æ•ˆæœæä½³ã€‚ç¬”è®°ä¸­æåˆ°ä¸‹åˆ4ç‚¹å…‰å½±ç»ç¾ï¼Œæ˜¯ç»ä½³çš„æ‹ç…§æ—¶é—´ã€‚","l":"é”¦ç»£æ¡¥","trans":"ğŸš¶ æ­¥è¡Œ","imgs":[],"lt":"","type":"spot"},
                    {"t":"18:00","tit":"é’ç¾Šå®«å–èŒ¶","desc":"åœ¨å¤è€çš„é“è§‚ä¸­ä¼‘æ¯ï¼Œç‚¹ä¸€ç¢—ç›–ç¢—èŒ¶ï¼Œæ„Ÿå—å¤é“¶ææ ‘ä¸‹çš„ç¦…æ„ã€‚èŒ¶è´¹é€šå¸¸åªéœ€10å…ƒï¼Œéå¸¸ä¼‘é—²ã€‚","l":"é’ç¾Šå®«","trans":"ğŸš— æ‰“è½¦æˆ–å…¬äº¤","imgs":[],"lt":"","type":"spot"},
                    {"t":"19:30","tit":"æ™šé¤ï¼šæ–‡æ®Šé™¢å‘¨è¾¹ç´ é£Ÿ/å°åƒ","desc":"æ™šé¤å¯åœ¨é’ç¾Šå®«æˆ–æ–‡æ®Šé™¢ï¼ˆä¸‹ä¸€ç«™é™„è¿‘ï¼‰å‘¨è¾¹å¯»æ‰¾ç‰¹è‰²å°åƒæˆ–ç´ é£Ÿé¦†ï¼Œä½“éªŒä¸åŒçš„æˆéƒ½å‘³é“ã€‚","l":"æ–‡æ®Šé™¢å‘¨è¾¹ç¾é£Ÿ","trans":"ğŸš¶ æ­¥è¡Œ","imgs":[],"lt":"","type":"food"},
                    {"t":"20:30","tit":"æ–‡æ®Šé™¢å¤œæ™¯/èµç§‹æ”¶å°¾","desc":"çº¢å¢™é»›ç“¦ä¸åƒå¹´é“¶æç›¸é…ï¼Œæ˜¯ç§‹æ—¥æµªæ¼«çš„å®Œç¾æ”¶å°¾ã€‚å¯åœ¨æ­¤ç»“æŸä¸€å¤©çš„èµç§‹citywalkã€‚","l":"æ–‡æ®Šé™¢","trans":"ğŸš¶ æ­¥è¡Œ/æ‰“è½¦è¿”ç¨‹","imgs":[],"lt":"","type":"spot"}
                ]}
            ]}
        ];

        const DEFAULT_PLANS = RAW_DATA.map(p => ({
            id: p.id,
            name: p.name,
            startDate: new Date().toISOString().split('T')[0],
            days: p.days.map((d, dIdx) => ({
                id: `d_${p.id}_${dIdx}`,
                customTitle: d.title,
                items: d.items.map((i, iIdx) => ({
                    id: `i_${p.id}_${dIdx}_${iIdx}`,
                    time: i.t,
                    title: i.tit,
                    description: i.desc,
                    location: extractLocation(i.l, i.tit),
                    type: i.type || 'spot', 
                    transportDetail: i.trans,
                    images: [],
                    skipMap: false 
                }))
            }))
        }));

        const STORAGE_KEY = 'chengdu_love_trip_data_v29';
        const MAP_HISTORY_KEY = 'chengdu_map_history_v29';
        const GEO_CACHE_KEY = 'chengdu_geo_cache_v29';
        
        const savePlans = (plans) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(plans)); } catch (e) { console.error("Storage error"); } };
        const loadPlans = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || DEFAULT_PLANS; } catch { return DEFAULT_PLANS; } };
        
        const loadMapHistory = () => { try { return JSON.parse(localStorage.getItem(MAP_HISTORY_KEY)) || {}; } catch { return {}; } };
        const saveMapHistory = (history) => { try { localStorage.setItem(MAP_HISTORY_KEY, JSON.stringify(history)); } catch (e) { console.error("Map history storage error"); } };
        
        const loadGeoCache = () => { try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY)) || {}; } catch { return {}; } };
        const saveGeoCache = (cache) => { try { localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache)); } catch (e) { console.error("Geo cache storage error"); } };
        
        const fileToBase64 = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    // åˆ›å»º Canvas è¿›è¡Œå‹ç¼©
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // æœ€å¤§å°ºå¯¸é™åˆ¶ (ä¾‹å¦‚ 1024px)
                    const MAX_WIDTH = 1024;
                    const MAX_HEIGHT = 1024;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // å‹ç¼©ä¸º JPEGï¼Œè´¨é‡ 0.6 (è¶³ä»¥åœ¨æ‰‹æœºè§‚çœ‹ä¸”ä½“ç§¯å¾ˆå°)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    resolve(dataUrl);
                };
                img.onerror = () => {
                    // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°åŸå§‹ base64 (è™½ç„¶å¯èƒ½å¾ˆå¤§)
                    resolve(event.target.result);
                }
            };
        });

        const AMAP_KEY = '85b427e744386038421b5b0bdb657f30';
        
        const loadAMap = () => {
            if (window.AMap && window.AMap.Map) return Promise.resolve();
            if (window.__amap_init_promise) return window.__amap_init_promise;
            const promise = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `https://webapi.amap.com/maps?v=2.0&key=${AMAP_KEY}&plugin=AMap.Scale,AMap.ToolBar,AMap.Geocoder,AMap.Polyline,AMap.Marker,AMap.Weather,AMap.Geolocation,AMap.CitySearch`;
                script.onload = () => resolve();
                script.onerror = () => reject("Failed to load AMap");
                document.head.appendChild(script);
            });
            window.__amap_init_promise = promise;
            return promise;
        };

        const getAmapWeatherIcon = (type) => {
            if(!type) return 'ğŸŒ¤ï¸';
            if(type.includes('æ™´')) return 'â˜€ï¸';
            if(type.includes('é˜´') || type.includes('äº‘')) return 'â˜ï¸';
            if(type.includes('é›¨')) return 'ğŸŒ§ï¸';
            if(type.includes('é›ª')) return 'â„ï¸';
            if(type.includes('é›·')) return 'â›ˆï¸';
            return 'ğŸŒ¤ï¸';
        };

        const StatusToast = ({ message, onClose }) => {
            return (
                <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[10006] p-4 bg-white rounded-xl shadow-2xl border border-gray-100 flex items-center gap-3 animate-fadeInDown ui-control max-w-[90%] pointer-events-auto">
                    <AlertCircle size={20} className="text-ios-blue shrink-0"/>
                    <span className="text-sm font-medium text-gray-800">{message}</span>
                    <button onClick={onClose} className="p-1 text-gray-400 hover:text-gray-600 shrink-0"><X size={14}/></button>
                </div>
            );
        };

        const ExportItem = ({ item }) => (
            <div className={`relative flex gap-4 group mb-4 break-inside-avoid`}>
                <div className="flex flex-col items-center w-14 shrink-0 pt-2">
                    <span className="text-sm font-bold font-mono text-gray-800">{item.time}</span>
                    <div className="w-0.5 h-full bg-gray-200 mt-2 rounded-full" />
                </div>
                <div className="flex-1 bg-white rounded-2xl p-4 border border-gray-100 shadow-sm">
                    <div className="flex justify-between items-start mb-2">
                        <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${getTypeClasses(item.type)}`}>{item.type}</span>
                    </div>
                    <h3 className="font-bold text-lg mb-1 flex items-center gap-2 text-gray-900">{item.title} {item.skipMap && <span className="text-xs font-normal text-gray-400 bg-gray-100 px-1.5 rounded">æš‚å®š</span>}</h3>
                    <div className="flex items-center gap-1.5 text-xs text-gray-500 mb-3">
                        <MapPin size={12} />
                        <span className={item.skipMap ? "line-through opacity-50" : ""}>{item.location}</span>
                    </div>
                    {item.transportDetail && (
                        <div className="flex items-center gap-1.5 text-xs text-gray-500 mb-3">
                            <MoveVertical size={12} />
                            <span>{item.transportDetail}</span>
                        </div>
                    )}
                    <p className="text-sm text-gray-600 whitespace-pre-wrap leading-relaxed">{item.description}</p>
                    {item.images.length > 0 && (
                        <div className="mt-4 grid grid-cols-3 gap-2">
                            {item.images.map((img, idx) => (
                                <div key={idx} className="relative aspect-square rounded-lg overflow-hidden bg-gray-100">
                                    <img src={img} className="w-full h-full object-cover" />
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );

        const PlanExportView = ({ plan }) => {
            const isSingleDay = !plan.name && plan.customTitle; 
            return (
                <div className="bg-[#F2F2F7] p-8 w-[600px] mx-auto min-h-screen">
                    <div className="text-center mb-10">
                        {isSingleDay ? (
                            <>
                                <h1 className="text-3xl font-bold text-gray-900 mb-2">{plan.customTitle}</h1>
                                <p className="text-gray-500">å•æ—¥è¡Œç¨‹æ¸…å•</p>
                            </>
                        ) : (
                            <>
                                <h1 className="text-3xl font-bold text-gray-900 mb-2">{plan.name}</h1>
                                <p className="text-gray-500">è¡Œç¨‹è§„åˆ’æ¸…å•</p>
                            </>
                        )}
                    </div>
                    <div className="space-y-10">
                        {(isSingleDay ? [{ customTitle: plan.customTitle, items: plan.items }] : plan.days).map((day, index) => (
                            <div key={day.id || index} className="relative">
                                <div className="flex items-center gap-4 mb-6">
                                    <div className="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold text-lg shadow-md z-10">
                                        Day {isSingleDay ? 1 : index + 1}
                                    </div>
                                    <div className="font-bold text-xl text-gray-800">{day.customTitle}</div>
                                    <div className="h-px bg-gray-300 flex-1 ml-4"></div>
                                </div>
                                <div className="pl-2">
                                    {day.items.map((item, idx) => (
                                        <ExportItem key={item.id} item={item} />
                                    ))}
                                    {day.items.length === 0 && <div className="text-center text-gray-400 py-4">æœ¬æ—¥æš‚æ— å®‰æ’</div>}
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="mt-12 text-center text-gray-400 text-sm border-t border-gray-200 pt-6">
                        Generated by XingChengAnPai(To beibei)
                    </div>
                </div>
            );
        };

        const TimePicker = ({ value, onChange, onClose }) => {
            const [hour, setHour] = useState(parseInt(value.split(':')[0]) || 9);
            const [minute, setMinute] = useState(parseInt(value.split(':')[1]) || 0);
            const hours = Array.from({ length: 24 }, (_, i) => i);
            const minutes = Array.from({ length: 60 }, (_, i) => i);

            const handleConfirm = () => {
                const h = hour.toString().padStart(2, '0');
                const m = minute.toString().padStart(2, '0');
                onChange(`${h}:${m}`);
                onClose();
            };

            const hourRef = useRef(null);
            const minuteRef = useRef(null);

            useEffect(() => {
                if (hourRef.current) hourRef.current.scrollTop = hour * 40;
                if (minuteRef.current) minuteRef.current.scrollTop = minute * 40;
            }, []);

            return (
                <div className="fixed inset-0 z-[10001] flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm ui-control" onClick={onClose}>
                    <div className="bg-white w-full max-w-xs rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-[slideUp_0.2s_ease-out]" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg">é€‰æ‹©æ—¶é—´</h3>
                            <button onClick={handleConfirm} className="text-ios-blue font-bold px-4 py-1 rounded-full bg-blue-50">ç¡®å®š</button>
                        </div>
                        <div className="flex h-48 relative">
                            <div className="absolute inset-x-0 top-1/2 -translate-y-1/2 h-10 border-t border-b border-gray-200 pointer-events-none bg-gray-50/30"></div>
                            <div ref={hourRef} className="flex-1 overflow-y-auto no-scrollbar time-scroll-col text-center scroll-smooth" 
                                 onScroll={(e) => {
                                     const h = Math.round(e.target.scrollTop / 40);
                                     if(h >=0 && h<=23) setHour(h);
                                 }}>
                                <div className="h-[80px]"></div> 
                                {hours.map(h => (
                                    <div key={h} className={`h-10 flex items-center justify-center text-lg transition-all ${h === hour ? 'text-black font-bold scale-110' : 'text-gray-300'}`}>
                                        {h.toString().padStart(2, '0')}
                                    </div>
                                ))}
                                <div className="h-[80px]"></div>
                            </div>

                            <div className="w-4 flex items-center justify-center font-bold pb-1 text-gray-400">:</div>

                            <div ref={minuteRef} className="flex-1 overflow-y-auto no-scrollbar time-scroll-col text-center scroll-smooth" 
                                 onScroll={(e) => {
                                     const m = Math.round(e.target.scrollTop / 40);
                                     if(m >=0 && m<=59) setMinute(m);
                                 }}>
                                <div className="h-[80px]"></div>
                                {minutes.map(m => (
                                    <div key={m} className={`h-10 flex items-center justify-center text-lg transition-all ${m === minute ? 'text-black font-bold scale-110' : 'text-gray-300'}`}>
                                        {m.toString().padStart(2, '0')}
                                    </div>
                                ))}
                                <div className="h-[80px]"></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const HelpModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/40 z-[10005] flex items-center justify-center p-8" onClick={onClose}>
                <div className="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl relative animate-[fadeIn_0.2s_ease-out]" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-xl flex items-center gap-2 text-ios-blue"><Info size={20}/> æ–°æ‰‹æŒ‡å—</h3>
                        <button onClick={onClose} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                    </div>
                    <div className="space-y-4 text-sm text-gray-700 max-h-[70vh] overflow-y-auto custom-scrollbar">
                        <div className="p-3 bg-blue-50 rounded-xl border border-blue-100">
                            <span className="font-bold text-base block mb-1 text-blue-800">1. æ–¹æ¡ˆä¸æ—¥æœŸåˆ‡æ¢</span>
                            <ul className="list-disc list-inside space-y-1 ml-2">
                                <li>ç‚¹å‡»é¡¶éƒ¨**æ–¹æ¡ˆåç§°**å¯ä»¥åˆ‡æ¢æˆ–æ–°å¢æ–¹æ¡ˆã€‚</li>
                                <li>ç‚¹å‡»**æ—¥æœŸ**å¯ä»¥è®¾ç½®å‡ºå‘æ—¥æœŸï¼Œå¹¶ä½¿ç”¨å·¦å³ç®­å¤´åˆ‡æ¢å¤©æ•°ã€‚</li>
                            </ul>
                        </div>
                        
                        <div className="p-3 bg-green-50 rounded-xl border border-green-100">
                            <span className="font-bold text-base block mb-1 text-green-800">2. ç¼–è¾‘ä¸æ‹–åŠ¨æ’åº (é‡ç‚¹!)</span>
                            <ul className="list-disc list-inside space-y-1 ml-2">
                                <li>ç‚¹å‡»åº•éƒ¨çš„**â€œç¼–è¾‘â€æŒ‰é’®**è¿›å…¥ç¼–è¾‘æ¨¡å¼ã€‚</li>
                                <li>åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹æ‰€æœ‰æ´»åŠ¨çš„**æ—¶é—´ã€æ ‡é¢˜ã€æè¿°**ç­‰ã€‚</li>
                                <li>**æ‹–åŠ¨æ’åº**ï¼šåœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œé•¿æŒ‰ï¼ˆæ‰‹æœºï¼‰æˆ–ç‚¹å‡»æ‹–åŠ¨ï¼ˆç”µè„‘ï¼‰ä»»æ„æ´»åŠ¨å¡ç‰‡ï¼Œæ‹–åˆ°æ–°çš„ä½ç½®åæ¾å¼€ï¼Œå³å¯è°ƒæ•´é¡ºåºã€‚</li>
                                <li>ç¼–è¾‘å®Œæˆåï¼Œç‚¹å‡»åº•éƒ¨çš„**â€œå®Œæˆâ€æŒ‰é’®**é€€å‡ºã€‚</li>
                            </ul>
                        </div>

                        <div className="p-3 bg-orange-50 rounded-xl border border-orange-100">
                            <span className="font-bold text-base block mb-1 text-orange-800">3. åœ°å›¾ä¸å¯¼èˆª</span>
                            <ul className="list-disc list-inside space-y-1 ml-2">
                                <li>ç‚¹å‡»å³ä¸Šè§’çš„**â€œåœ°å›¾â€å›¾æ ‡**ï¼ˆæ‰‹æœºç«¯ï¼‰æˆ–æŸ¥çœ‹**å³ä¾§é¢æ¿**ï¼ˆç”µè„‘ç«¯ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ä»Šæ—¥è·¯çº¿å›¾ã€‚</li>
                                <li>åº•éƒ¨çš„è·¯çº¿åˆ—è¡¨ä¼šæ˜¾ç¤ºåœ°ç‚¹æ˜¯å¦è¢«åœ°å›¾è¯†åˆ«ï¼Œ**åœ°ç‚¹æœªæ‰¾åˆ°**çš„å¡ç‰‡éœ€è¦ç‚¹å‡»ç¼–è¾‘ä¿®æ”¹ã€‚</li>
                                <li>ç‚¹å‡»**â€œå¯¼èˆªåˆ°ä¸‹ä¸€ç«™â€**æŒ‰é’®å¯ä»¥ç›´æ¥è·³è½¬åˆ°é«˜å¾·åœ°å›¾Appè¿›è¡Œè·¯çº¿è§„åˆ’ã€‚</li>
                            </ul>
                        </div>

                        <div className="p-3 bg-gray-100 rounded-xl border border-gray-200">
                            <span className="font-bold text-base block mb-1 text-gray-800">4. å¤‡ä»½ä¸åˆ†äº«</span>
                            <ul className="list-disc list-inside space-y-1 ml-2">
                                <li>ç‚¹å‡»å³ä¸Šè§’çš„**â€œè®¾ç½®â€å›¾æ ‡**å¯ä»¥è¿›è¡Œå¤‡ä»½ã€å¯¼å…¥ã€åˆ†äº«é•¿å›¾ç­‰æ“ä½œã€‚</li>
                                <li>å»ºè®®å®šæœŸ**â€œå¤‡ä»½æ‰€æœ‰æ•°æ®â€**ä»¥é˜²ä¸¢å¤±ã€‚</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        );

        // 1. WeatherWidget (ç¡¬æ ¸ç‰ˆï¼šåŸç”ŸGPSå¼ºåŠ›å®šä½ï¼Œæœç»IPæ¼‚ç§»)
        const WeatherWidget = ({ date, onWeatherUpdate, showStatus }) => {
            const [weatherData, setWeatherData] = useState(null);
            const [location, setLocation] = useState({ id: 1, name: 'å®šä½ä¸­...', adcode: '' });
            const [isSearching, setIsSearching] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            
            // é€šç”¨ Promise åŒ…è£…å™¨
            const amapPromise = (apiCallFn, timeoutMs = 5000) => {
                return new Promise((resolve, reject) => {
                    const timer = setTimeout(() => {
                        reject(new Error("API_TIMEOUT"));
                    }, timeoutMs);

                    try {
                        apiCallFn((status, result) => {
                            clearTimeout(timer);
                            resolve({ status, result });
                        });
                    } catch (e) {
                        clearTimeout(timer);
                        reject(e);
                    }
                });
            };

            const fetchWeather = async (adcodeOrName) => {
                if (!window.AMap) return;
                setIsLoading(true);

                try {
                    await new Promise(resolve => window.AMap.plugin('AMap.Weather', resolve));
                    var weather = new window.AMap.Weather();

                    const results = await Promise.allSettled([
                        amapPromise((cb) => weather.getLive(adcodeOrName, cb), 6000),
                        amapPromise((cb) => weather.getForecast(adcodeOrName, cb), 6000)
                    ]);

                    const liveRes = results[0].status === 'fulfilled' ? results[0].value : null;
                    const forecastRes = results[1].status === 'fulfilled' ? results[1].value : null;

                    let newData = {};
                    if (liveRes && liveRes.status === null && liveRes.result && liveRes.result.info === 'OK') {
                         newData.live = liveRes.result;
                    }
                    if (forecastRes && forecastRes.status === null && forecastRes.result && forecastRes.result.forecasts) {
                         newData.forecasts = forecastRes.result.forecasts;
                    }
                    
                    if (newData.live || newData.forecasts) {
                        setWeatherData(prev => ({...prev, ...newData}));
                        // åªæœ‰å½“ location è¿˜æ˜¯åˆå§‹å€¼æˆ–ä¸å‡†ç¡®æ—¶ï¼Œæ‰ç”¨å¤©æ°”çš„åŸå¸‚åè¦†ç›–
                        // å¦‚æœæˆ‘ä»¬å·²ç»é€šè¿‡ GPS æ‹¿åˆ°äº†ç²¾ç¡®åŒºå¿ï¼Œå°±ä¸è¦†ç›–äº†
                        if (location.name === 'å®šä½ä¸­...' && newData.live && newData.live.city) {
                            setLocation(prev => ({ ...prev, name: newData.live.city }));
                        }
                        if (newData.forecasts && onWeatherUpdate) {
                            onWeatherUpdate({ location: location.name, weather: newData.forecasts[0] });
                        }
                    }
                } catch (e) {
                    console.warn("å¤©æ°”è·å–å¼‚å¸¸", e);
                } finally {
                    setIsLoading(false);
                }
            };

            // è‡ªåŠ¨ IP å®šä½ (ä»…ç”¨äºé¡µé¢åˆšæ‰“å¼€æ—¶çš„å…œåº•)
            const autoLocate = async () => {
                setIsLoading(true);
                try {
                    await loadAMap();
                    await new Promise(resolve => window.AMap.plugin('AMap.CitySearch', resolve));
                    
                    const citySearch = new window.AMap.CitySearch();
                    const { status, result } = await amapPromise((cb) => citySearch.getLocalCity(cb), 3000);

                    if (status === 'complete' && result.info === 'OK') {
                        // åªæœ‰å½“ç”¨æˆ·è¿˜æ²¡æ‰‹åŠ¨å®šä½è¿‡ï¼Œæ‰æ›´æ–°
                        if(location.name === 'å®šä½ä¸­...' || location.name === 'æˆéƒ½') {
                            console.log("è‡ªåŠ¨å®šä½(IP):", result.city);
                            setLocation({ name: result.city, id: Date.now(), adcode: result.adcode });
                            fetchWeather(result.adcode);
                        }
                    }
                } catch (e) {
                    setLocation({ name: 'æˆéƒ½', id: 1, adcode: '510100' });
                    fetchWeather('510100');
                }
            };

            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åŸç”Ÿ GPS å®šä½ + é«˜å¾·é€†åœ°ç†ç¼–ç 
            const handleManualLocate = async () => {
                setIsLoading(true);
                if(showStatus) showStatus("ğŸš€ æ­£åœ¨è°ƒç”¨åŸç”Ÿ GPSï¼Œè¯·ä¿æŒå±å¹•å¸¸äº®...");

                if (!navigator.geolocation) {
                    if(showStatus) showStatus("âŒ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ GPS å®šä½");
                    setIsLoading(false);
                    return;
                }

                // 1. è°ƒç”¨åŸç”Ÿæµè§ˆå™¨ GPS
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            const { latitude, longitude } = position.coords;
                            if(showStatus) showStatus("âœ… GPSè·å–æˆåŠŸï¼Œæ­£åœ¨è§£æåœ°å€...");

                            await loadAMap();
                            // 2. åæ ‡è½¬æ¢ (WGS84 -> GCJ02)
                            // å› ä¸ºåŸç”ŸGPSæ˜¯ WGS84ï¼Œé«˜å¾·åœ°å›¾æ˜¯ GCJ02ï¼Œä¸è½¬æ¢ä¼šåç§»å‡ ç™¾ç±³
                            const gpsLngLat = [longitude, latitude];
                            
                            window.AMap.convertFrom(gpsLngLat, 'gps', async function (status, result) {
                                if (status === 'complete' && result.locations) {
                                    const finalLngLat = result.locations[0];

                                    // 3. é€†åœ°ç†ç¼–ç  (åæ ‡ -> åœ°å€)
                                    await new Promise(resolve => window.AMap.plugin('AMap.Geocoder', resolve));
                                    const geocoder = new window.AMap.Geocoder();
                                    
                                    geocoder.getAddress(finalLngLat, function(status, result) {
                                        if (status === 'complete' && result.regeocode) {
                                            const comp = result.regeocode.addressComponent;
                                            let displayName = comp.district || comp.township || comp.street;
                                            // å…œåº•ï¼šå¦‚æœåŒºå¿éƒ½æ²¡æœ‰ï¼Œå°±ç”¨åŸå¸‚
                                            if (!displayName) displayName = comp.city;
                                            
                                            if(showStatus) showStatus(`ğŸ“ ç²¾å‡†é”å®š: ${displayName} (${comp.city})`);
                                            
                                            // å¼ºåˆ¶æ›´æ–°ä½ç½®ï¼Œç»ä¸ä½¿ç”¨ IP ç»“æœ
                                            setLocation({ name: displayName, id: Date.now(), adcode: comp.adcode });
                                            fetchWeather(comp.adcode);
                                        } else {
                                            throw new Error("åœ°å€è§£æå¤±è´¥");
                                        }
                                        setIsLoading(false);
                                    });
                                } else {
                                    throw new Error("åæ ‡è½¬æ¢å¤±è´¥");
                                }
                            });
                        } catch (e) {
                            console.error(e);
                            if(showStatus) showStatus("âš ï¸ åœ°å€è§£æå‡ºé”™ï¼Œè¯·é‡è¯•");
                            setIsLoading(false);
                        }
                    },
                    (error) => {
                        // GPS å¤±è´¥å¤„ç†
                        console.error("åŸç”ŸGPSé”™è¯¯:", error);
                        let errMsg = "å®šä½å¤±è´¥";
                        switch(error.code) {
                            case error.PERMISSION_DENIED: errMsg = "âŒ æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨è®¾ç½®ä¸­å…è®¸ä½ç½®æƒé™"; break;
                            case error.POSITION_UNAVAILABLE: errMsg = "âŒ æ— æ³•è·å–ä½ç½® (GPSä¿¡å·å¼±)"; break;
                            case error.TIMEOUT: errMsg = "âŒ å®šä½è¶…æ—¶ï¼Œè¯·èµ°åˆ°å¼€é˜”åœ°å¸¦"; break;
                            default: errMsg = "âŒ æœªçŸ¥é”™è¯¯";
                        }
                        if(showStatus) showStatus(errMsg);
                        setIsLoading(false);
                        // è¿™é‡Œæˆ‘ä»¬ä¸å†è‡ªåŠ¨å›é€€åˆ° IP å®šä½ï¼Œå› ä¸ºç”¨æˆ·æ˜ç¡®æƒ³è¦ç²¾å‡†çš„ï¼Œå›é€€äº†åˆæ˜¯å—å……ï¼Œä¸å¦‚ç›´æ¥æŠ¥é”™è®©ä»–çŸ¥é“
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000, // ç»™è¶³ 15ç§’
                        maximumAge: 0
                    }
                );
            };

            useEffect(() => {
                autoLocate();
            }, []);

            const handleSearch = (e) => {
                e.preventDefault();
                if(!searchQuery.trim()) return;
                setIsLoading(true);
                setLocation(prev => ({ ...prev, name: searchQuery }));
                fetchWeather(searchQuery);
                setIsSearching(false);
            };
            
            const getDisplayTemp = () => {
                if (weatherData && weatherData.live && weatherData.live.temperature) return weatherData.live.temperature;
                if (weatherData && weatherData.forecasts && weatherData.forecasts[0]) return weatherData.forecasts[0].dayTemp;
                return '--';
            };
            
            const getDisplayWeather = () => {
                if (weatherData && weatherData.live && weatherData.live.weather) return weatherData.live.weather;
                if (weatherData && weatherData.forecasts && weatherData.forecasts[0]) return weatherData.forecasts[0].dayWeather;
                return '...';
            };

            return (
                <div className="glass-card p-5 rounded-3xl mb-6 text-ios-text relative overflow-hidden group transition-all">
                    <div className="flex justify-between items-start mb-4">
                        <div onClick={() => setIsSearching(!isSearching)} className="cursor-pointer">
                            <div className="flex items-center gap-1.5">
                                <MapPin size={14} className="text-ios-blue"/>
                                <span className="font-bold truncate max-w-[180px]">{location.name}</span>
                                {isLoading && <Loader2 size={12} className="animate-spin text-gray-400"/>}
                            </div>
                            <div className="text-xs text-ios-subtext mt-0.5">{new Date(date).toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' })}</div>
                        </div>
                        
                        {!isSearching && (
                            <div className="flex items-center gap-3 ui-control">
                                <div className="flex gap-2">
                                    <button onClick={handleManualLocate} className="p-2 bg-gray-100 rounded-full hover:bg-blue-50 text-gray-500 hover:text-blue-600 transition-colors" title="ç²¾å‡†å®šä½"><Navigation size={14}/></button>
                                    <button onClick={() => fetchWeather(location.name)} className="p-2 bg-gray-100 rounded-full hover:bg-blue-50 text-gray-500 hover:text-blue-600 transition-colors" title="åˆ·æ–°å¤©æ°”"><RotateCw size={14}/></button>
                                </div>
                                {(weatherData) && (
                                    <div className="text-right">
                                        <div className="text-3xl font-bold flex items-end justify-end gap-1">
                                            {getDisplayTemp()}Â° 
                                            {weatherData.forecasts && weatherData.forecasts[0] && (
                                                <span className="text-xs text-gray-400 mb-1 font-normal">
                                                    ({weatherData.forecasts[0].dayTemp}Â°/{weatherData.forecasts[0].nightTemp}Â°)
                                                </span>
                                            )}
                                        </div>
                                        <div className="text-sm opacity-80">{getDisplayWeather()}</div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    {!isSearching && weatherData && weatherData.forecasts && (
                        <div className="mt-4 pt-4 border-t border-gray-100/50">
                            <div className="flex gap-6 overflow-x-auto no-scrollbar pb-2">
                                {weatherData.forecasts.map((day, i) => {
                                    const dateObj = new Date(day.date);
                                    const dayName = i === 0 ? 'ä»Šå¤©' : i === 1 ? 'æ˜å¤©' : dateObj.toLocaleDateString('zh-CN', {weekday: 'short'});
                                    return (
                                        <div key={i} className={`flex flex-col items-center shrink-0 space-y-1 ${i === 0 ? 'opacity-100 scale-110 font-bold' : 'opacity-60'}`}>
                                            <span className="text-[10px] uppercase">{dayName}</span>
                                            <span className="text-2xl drop-shadow-sm">{getAmapWeatherIcon(day.dayWeather)}</span>
                                            <span className="text-xs whitespace-nowrap">{day.dayTemp}Â°/{day.nightTemp}Â°</span>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                    {isSearching && (
                        <div className="absolute inset-0 bg-white/95 z-20 p-4 flex flex-col">
                            <form onSubmit={handleSearch} className="flex gap-2 mb-4">
                                <input className="flex-1 bg-gray-100 rounded-xl px-4 py-2 text-sm" placeholder="è¾“å…¥åŸå¸‚..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} autoFocus/>
                                <button type="button" onClick={() => setIsSearching(false)} className="p-2"><X size={16}/></button>
                            </form>
                            <div className="text-xs text-gray-400 text-center mt-4">æŒ‰å›è½¦æœç´¢</div>
                        </div>
                    )}
                </div>
            );
        };

        const ScheduleView = ({ day, isEditing, onUpdateDay, onImageUpload, setIsEditing }) => {
            const fileInputRefs = useRef({});
            const [timePickerTarget, setTimePickerTarget] = useState(null);
            const [draggedItemIndex, setDraggedItemIndex] = useState(null);

            const dragZoneSizePx = 50; 
            const isMobileScreen = window.innerWidth < 768; 

            const updateItem = (id, field, val) => onUpdateDay({ ...day, items: day.items.map(i => i.id === id ? { ...i, [field]: val } : i) });

            const reorderContent = (srcIndex, destIndex) => {
                if (srcIndex === destIndex || srcIndex === null || destIndex === null) return;
                
                const newItems = [...day.items];
                const contentToMove = newItems[srcIndex]; 
                const contentToReplace = newItems[destIndex]; 

                const tempSrcContent = { 
                    title: contentToMove.title, 
                    description: contentToMove.description, 
                    location: contentToMove.location, 
                    type: contentToMove.type, 
                    transportDetail: contentToMove.transportDetail, 
                    images: contentToMove.images, 
                    skipMap: contentToMove.skipMap 
                };
                
                const tempDestContent = { 
                    title: contentToReplace.title, 
                    description: contentToReplace.description, 
                    location: contentToReplace.location, 
                    type: contentToReplace.type, 
                    transportDetail: contentToReplace.transportDetail, 
                    images: contentToReplace.images, 
                    skipMap: contentToReplace.skipMap 
                };

                newItems[srcIndex] = { ...newItems[srcIndex], ...tempDestContent };
                newItems[destIndex] = { ...newItems[destIndex], ...tempSrcContent };

                onUpdateDay({ ...day, items: newItems });
            };

            const handleDragStart = (e, index) => {
                if (!isEditing) { e.preventDefault(); return; }
                setDraggedItemIndex(index);
                if (e.type !== 'touchstart') {
                    e.dataTransfer.effectAllowed = "move";
                    e.dataTransfer.setData("text/plain", index);
                }
                e.currentTarget.classList.add('dragging');
            };

            const handleDragEnd = (e) => {
                e.currentTarget.classList.remove('dragging');
                setDraggedItemIndex(null);
                e.currentTarget.removeAttribute('data-drag-index');
                Array.from(e.currentTarget.parentNode.children).forEach(child => child.classList.remove('drag-over'));
            };

            const handleTouchMove = (e) => {
                if (!isEditing || draggedItemIndex === null || e.touches.length !== 1) return;
                e.preventDefault(); 
                const touch = e.touches[0];
                const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
                Array.from(document.querySelectorAll('[data-index]')).forEach(child => child.classList.remove('drag-over'));
                if (targetElement) {
                    const activityCard = targetElement.closest('[draggable="true"]');
                    if (activityCard && activityCard.dataset.index !== undefined && parseInt(activityCard.dataset.index) !== draggedItemIndex) {
                        activityCard.classList.add('drag-over');
                    }
                }
            };
            
            const handleTouchEnd = (e) => {
                if (!isEditing || draggedItemIndex === null) return;
                const touch = e.changedTouches[0];
                const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
                if (targetElement) {
                    const activityCard = targetElement.closest('[draggable="true"]');
                    if (activityCard && activityCard.dataset.index !== undefined) {
                        const destIndex = parseInt(activityCard.dataset.index);
                        const srcIndex = draggedItemIndex;
                        if (srcIndex !== destIndex) reorderContent(srcIndex, destIndex);
                    }
                }
                Array.from(document.querySelectorAll('[data-index]')).forEach(child => {
                    child.classList.remove('drag-over');
                    child.classList.remove('dragging');
                });
                setDraggedItemIndex(null);
            };
            
            const handleDragOver = (e, index) => {
                if (!isEditing || draggedItemIndex === null) return;
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
                Array.from(e.currentTarget.parentNode.children).forEach(child => child.classList.remove('drag-over'));
                e.currentTarget.classList.add('drag-over');
            };

            const handleDrop = (e, destIndex) => {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');
                if (!isEditing || draggedItemIndex === null) return;
                const srcIndex = parseInt(e.dataTransfer.getData("text/plain"));
                reorderContent(srcIndex, destIndex);
                setDraggedItemIndex(null);
            };

            const calculateNextTime = () => {
                if (day.items.length === 0) return '09:00'; 
                const sortedItems = [...day.items].sort((a, b) => {
                    if (a.time < b.time) return -1;
                    if (a.time > b.time) return 1;
                    return 0;
                });
                const lastTimeStr = sortedItems[sortedItems.length - 1].time;
                let [lastHour, lastMinute] = lastTimeStr.split(':').map(Number);
                let nextHour = lastHour + 1;
                let nextMinute = lastMinute;
                if (nextHour >= 24) nextHour = 9; 
                return `${String(nextHour).padStart(2, '0')}:${String(nextMinute).padStart(2, '0')}`;
            };
            
            useEffect(() => {
                if (isEditing) {
                    document.addEventListener('touchmove', handleTouchMove, { passive: false });
                    document.addEventListener('touchend', handleTouchEnd, { passive: true });
                } else {
                    document.removeEventListener('touchmove', handleTouchMove);
                    document.removeEventListener('touchend', handleTouchEnd);
                }
                return () => {
                    document.removeEventListener('touchmove', handleTouchMove);
                    document.removeEventListener('touchend', handleTouchEnd);
                };
            }, [isEditing, draggedItemIndex]);

            return (
                <div className="space-y-6 pb-24 relative">
                    {day.items.map((item, index) => (
                        <div 
                            key={item.id} 
                            className={`relative flex gap-4 group cursor-grab ${item.skipMap ? 'opacity-70' : ''}`}
                            draggable={isEditing}
                            data-index={index}
                            onDragStart={(e) => handleDragStart(e, index)}
                            onDragEnd={handleDragEnd}
                            onDragOver={(e) => handleDragOver(e, index)}
                            onDrop={(e) => handleDrop(e, index)}
                            onTouchStart={(e) => {
                                if (!isEditing || e.touches.length !== 1) return;
                                if (isMobileScreen) {
                                    const card = e.currentTarget.querySelector('.drag-handle-container'); 
                                    if(card) {
                                        const rect = card.getBoundingClientRect();
                                        const touch = e.touches[0];
                                        const isInDragZone = (
                                            touch.clientX >= rect.left && touch.clientX <= rect.right &&
                                            touch.clientY >= rect.top && touch.clientY <= rect.bottom
                                        );
                                        if (isInDragZone) { e.preventDefault(); handleDragStart(e, index); } 
                                    }
                                } else { e.preventDefault(); handleDragStart(e, index); }
                            }}
                        >
                            <div className="flex flex-col items-center w-14 shrink-0 pt-2">
                                {isEditing ? (
                                    <div className="w-full text-sm font-bold bg-white border border-blue-300 rounded px-1 py-1 text-center cursor-pointer hover:bg-blue-50 text-ios-blue" onClick={() => setTimePickerTarget({ id: item.id, value: item.time })}>
                                        {item.time}
                                    </div>
                                ) : (
                                    <span className="text-sm font-bold font-mono">{item.time}</span>
                                )}
                                <div className="w-0.5 h-full bg-gray-200 mt-2 rounded-full group-last:hidden" />
                            </div>
                            <div className={`flex-1 glass-card rounded-2xl p-4 transition-all relative ${isEditing ? 'border border-dashed border-ios-blue/50' : 'border-transparent border'}`}>
                                <div className="flex justify-between items-start mb-2">
                                    {isEditing ? (
                                        <select value={item.type} onChange={e => updateItem(item.id, 'type', e.target.value)} className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase border border-gray-300 ${getTypeClasses(item.type)}`}>
                                            {ACTIVITY_TYPES.map(type => ( <option key={type} value={type}>{type.toUpperCase()}</option> ))}
                                        </select>
                                    ) : (
                                        <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${getTypeClasses(item.type)}`}>{item.type}</span>
                                    )}

                                    {isEditing && (
                                        <div className="flex gap-2">
                                            <label className="flex items-center gap-1 cursor-pointer bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">
                                                <input type="checkbox" checked={!!item.skipMap} onChange={(e) => updateItem(item.id, 'skipMap', e.target.checked)} className="rounded text-blue-500 focus:ring-0"/>
                                                <span className="text-[10px] font-bold text-gray-600">æš‚å®š</span>
                                            </label>
                                            <button onClick={() => { if(confirm("åˆ é™¤?")) onUpdateDay({...day, items: day.items.filter(i => i.id !== item.id)}) }} className="text-red-400"><Trash2 size={14}/></button>
                                        </div>
                                    )}
                                </div>
                                {isEditing ? <input value={item.title} onChange={e => updateItem(item.id, 'title', e.target.value)} className="w-full font-bold text-lg bg-white/50 rounded mb-1" placeholder="æ ‡é¢˜" /> : <h3 className="font-bold text-lg mb-1 flex items-center gap-2">{item.title} {item.skipMap && <span className="text-xs font-normal text-gray-400 bg-gray-100 px-1.5 rounded">æš‚å®š</span>}</h3>}
                                <div className="flex items-center gap-1.5 text-xs text-ios-subtext mb-1">
                                    {item.skipMap ? <MapPinOff size={12} className="text-gray-300"/> : <MapPin size={12} className={isEditing ? "text-ios-blue" : ""}/>}
                                    {isEditing ? <input value={item.location} onChange={e => updateItem(item.id, 'location', e.target.value)} className="bg-white/50 rounded w-full" placeholder={item.skipMap ? "æš‚ä¸å®šä½ï¼Œä»…åšè®°å½•" : "åœ°å›¾æœç´¢å…³é”®è¯"} disabled={item.skipMap} /> : <span className={item.skipMap ? "line-through opacity-50" : ""}>{item.location}</span>}
                                </div>
                                
                                {isEditing && (
                                    <div className="flex items-center gap-1.5 text-xs text-ios-subtext mb-3">
                                        <MoveVertical size={12} className="text-gray-500" />
                                        <input value={item.transportDetail} onChange={e => updateItem(item.id, 'transportDetail', e.target.value)} className="bg-white/50 border border-gray-200 rounded w-full p-1 text-xs text-gray-700" placeholder="äº¤é€šå¤‡æ³¨ (e.g., åœ°é“2å·çº¿/æ‰“è½¦/æ­¥è¡Œ)" />
                                    </div>
                                )}
                                
                                {isEditing ? <textarea value={item.description} onChange={e => updateItem(item.id, 'description', e.target.value)} className="w-full text-sm bg-white/50 rounded min-h-[60px]" placeholder={item.skipMap ? "åœ¨æ­¤å¤‡æ³¨æš‚å®šåŸå› ..." : "æ·»åŠ æè¿°..."}/> : <p className="text-sm text-ios-subtext whitespace-pre-wrap leading-relaxed">{item.description}</p>}
                                <div className="mt-4 grid grid-cols-3 gap-2">
                                    {item.images.map((img, idx) => (
                                        <div key={idx} className="relative aspect-square rounded-lg overflow-hidden bg-gray-100"><img src={img} className="w-full h-full object-cover" />{isEditing && <button onClick={() => updateItem(item.id, 'images', item.images.filter((_, i) => i !== idx))} className="absolute top-0.5 right-0.5 bg-black/50 text-white p-0.5 rounded-full"><Trash2 size={10}/></button>}</div>
                                    ))}
                                    {isEditing && <button onClick={() => fileInputRefs.current[item.id]?.click()} className="aspect-square rounded-lg border-2 border-dashed flex flex-col items-center justify-center text-gray-400"><Camera size={20}/><span className="text-[10px]">æ·»åŠ </span></button>}
                                    <input type="file" className="hidden" multiple accept="image/*" ref={el => fileInputRefs.current[item.id] = el} onChange={e => onImageUpload(item.id, e.target.files)} />
                                </div>
                                
                                {isEditing && isMobileScreen && (
                                    <div className="drag-handle-container absolute bottom-0 right-0 p-3 bg-gray-100 rounded-lg opacity-70 cursor-grab hover:opacity-100 transition-opacity">
                                        <MoveVertical size={18} className="text-gray-500" />
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                    {isEditing && <button onClick={() => {
                        onUpdateDay({...day, items: [...day.items, { id: Date.now().toString(), time: calculateNextTime(), title: 'æ–°æ´»åŠ¨', location: 'å¾…å®š', type: 'spot', images: [], skipMap: false }]});
                    }} className="w-full py-3 rounded-2xl border-2 border-dashed text-gray-400 font-bold hover:border-ios-blue hover:text-ios-blue transition-all">+ æ·»åŠ æ´»åŠ¨</button>}
                    
                    {timePickerTarget && (
                        <TimePicker value={timePickerTarget.value} onChange={(newTime) => updateItem(timePickerTarget.id, 'time', newTime)} onClose={() => setTimePickerTarget(null)}/>
                    )}
                </div>
            );
        };

        // ä¼˜åŒ–åçš„ TrafficViewï¼šæ·»åŠ æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®ï¼Œä¼˜åŒ–æ‰‹æœºç«¯æŒ‰é’®æ˜¾ç¤º
        const TrafficView = ({ day, showStatus, mapLoadHistory, updateMapLoadHistory, geoCache, updateGeoCache, isEditing }) => {
            const mapContainerRef = useRef(null);
            const mapInstance = useRef(null);
            const markersRef = useRef({}); 
            const [validCount, setValidCount] = useState(0);
            const [mapError, setMapError] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [resolvedCoords, setResolvedCoords] = useState({}); 
            const [failedLocs, setFailedLocs] = useState(new Set());
            const mapTimeoutRef = useRef(null);
            
            const routeSignature = day.items.map(i => `${i.id}|${i.location}|${i.skipMap}`).join('||');

            const VAGUE_LOCATION_KEYWORDS = ['é…’åº—', 'ä½å®¿', 'åƒé¥­', 'åˆé¤', 'æ™šé¤', 'æ—©é¤', 'ä¼‘æ¯', 'è¿”ç¨‹', 'å¾…å®š', 'æš‚å®š', 'éšä¾¿æ‰¾å®¶'];
            
            const isVagueLocation = (location) => {
                if (!location || location.trim().length < 2) return true;
                const normalized = location.toLowerCase().trim();
                return VAGUE_LOCATION_KEYWORDS.some(keyword => normalized.includes(keyword)) && normalized.length < 5;
            };

            const clearMapLoading = (message) => {
                clearTimeout(mapTimeoutRef.current);
                setIsLoading(false);
                if (message && showStatus) showStatus(message);
            };
            const getCurrentDayKey = () => `${day.id}`;

            useEffect(() => {
                if (isEditing) return;

                // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘å¦‚æœåœ°å›¾å®¹å™¨å½“å‰ä¸å¯è§ï¼ˆä¾‹å¦‚æ‰‹æœºä¸Šéšè—çš„ç”µè„‘ç‰ˆåœ°å›¾ï¼‰ï¼Œç›´æ¥åœæ­¢è¿è¡Œ
                // è¿™æ ·å¯ä»¥é˜²æ­¢æ‰‹æœºç«¯åå°è·‘ç”µè„‘ç‰ˆçš„é€»è¾‘ï¼Œå¯¼è‡´é‡å¤æç¤º
                if (mapContainerRef.current && mapContainerRef.current.offsetParent === null) return;

                const initMap = async () => {
                    const currentDayKey = getCurrentDayKey();
                    const isLoaded = mapLoadHistory[currentDayKey];
                    if (isLoaded && mapInstance.current) { restoreMapFromCache(isLoaded); return; }
                    await initializeAndDrawMap(isLoaded);
                };
                
                const restoreMapFromCache = (isLoaded) => {
                    mapInstance.current.clearMap();
                    const cachedCoords = isLoaded.coords;
                    const cachedResolvedCoords = isLoaded.resolvedCoords;
                    const cachedFailedLocs = isLoaded.failedLocs;
                    setValidCount(cachedCoords.length);
                    setResolvedCoords(cachedResolvedCoords); 
                    setFailedLocs(new Set(cachedFailedLocs)); 
                    const AMap = window.AMap;
                    cachedCoords.forEach((loc, index) => {
                        const item = day.items.find(i => cachedResolvedCoords[i.id] && cachedResolvedCoords[i.id].lng === loc[0] && cachedResolvedCoords[i.id].lat === loc[1]);
                        if (item) {
                            const content = `<div style="display:flex;flex-direction:column;align-items:center;"><div style="background:#007AFF;color:white;font-size:10px;padding:2px 6px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">${index+1}.${item.title}</div><div style="width:10px;height:10px;background:#007AFF;border:2px solid white;border-radius:50%;"></div></div>`;
                            const marker = new AMap.Marker({ position: loc, content, anchor: 'bottom-center', offset: new AMap.Pixel(0, 0), zIndex: 100 + index });
                            mapInstance.current.add(marker);
                            markersRef.current[item.id] = marker; 
                        }
                    });
                    if (cachedCoords.length > 1) {
                        mapInstance.current.add(new AMap.Polyline({ path: cachedCoords, strokeColor: "#007AFF", strokeWeight: 8, isOutline: true, outlineColor: '#fff', showDir: true, zIndex: 50 }));
                    }
                    if (cachedCoords.length) mapInstance.current.setFitView(null, false, [40, 40, 40, 40]);
                    setIsLoading(false);
                }

                const initializeAndDrawMap = async (isLoaded) => {
                    try {
                        mapTimeoutRef.current = setTimeout(() => { clearMapLoading("ğŸš¨ åœ°å›¾åˆå§‹åŒ–è¶…æ—¶ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢ã€‚"); setMapError(true); }, 8000); 
                        await loadAMap();
                        clearTimeout(mapTimeoutRef.current);
                        if (!window.AMap) throw new Error("AMap not found");
                        if (!mapInstance.current && mapContainerRef.current) {
                            mapInstance.current = new window.AMap.Map(mapContainerRef.current, { zoom: 11, center: [104.06, 30.67], viewMode: '2D', features: ['bg', 'road', 'building', 'point'], showLabel: true, preserveDrawingBuffer: true });
                            mapInstance.current.addControl(new window.AMap.Scale());
                            mapInstance.current.addControl(new window.AMap.ToolBar({ position: 'RB', offset: new window.AMap.Pixel(10, 20) }));
                        }
                        setIsLoading(false);
                        if (!isLoaded || isLoaded === false) { await updateMapMarkers(true); } else if (mapInstance.current) { restoreMapFromCache(isLoaded); }
                    } catch(e) { console.error(e); setMapError(true); clearMapLoading("åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼"); }
                };

                initMap();
                return () => { clearTimeout(mapTimeoutRef.current); if (mapInstance.current) { mapInstance.current.clearMap(); } };
            }, [routeSignature, isEditing]);

            const geocodeWithTimeout = (geocoder, location, timeout = 5000) => {
                return new Promise((resolve, reject) => {
                    let timer = setTimeout(() => { reject(new Error("Timeout: Geocoding request took too long.")); }, timeout);
                    geocoder.getLocation(location, (status, result) => {
                        clearTimeout(timer);
                        if (status === 'complete' && result && result.geocodes.length > 0) { resolve(result); } else { resolve(null); }
                    });
                });
            };

            const updateMapMarkers = async (shouldShowToast = false) => {
                if (!mapInstance.current || !window.AMap) { if (shouldShowToast && showStatus) showStatus("åœ°å›¾æœªå‡†å¤‡å¥½ï¼Œè¯·ç¨ç­‰..."); return; }
                const map = mapInstance.current;
                const AMap = window.AMap;
                map.clearMap(); 
                markersRef.current = {}; 
                if (!AMap.Geocoder) await new Promise(r => AMap.plugin('AMap.Geocoder', r));
                const geocoder = new AMap.Geocoder({ city: "æˆéƒ½" });
                const items = day.items;
                const coords = [];
                const newResolvedCoords = {}; 
                const failures = new Set();
                
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (isVagueLocation(item.location)) { failures.add(item.id); continue; } 
                    if (item.skipMap) continue; 
                    if (shouldShowToast && showStatus) showStatus(`ğŸ” æ­£åœ¨æ£€æŸ¥ç¬¬ ${i + 1} ä¸ªåœ°ç‚¹: ${item.location}`);

                    try {
                        let loc = null;
                        let result = null;
                        if (geoCache[item.location]) { loc = geoCache[item.location]; } else if (/^\d+(\.\d+)?,\s*\d+(\.\d+)?$/.test(item.location)) {
                             const [lng, lat] = item.location.split(',').map(Number); loc = [lng, lat]; updateGeoCache(item.location, loc);
                        } else {
                            await new Promise(r => setTimeout(r, 150)); 
                            try { result = await geocodeWithTimeout(geocoder, item.location, 5000); } catch (error) { failures.add(item.id); continue; }
                            if (result && result.geocodes.length) { loc = [result.geocodes[0].location.lng, result.geocodes[0].location.lat]; updateGeoCache(item.location, loc); } else { failures.add(item.id); continue; }
                        }
                        if (loc) {
                            coords.push(loc); newResolvedCoords[item.id] = { lng: loc[0], lat: loc[1], name: item.location }; 
                            const content = `<div style="display:flex;flex-direction:column;align-items:center;"><div style="background:#007AFF;color:white;font-size:10px;padding:2px 6px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">${coords.length}.${item.title}</div><div style="width:10px;height:10px;background:#007AFF;border:2px solid white;border-radius:50%;"></div></div>`;
                            const marker = new AMap.Marker({ position: loc, content, anchor: 'bottom-center', offset: new AMap.Pixel(0, 0), zIndex: 100 + i });
                            map.add(marker); markersRef.current[item.id] = marker; 
                        }
                    } catch (e) { console.error(`Error processing item ${item.id}:`, e); failures.add(item.id); continue; }
                }
                
                if (coords.length > 1) { map.add(new AMap.Polyline({ path: coords, strokeColor: "#007AFF", strokeWeight: 8, isOutline: true, outlineColor: '#fff', showDir: true, zIndex: 50 })); }
                if (coords.length) map.setFitView(null, false, [40, 40, 40, 40]);
                setValidCount(coords.length); setResolvedCoords(newResolvedCoords); setFailedLocs(failures);
                updateMapLoadHistory(getCurrentDayKey(), { isLoaded: true, coords: coords, resolvedCoords: newResolvedCoords, failedLocs: Array.from(failures) });

                if (shouldShowToast && showStatus) {
                    if (coords.length > 0) showStatus("âœ… åœ°å›¾å·²æ ¹æ®æœ€æ–°è¡Œç¨‹æ›´æ–°");
                    else showStatus("âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆåœ°ç‚¹ï¼Œè¯·æ£€æŸ¥åœ°å€è¾“å…¥");
                }
            };

            const focusMarker = (id) => { const marker = markersRef.current[id]; if (marker && mapInstance.current) { mapInstance.current.setZoomAndCenter(16, marker.getPosition()); } };
            const getNextValidIndex = (currentIndex, items) => {
                for (let i = currentIndex + 1; i < items.length; i++) { const item = items[i]; const isFailed = failedLocs.has(item.id); if (!item.skipMap && !isFailed) { return i; } } return -1;
            };
            // ä¿®å¤åçš„ handleRetryï¼šå¢åŠ  async/await å’Œ finallyï¼Œç¡®ä¿ Loading ä¼šæ¶ˆå¤±
            const handleRetry = async () => { 
                setIsLoading(true); 
                try {
                    // å…ˆæ¸…ç†åœ°å›¾ï¼Œé¿å…æ®‹ç•™
                    if(mapInstance.current) mapInstance.current.clearMap();
                    // ç­‰å¾…æ ‡è®°ç»˜åˆ¶å®Œæˆ
                    await updateMapMarkers(true);
                } catch (e) {
                    console.error("Retry failed", e);
                    if(showStatus) showStatus("åˆ·æ–°é‡åˆ°é”™è¯¯ï¼Œè¯·é‡è¯•");
                } finally {
                    // å…³é”®ä¿®å¤ï¼šæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œå¿…é¡»å…³é—­ Loading çŠ¶æ€
                    setIsLoading(false); 
                }
            };
            const openFullMap = () => { const query = day.items.map(i => i.location).filter(l => l && l !== 'å¾…å®š').join('|'); window.open(`https://www.amap.com/search?query=${encodeURIComponent(query)}`, '_blank'); };
            const forceCenter = () => { if(mapInstance.current) mapInstance.current.setFitView(null, false, [40, 40, 40, 40]); };

            return (
                <div className="flex flex-col w-full md:h-full">
                    <div className="w-full h-[40vh] md:h-1/2 md:flex-1 shrink-0 relative bg-gray-100 rounded-3xl overflow-hidden shadow-inner border border-white/50 isolate group">
                        <div ref={mapContainerRef} className="w-full h-full absolute inset-0 z-0 bg-[#f5f5f5]" />
                        
                        {/* 1. é”™è¯¯æç¤ºåŒºåŸŸ */}
                        {mapError && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-500 bg-gray-50 z-20 p-4 text-center">
                                <MapIcon size={48} className="mb-2 opacity-20 text-red-500" />
                                <p className="font-bold text-lg mb-1 text-gray-700">åœ°å›¾åŠ è½½å¤±è´¥</p>
                                <div className="flex gap-2">
                                    <button onClick={handleRetry} className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 shadow-sm rounded-full text-sm font-bold text-gray-800 hover:bg-gray-100 active:scale-95 transition-all"><RefreshCw size={14} /> é‡è¯•</button>
                                    <button onClick={openFullMap} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white shadow-sm rounded-full text-sm font-bold hover:bg-blue-700 active:scale-95 transition-all"><ExternalLink size={14} /> æ‰“å¼€é«˜å¾·</button>
                                </div>
                            </div>
                        )}

                        {/* 2. Loading çŠ¶æ€ */}
                        {isLoading && !mapError && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center bg-gray-50/80 backdrop-blur-sm z-20">
                                <Loader2 className="w-8 h-8 text-ios-blue animate-spin mb-2" />
                                <p className="text-xs text-ios-subtext font-medium">æ­£åœ¨è¿æ¥é«˜å¾·åœ°å›¾...</p>
                            </div>
                        )}

                        {/* 3. åœ°å›¾æ§åˆ¶æŒ‰é’®ç»„ (æ–°å¢ï¼šåˆ·æ–°æŒ‰é’®) */}
                        {/* ä¿®æ”¹äº†æ ·å¼ï¼šopacity-100 è¡¨ç¤ºé»˜è®¤æ˜¾ç¤ºï¼Œmd:opacity-0 è¡¨ç¤ºç”µè„‘ç«¯é»˜è®¤éšè—(æ‚¬åœæ˜¾ç¤º) */}
                        <div className="absolute top-4 right-4 z-10 flex flex-col gap-2 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                             <button onClick={handleRetry} className="bg-white p-2 rounded-lg shadow-md text-gray-600 hover:text-blue-600 active:scale-95 transition-transform" title="å¼ºåˆ¶åˆ·æ–°åœ°å›¾">
                                <RefreshCw size={20}/>
                             </button>
                             <button onClick={forceCenter} className="bg-white p-2 rounded-lg shadow-md text-gray-600 hover:text-blue-600 active:scale-95 transition-transform" title="é‡æ–°èšç„¦">
                                <LocateFixed size={20}/>
                             </button>
                        </div>

                        <div className="absolute bottom-2 right-2 bg-white/80 px-2 py-1 rounded text-[10px] z-20 shadow-sm">å·²è¿æ¥ {validCount} ç‚¹</div>
                    </div>
                    
                    <div className="mt-4 px-2 md:px-4 md:pb-4 md:max-h-[25vh] md:overflow-y-auto custom-scrollbar shrink-0 bg-white z-10">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="font-bold text-gray-400 text-xs uppercase tracking-wider">ä»Šæ—¥è·¯çº¿</h3>
                            <button onClick={openFullMap} className="flex items-center gap-1 text-[10px] text-ios-blue font-bold bg-blue-50 px-2 py-1 rounded hover:bg-blue-100 transition-colors">æ‰“å¼€é«˜å¾· APP <ExternalLink size={10} /></button>
                        </div>
                        <div className="space-y-3 pb-8 md:pb-0">
                            {day.items.map((item, idx) => {
                                const isFailed = failedLocs.has(item.id);
                                if (item.skipMap) return null; 
                                const nextValidIdx = getNextValidIndex(idx, day.items);
                                const showNavButton = nextValidIdx !== -1 && !isFailed;
                                const startCoords = resolvedCoords[item.id];
                                const endCoords = showNavButton ? resolvedCoords[day.items[nextValidIdx].id] : null;
                                const canNav = startCoords && endCoords;

                                return (
                                    <React.Fragment key={item.id}>
                                        <div onClick={() => !isFailed && focusMarker(item.id)} className={`flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border group transition-colors cursor-pointer active:bg-blue-50 ${isFailed ? 'border-red-200 bg-red-50' : 'border-gray-100 hover:border-blue-200'}`}>
                                            <div className="flex items-center gap-3 overflow-hidden">
                                                <div className={`w-6 h-6 shrink-0 rounded-full flex items-center justify-center text-xs font-bold border ${isFailed ? 'bg-red-100 text-red-600 border-red-200' : 'bg-blue-50 text-blue-600 border-blue-100'}`}>{idx + 1}</div>
                                                <div className="min-w-0 flex-1">
                                                    <div className="font-bold text-sm text-gray-800 truncate flex items-center">{item.location} {isFailed && <span className="text-[10px] text-red-500 bg-red-100 px-1.5 rounded ml-2 flex items-center gap-0.5 border border-red-200"><AlertCircle size={10}/> éœ€æ£€æŸ¥åœ°ç‚¹</span>}</div>
                                                    <div className={`text-xs truncate ${isFailed ? 'text-red-400' : 'text-gray-400'}`}>{isFailed ? 'ğŸ“ åœ°ç‚¹æœªæ‰¾åˆ°ï¼Œè¯·ç‚¹å‡»ç¼–è¾‘è¾“å…¥æ­£ç¡®åœ°å€' : (item.transportDetail || 'å‰å¾€æ­¤å¤„')}</div>
                                                </div>
                                            </div>
                                            <button onClick={(e) => { e.stopPropagation(); window.open(`https://www.amap.com/search?query=${item.location}`, '_blank'); }} className="p-2 text-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 shrink-0 transition-colors active:scale-90"><Navigation2 size={16} /></button>
                                        </div>
                                        {showNavButton && canNav && (
                                            <div className="flex justify-center -my-1.5 relative z-10">
                                                <button onClick={() => { const uri = `https://uri.amap.com/navigation?from=${startCoords.lng},${startCoords.lat},${startCoords.name}&to=${endCoords.lng},${endCoords.lat},${endCoords.name}&mode=car&callnative=1`; window.location.href = uri; }} className="flex items-center gap-1 px-3 py-1 bg-white text-blue-600 rounded-full text-[10px] font-bold border border-blue-100 shadow-sm hover:bg-blue-50 hover:shadow-md transition-all"><ArrowDownIcon size={10} /> å¯¼èˆªåˆ°ä¸‹ä¸€ç«™</button>
                                            </div>
                                        )}
                                    </React.Fragment>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const DayImportModal = ({ dayData, plans, onConfirm, onCancel }) => {
            const [selectedPlanIdx, setSelectedPlanIdx] = useState(0);
            const [selectedDayIdx, setSelectedDayIdx] = useState(0);
            const [mode, setMode] = useState('append'); 
            const targetPlan = plans[selectedPlanIdx];

            const handleAppend = () => {
                if (!targetPlan || targetPlan.days.length === 0) return console.error("è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„ç›®æ ‡æ–¹æ¡ˆå’Œæ—¥æœŸã€‚");
                const targetPlanId = targetPlan.id;
                const targetDayId = targetPlan.days[selectedDayIdx].id;
                onConfirm({ type: 'append', targetPlanId, targetDayId, newItems: dayData.items });
            };

            const handleNewPlan = () => { onConfirm({ type: 'new', newDay: dayData }); };

            return (
                <div className="fixed inset-0 bg-black/50 z-[10004] flex items-center justify-center p-4" onClick={onCancel}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative space-y-4" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-xl text-blue-600">å¯¼å…¥å•æ—¥è¡Œç¨‹</h3>
                            <button onClick={onCancel} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                        </div>
                        <p className="text-sm text-gray-700">æ‚¨æ­£åœ¨å¯¼å…¥ **{dayData.customTitle || "æœªå‘½åå•æ—¥è¡Œç¨‹"}** çš„æ‰€æœ‰æ´»åŠ¨ã€‚</p>
                        <div className="flex bg-gray-100 rounded-xl p-1 text-sm font-bold">
                            <button onClick={() => setMode('append')} className={`flex-1 py-2 rounded-lg transition-colors ${mode === 'append' ? 'bg-white shadow-sm text-black' : 'text-gray-500'}`}>è¿½åŠ åˆ°ç°æœ‰æ—¥æœŸ</button>
                            <button onClick={() => setMode('new')} className={`flex-1 py-2 rounded-lg transition-colors ${mode === 'new' ? 'bg-white shadow-sm text-black' : 'text-gray-500'}`}>åˆ›å»ºä¸ºæ–°æ–¹æ¡ˆ</button>
                        </div>
                        {mode === 'append' && (
                            <div className="space-y-4 pt-2">
                                <p className="text-xs text-gray-500">é€‰æ‹©æ‚¨æƒ³å°†è¿™äº›æ´»åŠ¨è¿½åŠ åˆ°å“ªä¸ªæ–¹æ¡ˆçš„å“ªä¸€å¤©ï¼š</p>
                                <div>
                                    <label className="text-xs font-bold text-gray-600 block mb-1">ç›®æ ‡æ–¹æ¡ˆ</label>
                                    <select value={selectedPlanIdx} onChange={e => { setSelectedPlanIdx(Number(e.target.value)); setSelectedDayIdx(0); }} className="w-full p-3 border border-gray-300 rounded-xl bg-gray-50 font-bold">
                                        {plans.map((p, index) => ( <option key={p.id} value={index}>{p.name}</option> ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-600 block mb-1">ç›®æ ‡æ—¥æœŸ</label>
                                    <select value={selectedDayIdx} onChange={e => setSelectedDayIdx(Number(e.target.value))} className="w-full p-3 border border-gray-300 rounded-xl bg-gray-50">
                                        {targetPlan?.days.map((d, index) => ( <option key={d.id} value={index}>{d.customTitle || `Day ${index + 1}`}</option> ))}
                                    </select>
                                </div>
                                <button onClick={handleAppend} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">è¿½åŠ åˆ° {targetPlan?.days[selectedDayIdx]?.customTitle || 'é€‰å®šæ—¥æœŸ'}</button>
                            </div>
                        )}
                        {mode === 'new' && (
                            <div className="space-y-4 pt-2">
                                <p className="text-xs text-gray-500">å°†å¯¼å…¥çš„å•æ—¥è¡Œç¨‹ä¿å­˜ä¸ºä¸€ä¸ªå…¨æ–°çš„æ–¹æ¡ˆã€‚</p>
                                <button onClick={handleNewPlan} className="w-full bg-black text-white py-3 rounded-xl font-bold hover:opacity-80">åˆ›å»ºæ–°æ–¹æ¡ˆ</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [plans, setPlans] = useState([]);
            const [activePlanIdx, setActivePlanIdx] = useState(0);
            const [dayIdx, setDayIdx] = useState(0);
            const [mode, setMode] = useState('schedule');
            const [isEditing, setIsEditing] = useState(false);
            const [menu, setMenu] = useState(null); 
            const [showDatePicker, setShowDatePicker] = useState(false);
            const [showTips, setShowTips] = useState(false);
            const [showHelp, setShowHelp] = useState(false); 
            const [statusMessage, setStatusMessage] = useState(null); 
            const [currentWeather, setCurrentWeather] = useState(null); 
            const [isExporting, setIsExporting] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [exportData, setExportData] = useState(null); 
            const [dayDataToImport, setDayDataToImport] = useState(null); 
            const [previewImage, setPreviewImage] = useState(null); // æ–°å¢ï¼šé¢„è§ˆå›¾ç‰‡æ•°æ®
            
            const [mapLoadHistory, setMapLoadHistory] = useState(loadMapHistory()); 
            const [geoCache, setGeoCache] = useState(loadGeoCache());

            const captureRef = useRef(null);
            const exportRef = useRef(null);

            const getGreeting = () => {
                const hour = new Date().getHours();
                if (hour < 5) return "å¤œæ·±äº†";
                if (hour < 9) return "æ—©ä¸Šå¥½";
                if (hour < 12) return "ä¸Šåˆå¥½";
                if (hour < 14) return "ä¸­åˆå¥½";
                if (hour < 19) return "ä¸‹åˆå¥½";
                return "æ™šä¸Šå¥½";
            };

            const showStatus = (msg) => { setStatusMessage(msg); setTimeout(() => setStatusMessage(null), 3500); };
            const updateMapLoadHistory = (key, data) => { setMapLoadHistory(prev => { const newState = { ...prev, [key]: data }; saveMapHistory(newState); return newState; }); };
            const updateGeoCache = (key, data) => { setGeoCache(prev => { const newState = { ...prev, [key]: data }; saveGeoCache(newState); return newState; }); };

            const sortDayItems = (day) => {
                const newItems = [...day.items].sort((a, b) => { if (a.time < b.time) return -1; if (a.time > b.time) return 1; return 0; });
                return { ...day, items: newItems };
            };

            // ä¼˜åŒ–åçš„æ›´æ–°å‡½æ•°ï¼šåªåœ¨åœ°ç‚¹/æ’åºå®è´¨å˜åŒ–æ—¶æ¸…ç©ºåœ°å›¾ç¼“å­˜
            const handleUpdateDay = (updatedDay) => {
                const newPlans = [...plans];
                const oldDay = newPlans[activePlanIdx].days[dayIdx];
                newPlans[activePlanIdx].days[dayIdx] = sortDayItems(updatedDay);
                setPlans(newPlans);

                // ç”Ÿæˆç­¾åï¼šID + Location + SkipMap
                // åªæœ‰å½“è¿™äº›å±æ€§å˜åŒ–æ—¶ï¼Œåœ°å›¾æ‰éœ€è¦é‡æ–°ç»˜åˆ¶ã€‚
                // å¦‚æœæ‚¨åªæ˜¯æ”¹äº†æ ‡é¢˜ã€æ—¶é—´ã€æè¿°ï¼ŒoldSig === newSigï¼Œç¼“å­˜ä¸ä¼šè¢«æ¸…ç©ºã€‚
                const getMapSignature = (d) => d.items.map(i => `${i.id}|${i.location}|${i.skipMap}`).join('||');
                
                const oldSig = getMapSignature(oldDay);
                const newSig = getMapSignature(updatedDay);

                // åªæœ‰å½“åœ°å›¾ç›¸å…³çš„ç­¾åå˜åŒ–æ—¶ï¼Œæ‰æ¸…ç©ºç¼“å­˜
                if (oldSig !== newSig) {
                     const currentDayKey = `${newPlans[activePlanIdx].days[dayIdx].id}`;
                     if (mapLoadHistory[currentDayKey]) {
                        setMapLoadHistory(prev => ({ ...prev, [currentDayKey]: false }));
                     }
                }
            };

            useEffect(() => { setPlans(loadPlans()); }, []);
            useEffect(() => { if (plans.length) savePlans(plans); }, [plans]);

            if (!plans.length) return <div className="flex h-screen items-center justify-center"><Loader2 className="animate-spin"/></div>;
            
            const activePlan = plans[activePlanIdx];
            const activeDay = activePlan.days[dayIdx];
            
            let dateStr = "æ—¥æœŸé”™è¯¯";
            let activeDateObj = new Date();
            try {
                if(activePlan.startDate) {
                    activeDateObj = new Date(new Date(activePlan.startDate).getTime() + dayIdx * 86400000);
                    if(!isNaN(activeDateObj.getTime())) { dateStr = activeDateObj.toLocaleDateString('zh-CN', {month:'short', day:'numeric', weekday:'short'}); }
                }
            } catch(e) {}

            const updatePlanName = (name) => { const newPlans = [...plans]; newPlans[activePlanIdx].name = name; setPlans(newPlans); };

            const triggerExport = (type) => {
                setMenu(null);
                if (type === 'all') {
                    setExportData({ title: 'å¤‡ä»½æ‰€æœ‰æ•°æ®', desc: 'åŒ…å«æ‰€æœ‰è¡Œç¨‹æ–¹æ¡ˆï¼Œå¯ç”¨äºæ¢å¤ã€‚', data: plans, filename: `chengdu_backup_${new Date().toISOString().slice(0,10)}.json` });
                } else if (type === 'current_day') {
                    const dayToExport = activeDay.items.map(item => ({ t: item.time, tit: item.title, desc: item.description, l: item.location, trans: item.transportDetail, imgs: item.images, skipMap: item.skipMap, type: item.type }));
                    setExportData({ title: `åˆ†äº«: ${activeDay.customTitle}`, desc: 'ä»…åŒ…å«å½“å‰é€‰å®šæ—¥æœŸï¼ˆå•æ—¥è¡Œç¨‹ï¼‰çš„æ´»åŠ¨åˆ—è¡¨ã€‚', data: { customTitle: activeDay.customTitle, items: dayToExport }, filename: `day_export_${activePlan.name}_Day${dayIdx + 1}.json` });
                } else {
                    setExportData({ title: `åˆ†äº«: ${activePlan.name}`, desc: 'ä»…åŒ…å«å½“å‰æ˜¾ç¤ºçš„æ–¹æ¡ˆã€‚', data: activePlan, filename: `plan_${activePlan.name.replace(/\s+/g, '_')}.json` });
                }
            };

            const processImport = (jsonContent) => {
                try {
                    const parsed = typeof jsonContent === 'string' ? JSON.parse(jsonContent) : jsonContent;
                    if (parsed.items && !parsed.days) {
                        const normalizedDay = {
                            id: `d_${Date.now()}_import`,
                            customTitle: parsed.customTitle || parsed.title || "å¯¼å…¥çš„å•æ—¥è¡Œç¨‹",
                            items: (parsed.items || []).map(i => ({ id: i.id || `i_${Date.now()}_${Math.random()}`, time: i.time || i.t || "09:00", title: i.title || i.tit || "æœªå‘½åæ´»åŠ¨", description: i.description || i.desc || "", location: i.location || (i.l ? extractLocation(i.l, i.tit) : "å¾…å®š"), type: i.type || 'spot', transportDetail: i.transportDetail || i.trans || "", images: i.images || [], skipMap: i.skipMap !== undefined ? i.skipMap : false }))
                        };
                        setDayDataToImport(normalizedDay); return true; 
                    }
                    let newPlansToAdd = [];
                    const normalizePlan = (p) => {
                        return {
                            id: p.id || `p_${Date.now()}_${Math.random()}`,
                            name: (p.name || "å¯¼å…¥æ–¹æ¡ˆ") + " (å¯¼å…¥)",
                            startDate: p.startDate || new Date().toISOString().split('T')[0],
                            days: (p.days || []).map((d, dIdx) => ({
                                id: d.id || `d_${Date.now()}_${dIdx}`,
                                customTitle: d.customTitle || d.title || `Day ${dIdx+1}`,
                                items: sortDayItems({
                                    items: (d.items || []).map((i, iIdx) => ({ id: i.id || `i_${Date.now()}_${dIdx}_${iIdx}`, time: i.time || i.t || "09:00", title: i.title || i.tit || "æœªå‘½åæ´»åŠ¨", description: i.description || i.desc || "", location: i.location || (i.l ? extractLocation(i.l, i.tit) : "å¾…å®š"), type: i.type || 'spot', transportDetail: i.transportDetail || i.trans || "", images: i.images || [], skipMap: i.skipMap !== undefined ? i.skipMap : false }))
                                }).items
                            }))
                        };
                    };
                    if (Array.isArray(parsed)) {
                         if (confirm("è¯†åˆ«åˆ°å¤šæ¡æ–¹æ¡ˆæ•°æ®ã€‚ç‚¹å‡»[ç¡®å®š]è¦†ç›–å½“å‰æ‰€æœ‰æ–¹æ¡ˆï¼Œç‚¹å‡»[å–æ¶ˆ]ä»…è¿½åŠ åˆ°ç°æœ‰åˆ—è¡¨ã€‚")) { setPlans(parsed.map(normalizePlan)); setActivePlanIdx(0); setDayIdx(0); showStatus("ğŸ‰ å·²æˆåŠŸè¦†ç›–æ‰€æœ‰æ–¹æ¡ˆï¼"); return true; } else { newPlansToAdd = parsed.map(normalizePlan); }
                    } else if (parsed.days) { newPlansToAdd = [normalizePlan(parsed)]; } else { console.error("æ•°æ®æ ¼å¼æ— æ³•è¯†åˆ«"); showStatus("âš ï¸ å¯¼å…¥å¤±è´¥ï¼šæ•°æ®æ ¼å¼æ— æ³•è¯†åˆ«ã€‚è¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹ã€‚"); return false; }
                    if (newPlansToAdd.length > 0) { setPlans(prev => [...prev, ...newPlansToAdd]); setActivePlanIdx(plans.length); setDayIdx(0); showStatus(`ğŸ‰ æˆåŠŸå¯¼å…¥ ${newPlansToAdd.length} ä¸ªæ–°æ–¹æ¡ˆï¼`); return true; }
                } catch (e) { console.error(e); showStatus(`ğŸš¨ å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶å†…å®¹é”™è¯¯ã€‚è¯·ç¡®è®¤æ˜¯ JSON æ ¼å¼ã€‚`); return false; }
            };

            const handleDayImportFinalize = ({ type, targetPlanId, targetDayId, newItems, newDay }) => {
                const newPlans = [...plans];
                if (type === 'new') {
                    const newPlan = { id: `p_${Date.now()}`, name: newDay.customTitle, startDate: new Date().toISOString().split('T')[0], days: [ { id: `d_${Date.now()}_0`, customTitle: newDay.customTitle, items: newDay.items } ] };
                    newPlans.push(newPlan); setActivePlanIdx(newPlans.length - 1); setDayIdx(0); showStatus(`ğŸ‰ å·²åˆ›å»ºæ–°æ–¹æ¡ˆï¼š${newDay.customTitle}`);
                } else if (type === 'append') {
                    const planIdx = newPlans.findIndex(p => p.id === targetPlanId);
                    const dayIdx = newPlans[planIdx].days.findIndex(d => d.id === targetDayId);
                    if (planIdx !== -1 && dayIdx !== -1) {
                        const targetDay = newPlans[planIdx].days[dayIdx];
                        targetDay.items.push(...newItems);
                        newPlans[planIdx].days[dayIdx] = sortDayItems(targetDay);
                        setActivePlanIdx(planIdx); setDayIdx(dayIdx); showStatus(`ğŸ‘ å·²æˆåŠŸè¿½åŠ  ${newItems.length} ä¸ªæ´»åŠ¨åˆ° ${targetDay.customTitle} å¹¶æ’åºï¼`);
                    }
                }
                setPlans(newPlans); setDayDataToImport(null);
            };

            const handleFileImport = (e) => {
                const file = e.target.files[0];
                if (!file) { showStatus("âš ï¸ è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œå¯¼å…¥ã€‚"); return; }
                const reader = new FileReader();
                reader.onload = (event) => { const success = processImport(event.target.result); if (success && !dayDataToImport) setShowImportModal(false); };
                reader.readAsText(file);
            };

            const handleTextImport = (e) => {
                e.preventDefault();
                const text = e.target.elements.importText.value;
                if (!text.trim()) { showStatus("âš ï¸ ç²˜è´´å†…å®¹ä¸èƒ½ä¸ºç©ºã€‚"); return; }
                const success = processImport(text);
                if (success && !dayDataToImport) setShowImportModal(false);
            };

            // --- æ ¸å¿ƒä¿®æ”¹ï¼šç”Ÿæˆæˆªå›¾é¢„è§ˆé€»è¾‘ ---
            const screenshot = async () => {
                setIsExporting(true);
                setMenu(null);
                await new Promise(r => setTimeout(r, 800)); // ç­‰å¾…æ¸²æŸ“
                try {
                    const target = exportRef.current;
                    if (!target) throw new Error("Export container not found");
                    const isSingleDayExport = exportData && exportData.data.customTitle && !exportData.data.days;
                    const planToRender = isSingleDayExport ? exportData.data : activePlan;
                    
                    const canvas = await window.html2canvas(target, { 
                        scale: 2, 
                        useCORS: true, 
                        allowTaint: true, 
                        logging: false, 
                        backgroundColor: '#F2F2F7',
                        width: target.offsetWidth,
                        height: target.scrollHeight,
                        windowWidth: target.offsetWidth,
                        windowHeight: target.scrollHeight
                    });
                    
                    // å°†ç”Ÿæˆçš„ Canvas è½¬ä¸ºå›¾ç‰‡æ•°æ® URLï¼Œå¹¶è®¾ç½®åˆ°çŠ¶æ€ä¸­ä»¥è§¦å‘é¢„è§ˆ Modal
                    const imgUrl = canvas.toDataURL("image/png");
                    setPreviewImage(imgUrl);
                    
                } catch(e) { 
                    console.error(e); 
                    showStatus("ğŸš¨ ç”Ÿæˆå¤±è´¥ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–ä½¿ç”¨ç”µè„‘ç«¯æ“ä½œã€‚"); 
                } finally { 
                    setIsExporting(false); 
                }
            };
            
            const handleAddDay = () => {
                const newPlans = [...plans];
                newPlans[activePlanIdx].days.push({ id: Date.now(), customTitle: `Day ${newPlans[activePlanIdx].days.length+1}`, items: [] });
                setPlans(newPlans); setDayIdx(newPlans[activePlanIdx].days.length - 1); showStatus("ğŸ“… å·²æ·»åŠ æ–°çš„ä¸€å¤©è¡Œç¨‹ã€‚");
            };

            const handleDeleteDay = () => {
                if (activePlan.days.length <= 1) { showStatus("âš ï¸ å¿…é¡»ä¿ç•™è‡³å°‘ä¸€å¤©è¡Œç¨‹ï¼"); return console.error("è‡³å°‘ä¿ç•™ä¸€å¤©ï¼"); }
                if (!confirm("åˆ é™¤è¿™å¤©çš„è¡Œç¨‹ï¼Ÿ")) return;
                const newPlans = [...plans]; newPlans[activePlanIdx].days.splice(dayIdx, 1); setPlans(newPlans); setDayIdx(d => Math.max(0, d - 1)); showStatus("ğŸ—‘ï¸ å½“å¤©è¡Œç¨‹å·²åˆ é™¤ã€‚");
            };

            const handleDeletePlan = () => {
                if (plans.length <= 1) { showStatus("âš ï¸ å¿…é¡»ä¿ç•™è‡³å°‘ä¸€ä¸ªæ–¹æ¡ˆï¼"); return console.error("è‡³å°‘ä¿ç•™ä¸€ä¸ªæ–¹æ¡ˆï¼"); }
                if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–¹æ¡ˆ \"${activePlan.name}\" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) return;
                const newPlans = plans.filter((_, i) => i !== activePlanIdx); setPlans(newPlans); setActivePlanIdx(prev => Math.min(prev, newPlans.length - 1)); setDayIdx(0); setMenu(null); showStatus(`ğŸ—‘ï¸ æ–¹æ¡ˆ \"${activePlan.name}\" å·²å½»åº•åˆ é™¤ã€‚`);
            };

            const updateStartDate = (date) => { if(!date) return; const newPlans = [...plans]; newPlans[activePlanIdx].startDate = date; setPlans(newPlans); setShowDatePicker(false); showStatus("ğŸ—“ï¸ å‡ºå‘æ—¥æœŸå·²æ›´æ–°ï¼"); };

            // è´´å¿ƒå»ºè®®
            const getTips = () => {
                const tips = [];
                if (currentWeather) {
                    const weather = currentWeather.weather || currentWeather; 
                    const maxTemp = parseInt(weather.dayTemp || weather.temperature || 20);
                    const minTemp = parseInt(weather.nightTemp || 15);
                    const type = weather.dayWeather || weather.weather || 'å¤šäº‘';

                    let clothingText = "";
                    if (minTemp < 10) { 
                        clothingText = "æˆéƒ½çš„å†·æ˜¯æ¸—è¿›å»çš„æ¹¿å†·ï¼Œä½“æ„Ÿæ¸©åº¦ä¼šæ¯”é¢„æŠ¥ä½3-5åº¦ã€‚å»ºè®®å¤‡ä¸€ä»¶é˜²é£çš„åšå¤–å¥—ï¼Œä»¥å…æ™šä¸Šå—å‡‰ã€‚"; 
                    } else if (minTemp < 15) { 
                        clothingText = "æ—©æ™šæ¸©å·®æ¯”è¾ƒæ˜æ˜¾ï¼Œä¸­åˆå¯èƒ½è§‰å¾—çƒ­ï¼Œä½†å¤ªé˜³è½å±±åé™æ¸©å¾ˆå¿«ã€‚"; 
                    } else { 
                        clothingText = "æ°”æ¸©æ¯”è¾ƒèˆ’é€‚ï¼Œä½†å¦‚æœæ˜¯é˜´å¤©ï¼Œä½“æ„Ÿä¼šåå‡‰ã€‚"; 
                    }
                    
                    tips.push({ title: "ğŸŒ¡ï¸ å…³äºæ°”æ¸©", content: `${clothingText} (é¢„æŠ¥ï¼š${minTemp}Â°-${maxTemp}Â°)` });
                    
                    if ((type || '').includes('é›¨')) { 
                        tips.push({ title: "ğŸŒ§ï¸ å¤©æ°”æé†’", content: "é¢„æŠ¥æœ‰é›¨ï¼Œé’çŸ³æ¿è·¯é¢æ½®æ¹¿å¯èƒ½ä¼šæ»‘ï¼Œèµ°è·¯æ—¶è¯·ç•™æ„è„šä¸‹ã€‚" }); 
                    }
                } else { 
                    tips.push({ title: "ğŸŒ¡ï¸ æ°”æ¸©æç¤º", content: "æ­£åœ¨åŒæ­¥å®æ—¶å¤©æ°”æ•°æ®..." }); 
                }

                // 2. é¥®é£Ÿå…³æ€€ï¼šè€ƒè™‘åˆ°å¥¹æ˜¯æ±Ÿè‹äººï¼ˆå£å‘³åç”œ/æ¸…æ·¡ï¼‰ï¼Œå¯¹æˆéƒ½æ²¹è¾£çš„éšæ™¦å…³å¿ƒ
                tips.push({ title: "ğŸŒ¶ï¸ å£å‘³å‚è€ƒ", content: "åˆåˆ°æˆéƒ½ï¼Œçº¢æ²¹å¯èƒ½æ¯”æƒ³è±¡ä¸­åšé‡ã€‚æœ¬åœ°ç«é”…å¤šä¸ºç‰›æ²¹é”…åº•ï¼Œåšé‡æ„Ÿå¼ºã€‚è¾£åº¦åˆ†çº§å‚è€ƒï¼šå¾®å¾®è¾£ â‰ˆ å¤–åœ°ä¸­è¾£ã€‚å”¯æ€¡è±†å¥¶æ˜¯æœ¬åœ°è§£è¾£æ ‡é…ã€‚" });

                // 3. è¡Œç¨‹å…³æ€€ï¼šå¼ºè°ƒâ€œä¸ç´¯â€ï¼Œç»™å¥¹å¿ƒç†å‡è´Ÿï¼Œè€Œä¸æ˜¯è¯´â€œæˆ‘ä¼šèƒŒä½ â€
                tips.push({ title: "ğŸ‘Ÿ å‡ºè¡Œå»ºè®®", content: "è¡Œç¨‹å¯èƒ½è¦èµ°ä¸å°‘è·¯ï¼Œç©¿åŒèˆ’æœçš„å¹³åº•é‹å“¦ã€‚ç´¯äº†æˆ‘ä»¬å°±æ‰¾ä¸ªèŒ¶é¦†ååï¼Ÿ" });

                // 4. ç‰¹æ®Šæé†’ï¼šå®¢è§‚çš„ç”Ÿç†èˆ’é€‚åº¦æé†’
                tips.push({ title: "ğŸ¼ ç†ŠçŒ«åŸºåœ°", content: "å¦‚æœæ—©èµ·å»ç†ŠçŒ«åŸºåœ°ï¼Œå»ºè®®å¤šç©¿ä¸€å±‚ã€‚å±±ä¸Šæ ‘æœ¨å¤šï¼Œæ¸…æ™¨æ¹¿åº¦å¤§ï¼Œæ¯”å¸‚åŒºæ›´å†·ä¸€äº›ã€‚" });

                return tips;
            };

            return (
                <div className="h-screen w-full bg-[#F2F2F7] md:flex md:justify-center md:py-10">
                    <div ref={captureRef} className="w-full h-full md:max-w-6xl md:h-[90vh] md:flex md:gap-6 md:px-6">
                        <div className="w-full md:max-w-md bg-white md:rounded-[40px] relative h-full flex flex-col overflow-hidden shadow-2xl">
                            <div className="relative z-50 p-6 pb-2 border-b border-gray-100 flex justify-between items-center ui-control bg-white">
                                <div>
                                    <div className="text-[10px] text-gray-400 font-medium mb-0.5 pl-0.5 tracking-wide">
                                        {getGreeting()}ï¼Œbeibeiã€‚
                                    </div>
                                    {isEditing ? (
                                        <input value={activePlan.name} onChange={(e) => updatePlanName(e.target.value)} className="font-bold text-xl bg-gray-50 border border-gray-200 p-1.5 -ml-1 rounded w-full max-w-[240px] text-ios-text focus:ring-2 ring-blue-500 outline-none" />
                                    ) : (
                                        <div onClick={() => setMenu('plans')} className="font-bold text-xl flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 -ml-1 rounded">{activePlan.name} <ChevronRight size={16}/></div>
                                    )}
                                    <div className="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                        <button onClick={() => setDayIdx(d => Math.max(0, d-1))} disabled={dayIdx===0}><ChevronLeft size={14}/></button>
                                        <span onClick={() => setShowDatePicker(true)} className="font-mono bg-gray-100 px-2 py-1 rounded cursor-pointer flex items-center gap-1 hover:bg-gray-200">{dateStr} <CalendarDays size={10}/></span>
                                        <button onClick={() => setDayIdx(d => Math.min(activePlan.days.length-1, d+1))} disabled={dayIdx===activePlan.days.length-1}><ChevronRight size={14}/></button>
                                        {!isEditing && ( <button onClick={() => triggerExport('current_day')} className="ml-2 px-2 py-1 bg-blue-50 text-blue-600 rounded-lg font-bold text-[10px] flex items-center gap-1 hover:bg-blue-100 transition-colors"><Share2 size={10} /> åˆ†äº«å½“å¤©</button> )}
                                        {isEditing && (
                                            <>
                                                <div className="w-px h-3 bg-gray-300 mx-1"></div>
                                                <button onClick={handleAddDay} className="text-blue-500 p-1 hover:bg-blue-50 rounded"><Plus size={14}/></button>
                                                {activePlan.days.length > 1 && <button onClick={handleDeleteDay} className="text-red-400 p-1 hover:bg-red-50 rounded"><Trash2 size={14}/></button>}
                                            </>
                                        )}
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowHelp(true)} className="p-2 bg-ios-blue text-white rounded-full hover:bg-blue-600 transition-colors" title="å¸®åŠ©"><Info size={18}/></button>
                                    <button onClick={() => setShowTips(true)} className="p-2 bg-orange-50 text-orange-500 rounded-full hover:bg-orange-100"><Lightbulb size={18}/></button>
                                    <button onClick={() => setMode(m => m==='schedule'?'traffic':'schedule')} className="p-2 bg-gray-100 rounded-full md:hidden">{mode==='schedule'?<Map size={18}/>:<Calendar size={18}/>}</button>
                                    <button onClick={() => setMenu('settings')} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><Settings size={18}/></button>
                                </div>
                            </div>

                            <div className="flex-1 overflow-y-auto px-6 py-4 pb-24 md:custom-scrollbar">
                                {/* æ‰‹æœºç«¯è§†å›¾é€»è¾‘ */}
                                <div className="md:hidden">
                                    <WeatherWidget date={activeDateObj.toISOString().split('T')[0]} onWeatherUpdate={setCurrentWeather} showStatus={showStatus} />
                                    
                                    {/* æ ¸å¿ƒé€»è¾‘ï¼šè¿™é‡Œä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦ (? :) */}
                                    {/* å½“ mode ä¸º 'schedule' æ—¶ï¼ŒTrafficView è¢«å®Œå…¨ç§»é™¤ï¼Œä¸æ‰§è¡Œä»»ä½•ä»£ç  */}
                                    {mode === 'schedule' ? 
                                        <ScheduleView 
                                            day={activeDay} 
                                            isEditing={isEditing} 
                                            setIsEditing={setIsEditing} 
                                            onUpdateDay={handleUpdateDay} 
                                            onImageUpload={async (id, fs) => { const imgs = []; for(let f of fs) imgs.push(await fileToBase64(f)); const p = [...plans]; const items = p[activePlanIdx].days[dayIdx].items; items.find(i=>i.id===id).images.push(...imgs); setPlans(p); }} 
                                        /> 
                                    : 
                                        /* å½“ç‚¹å‡»åœ°å›¾å›¾æ ‡åˆ‡æ¢ mode ä¸º 'traffic' æ—¶ï¼Œç»„ä»¶æ‰æŒ‚è½½å¹¶è¿è¡Œ */
                                        /* è®°å¾—åŠ ä¸Š isEditing={isEditing} ä»¥é˜²ä¸‡ä¸€ */
                                        <TrafficView 
                                            day={activeDay} 
                                            showStatus={showStatus} 
                                            mapLoadHistory={mapLoadHistory} 
                                            updateMapLoadHistory={updateMapLoadHistory} 
                                            geoCache={geoCache} 
                                            updateGeoCache={updateGeoCache} 
                                            isEditing={isEditing} 
                                        />
                                    }
                                </div>

                                {/* ç”µè„‘ç«¯è§†å›¾é€»è¾‘ (ä¿æŒå¸¸é©») */}
                                <div className="hidden md:block">
                                     <ScheduleView day={activeDay} isEditing={isEditing} setIsEditing={setIsEditing} onUpdateDay={handleUpdateDay} onImageUpload={async (id, fs) => { const imgs = []; for(let f of fs) imgs.push(await fileToBase64(f)); const p = [...plans]; const items = p[activePlanIdx].days[dayIdx].items; items.find(i=>i.id===id).images.push(...imgs); setPlans(p); }} />
                                </div>
                            </div>

                            <div className={`absolute bottom-6 left-0 right-0 justify-center ui-control pointer-events-none z-40 ${mode === 'traffic' ? 'hidden md:flex' : 'flex'}`}>
                                <button onClick={() => setIsEditing(!isEditing)} className="pointer-events-auto bg-black text-white px-6 py-3 rounded-full font-bold shadow-xl flex gap-2 items-center hover:scale-105 transition-transform">
                                    {isEditing ? <Check size={18}/> : <Edit3 size={18}/>} {isEditing ? 'å®Œæˆ' : 'ç¼–è¾‘'}
                                </button>
                            </div>
                        </div>

                        <div className="hidden md:flex flex-col flex-1 gap-6 h-full">
                            <WeatherWidget date={activeDateObj.toISOString().split('T')[0]} onWeatherUpdate={setCurrentWeather} showStatus={showStatus} />
                            <div className="flex-1 bg-white rounded-[40px] shadow-xl overflow-hidden p-1">
                                <TrafficView day={activeDay} showStatus={showStatus} mapLoadHistory={mapLoadHistory} updateMapLoadHistory={updateMapLoadHistory} geoCache={geoCache} updateGeoCache={updateGeoCache} isEditing={isEditing} />
                            </div>
                        </div>
                    </div>

                    {isExporting && ( <div className="fixed top-0 left-[-9999px] z-[-1]" ref={exportRef}> <PlanExportView plan={exportData?.data || activePlan} /> </div> )}
                    {isExporting && ( <div className="fixed inset-0 z-[10002] bg-black/60 backdrop-blur-sm flex flex-col items-center justify-center text-white"> <Loader2 className="w-12 h-12 animate-spin mb-4" /> <p className="font-bold text-lg">æ­£åœ¨ç”Ÿæˆè¡Œç¨‹é•¿å›¾...</p> <p className="text-sm opacity-70 mt-2">åŒ…å«æ‰€æœ‰å¤©æ•°ï¼Œè‡ªåŠ¨å±•å¼€è¯¦æƒ…</p> </div> )}

                    {/* --- æ–°å¢ï¼šå›¾ç‰‡é¢„è§ˆä¸ä¿å­˜é®ç½©å±‚ --- */}
                    {previewImage && (
                        <div className="fixed inset-0 z-[10010] bg-black/90 backdrop-blur-md flex flex-col items-center justify-center p-4 animate-[fadeIn_0.2s_ease-out]" onClick={() => setPreviewImage(null)}>
                            {/* å›¾ç‰‡å®¹å™¨ */}
                            <div className="relative w-full max-w-xl max-h-[70vh] overflow-y-auto rounded-xl shadow-2xl custom-scrollbar bg-gray-100 mb-6" onClick={e => e.stopPropagation()}>
                                <img src={previewImage} className="w-full h-auto block" alt="è¡Œç¨‹é•¿å›¾é¢„è§ˆ" />
                            </div>
                            
                            {/* åº•éƒ¨æŒ‰é’®åŒºåŸŸ */}
                            <div className="flex flex-col items-center gap-3 w-full max-w-sm pointer-events-auto" onClick={e => e.stopPropagation()}>
                                <p className="text-white/60 text-xs md:hidden mb-1">ğŸ’¡ æ‰‹æœºç«¯ï¼šè¯·é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ</p>
                                <div className="flex gap-3 w-full">
                                    <button onClick={() => {
                                        const link = document.createElement('a');
                                        link.download = `è¡Œç¨‹é•¿å›¾-${activePlan.name}.png`;
                                        link.href = previewImage;
                                        document.body.appendChild(link);
                                        link.click();
                                        document.body.removeChild(link);
                                    }} className="flex-1 px-4 py-3 bg-white text-black rounded-xl font-bold shadow-lg hover:bg-gray-200 transition-colors flex items-center justify-center gap-2">
                                        <Download size={18}/> ä¿å­˜å›¾ç‰‡
                                    </button>
                                    <button onClick={() => setPreviewImage(null)} className="flex-1 px-4 py-3 bg-gray-800 text-white rounded-xl font-bold hover:bg-gray-700 transition-colors">
                                        å…³é—­
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {menu === 'plans' && (
                        <div className="fixed inset-0 bg-black/40 z-[10000] flex items-center justify-center p-8" onClick={() => setMenu(null)}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg">åˆ‡æ¢æ–¹æ¡ˆ</h3>
                                    <button onClick={() => setMenu(null)} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                                </div>
                                <div className="max-h-[60vh] overflow-y-auto space-y-2">
                                    {plans.map((p, i) => ( <button key={p.id} onClick={() => { setActivePlanIdx(i); setDayIdx(0); setMenu(null); }} className={`w-full text-left p-4 rounded-xl font-bold transition-colors ${activePlanIdx===i ? 'bg-black text-white' : 'bg-gray-100 hover:bg-gray-200'}`}> {p.name} <span className="text-xs font-normal opacity-60 ml-2">{p.days.length}å¤©</span> </button> ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {menu === 'settings' && (
                        <div className="fixed inset-0 bg-black/40 z-[10000] flex items-center justify-center p-8" onClick={() => setMenu(null)}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl space-y-3 relative" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-bold text-lg">è®¾ç½® & å¤‡ä»½</h3>
                                    <button onClick={() => setMenu(null)} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                                </div>
                                <button onClick={() => triggerExport('current')} className="w-full flex gap-3 items-center p-4 bg-blue-50 text-blue-600 rounded-xl font-bold hover:bg-blue-100"><Share2 size={18}/> åˆ†äº«å½“å‰æ–¹æ¡ˆ (å…¨éƒ¨)</button>
                                <button onClick={() => triggerExport('all')} className="w-full flex gap-3 items-center p-4 bg-gray-100 rounded-xl font-bold hover:bg-gray-200"><Copy size={18}/> å¤‡ä»½æ‰€æœ‰æ•°æ®</button>
                                <button onClick={() => { setMenu(null); setShowImportModal(true); }} className="w-full flex gap-3 items-center p-4 bg-blue-50 text-blue-600 rounded-xl font-bold hover:bg-blue-100 border border-blue-200"><Download size={18}/> å¯¼å…¥æ–¹æ¡ˆ / æ¢å¤å¤‡ä»½</button>
                                <hr className="border-gray-100"/>
                                <button onClick={handleDeletePlan} className="w-full flex gap-3 items-center p-4 bg-red-50 text-red-500 rounded-xl font-bold hover:bg-red-100"><Trash2 size={18}/> åˆ é™¤å½“å‰æ–¹æ¡ˆ</button>
                                {/* è¿™é‡Œçš„æŒ‰é’®ç°åœ¨ä¼šè§¦å‘æ–°çš„ screenshot å‡½æ•°ï¼Œæ˜¾ç¤ºé¢„è§ˆé®ç½©å±‚ */}
                                <button onClick={screenshot} className="w-full flex gap-3 items-center p-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-bold hover:opacity-90 shadow-md"><Image size={18}/> ç”Ÿæˆè¡Œç¨‹é•¿å›¾ (å…¨è§ˆ)</button>
                                <button onClick={() => { if(confirm("æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ")) { localStorage.clear(); location.reload(); }}} className="w-full flex gap-3 items-center p-4 bg-gray-100 text-gray-500 rounded-xl font-bold hover:bg-gray-200"><Trash2 size={18}/> é‡ç½®æ‰€æœ‰æ•°æ®</button>
                            </div>
                        </div>
                    )}

                    {showImportModal && (
                        <div className="fixed inset-0 bg-black/40 z-[10003] flex items-center justify-center p-4" onClick={() => setShowImportModal(false)}>
                            <div className="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-lg flex items-center gap-2"><Download size={20}/> å¯¼å…¥æ•°æ®</h3>
                                    <button onClick={() => setShowImportModal(false)} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                                </div>
                                <div className="space-y-6">
                                    <div className="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                        <div className="font-bold text-blue-800 mb-2 flex items-center gap-2"><FileUp size={18}/> æ–¹å¼1ï¼šä¸Šä¼  JSON æ–‡ä»¶ (æ¨è)</div>
                                        <p className="text-xs text-blue-600 mb-3">æ‰‹æœºç«¯é¦–é€‰ï¼å°†æ”»ç•¥ä¿å­˜ä¸º .json æ–‡ä»¶åä¸Šä¼ ï¼Œæ— éœ€å¤åˆ¶ç²˜è´´ã€‚</p>
                                        <label className="block w-full cursor-pointer bg-white border-2 border-dashed border-blue-300 rounded-xl p-4 text-center hover:bg-blue-50 transition-colors">
                                            <span className="text-blue-500 font-bold">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span>
                                            <input type="file" accept=".json,.txt" onChange={handleFileImport} className="hidden" />
                                        </label>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <div className="h-px bg-gray-200 flex-1"></div>
                                        <span className="text-gray-400 text-xs font-bold">OR</span>
                                        <div className="h-px bg-gray-200 flex-1"></div>
                                    </div>
                                    <form onSubmit={handleTextImport} className="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                                        <div className="font-bold text-gray-700 mb-2 flex items-center gap-2"><FileText size={18}/> æ–¹å¼2ï¼šç²˜è´´æ–‡æœ¬</div>
                                        <textarea name="importText" className="w-full h-32 p-3 text-xs font-mono bg-white border border-gray-200 rounded-xl focus:ring-2 ring-blue-500 outline-none resize-none" placeholder='åœ¨æ­¤ç²˜è´´ JSON æ•°æ®...'></textarea>
                                        <button type="submit" className="w-full mt-3 bg-black text-white py-3 rounded-xl font-bold hover:opacity-80">ç¡®è®¤å¯¼å…¥</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}

                    {dayDataToImport && ( <DayImportModal dayData={dayDataToImport} plans={plans} onConfirm={handleDayImportFinalize} onCancel={() => setDayDataToImport(null)} /> )}

                    {exportData && (
                        <div className="fixed inset-0 bg-black/40 z-[10003] flex items-center justify-center p-4" onClick={() => setExportData(null)}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg">{exportData.title}</h3>
                                    <button onClick={() => setExportData(null)} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                                </div>
                                <p className="text-sm text-gray-500 mb-6">{exportData.desc}</p>
                                <div className="space-y-3">
                                    <button onClick={() => { const blob = new Blob([JSON.stringify(exportData.data, null, 2)], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = exportData.filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); setExportData(null); showStatus("ğŸ’¾ æ•°æ®å·²ä¿å­˜åˆ°æ‚¨çš„è®¾å¤‡ã€‚"); }} className="w-full flex items-center justify-center gap-2 p-4 bg-blue-50 text-blue-600 rounded-xl font-bold hover:bg-blue-100 border border-blue-200">
                                        <FileDown size={20}/> ä¿å­˜ä¸º JSON æ–‡ä»¶
                                    </button>
                                    <button onClick={() => { const textarea = document.createElement('textarea'); textarea.value = JSON.stringify(exportData.data); document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea); showStatus("ğŸ“‹ å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼"); setExportData(null); }} className="w-full flex items-center justify-center gap-2 p-4 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200">
                                        <Copy size={20}/> å¤åˆ¶æ–‡æœ¬å†…å®¹
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showTips && (
                        <div className="fixed inset-0 bg-black/40 z-[10000] flex items-center justify-center p-8" onClick={() => setShowTips(false)}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative animate-[fadeIn_0.2s_ease-out]" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg flex items-center gap-2">ğŸ’¡ ä¸€äº›å°å»ºè®®</h3>
                                    <button onClick={() => setShowTips(false)} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                                </div>
                                <div className="space-y-3 text-sm text-gray-600 leading-relaxed">
                                    {getTips().map((tip, i) => (
                                        <div key={i} className={`p-3 rounded-xl border ${i%3===0?'bg-orange-50 border-orange-100 text-orange-800':i%3===1?'bg-blue-50 border-blue-100 text-blue-800':'bg-green-50 border-green-100 text-green-800'}`}>
                                            <span className="font-bold block mb-1">{tip.title}</span>
                                            {tip.content}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {showHelp && <HelpModal onClose={() => setShowHelp(false)} />}
                    {statusMessage && <StatusToast message={statusMessage} onClose={() => setStatusMessage(null)} />}

                    {showDatePicker && (
                        <div className="fixed inset-0 bg-black/40 z-[10000] flex items-center justify-center p-8" onClick={() => setShowDatePicker(false)}>
                            <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setShowDatePicker(false)} className="absolute top-4 right-4 p-2 bg-gray-100 rounded-full"><X size={14}/></button>
                                <h3 className="font-bold text-lg mb-4">è®¾ç½®å‡ºå‘æ—¥æœŸ</h3>
                                <input type="date" value={activePlan.startDate || ''} onChange={(e) => updateStartDate(e.target.value)} className="w-full p-4 bg-gray-100 rounded-xl font-bold outline-none focus:ring-2 ring-blue-500" />
                                <p className="text-xs text-gray-400 mt-2">ä¿®æ”¹åï¼Œåç»­è¡Œç¨‹ä¼šè‡ªåŠ¨é¡ºå»¶ã€‚</p>
                            </div>
                        </div>
                    )}
                </div>
            )
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>