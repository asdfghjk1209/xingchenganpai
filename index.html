<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Ë°åÁ®ãÂÆâÊéí</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script>
      window._AMapSecurityConfig = {
        securityJsCode: '6da6d6eb1afc97f8609795ec43fbec9f',
      };

      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ios: {
                blue: '#007AFF',
                gray: '#F2F2F7',
                card: 'rgba(255, 255, 255, 0.72)',
                text: '#1C1C1E',
                subtext: '#8E8E93',
                destruct: '#FF3B30',
                success: '#34C759',
              }
            },
            fontFamily: {
              sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
            }
          }
        }
      }
    </script>

    <style>
      body { background-color: #F2F2F7; -webkit-tap-highlight-color: transparent; }
      .glass { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0, 0, 0, 0.05); }
      .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.05); }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      @media (min-width: 768px) {
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: transparent; border-radius: 20px; transition: background-color 0.3s ease; }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.15); }
      }

      /* Time Picker Scroll Snap */
      .time-scroll-col {
        scroll-snap-type: y mandatory;
        overscroll-behavior: contain;
      }
      .time-scroll-item {
        scroll-snap-align: center;
      }
      
      .amap-logo, .amap-copyright { z-index: 1 !important; display: block !important; pointer-events: none; }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calendar, Map, Share2, Settings, ChevronLeft, ChevronRight, Edit3, Check, Copy, Download, Upload, Menu,
            Navigation2, Map as MapIcon, RefreshCw, Loader2, ExternalLink,
            Clock, MapPin, Coffee, Camera, MoveVertical, Image as ImageIcon, Trash2,
            CloudRain, Search, X, Plus, CalendarDays, LocateFixed, AlertCircle, Info, MapPinOff, Image, Eye, EyeOff,
            Navigation, RotateCw, ArrowDown, Lightbulb, ChevronUp, ChevronDown, FileText, FileUp, FileDown
        } from 'lucide-react';

        // --- UTILS & DATA ---
        const detectType = (title, desc) => {
            const text = (title + desc).toLowerCase();
            if (text.includes('ÂêÉ') || text.includes('È§ê') || text.includes('ÁÅ´ÈîÖ') || text.includes('‰∏≤‰∏≤') || text.includes('Èù¢') || text.includes('ËõãÁÉòÁ≥ï') || text.includes('Ëå∂')) return 'food';
            if (text.includes('ÈÖíÂ∫ó') || text.includes('‰ºëÊÅØ') || text.includes('Ëá™ÁÑ∂ÈÜí') || text.includes('Áù°Ëßâ')) return 'rest';
            if (text.includes('È´òÈìÅ') || text.includes('ËΩ¶') || text.includes('Âú∞ÈìÅ') || text.includes('È£û')) return 'transport';
            return 'spot';
        };

        const extractLocation = (l, title) => {
            if (l && l.includes('query=')) {
                try { return decodeURIComponent(l.split('query=')[1].split('&')[0]); } catch (e) { return title.split('(')[0]; }
            }
            let clean = title.split('(')[0].split('Ôºà')[0].trim();
            clean = clean.replace(/^(ÊôöÈ§ê|ÂçàÈ§ê|Êó©È§ê|‰ΩèÂÆø|ÂÖ•‰Ωè|ÈÖíÂ∫ó)[:Ôºö]\s*/, '');
            return clean;
        };

        const RAW_DATA = [
            {"id":"p1","name":"A: ËêΩÂú∞ & Â∏ÇÂå∫Êº´Ê∏∏","days":[{"title":"ËêΩÂú∞ & ‰ºëÊÅØ","items":[{"t":"14:30","tit":"ÂÖ•‰ΩèÈÖíÂ∫ó","desc":"Êé®ËçêÊò•ÁÜôË∑Ø/Â§™Âè§Èáå„ÄÇÂÖàÊï¥ÁêÜ‰ºëÊÅØÔºå‰∏çÊÄ•Âá∫Èó®„ÄÇ\nÈÖíÂ∫óÊé®ËçêÔºöÂÖ®Â≠£/‰∫öÊúµ","l":"","lt":"","imgs":[],"trans":""},{"t":"17:00","tit":"Â§™Âè§ÈáåÊº´Ê≠•","desc":"ÁúãIFSÁÜäÁå´Â±ÅËÇ°ÔºåÂ§ßÊÖàÂØ∫Á∫¢Â¢ôÊãçÁÖß„ÄÇ","l":"https://ditu.amap.com/search?query=Â§™Âè§Èáå","lt":"üìç ÂØºËà™","imgs":[],"trans":"üö∂ Ê≠•Ë°å"},{"t":"19:00","tit":"ÊôöÈ§ê: Â•éÊòüÊ•ºË°ó","desc":"ÂÜíÊ§íÁÅ´Ëæ£ÔºàÂÜ∑ÈîÖ‰∏≤‰∏≤ÔºåÂ∞èËèúÂæàÂ•ΩÂêÉÔºõ‰∫∫Â§öÊéíÈòüÊó©ÂéªÔºâ„ÄÅ\nÁ≥ñÊ≤πÊûúÂ≠êÔºàÂú®ÂÜíÊ§íÁÅ´Ëæ£ÊóÅËæπ‰∏ÄÊù°Ë°ó Êó©ÁÇπÂéªÔºåÂéªÊôö‰∫ÜÂ∞±ÂçñÂÆå‰∫ÜÔºâ„ÄÅ\nËõãÁÉòÁ≥ï","l":"https://ditu.amap.com/search?query=Â•éÊòüÊ•ºË°ó","lt":"üìç ÂØºËà™","imgs":[],"trans":"üöó ÊâìËΩ¶ 15ÂÖÉ"}]}]},
            {"id":"p2","name":"B: ÈùíÂüéÂ±±ÈóÆÈÅì","days":[{"title":"ÈóÆÈÅìÈùíÂüéÂ±±","items":[{"t":"09:00","tit":"ÈùíÂüéÂ±±","desc":"È´òÈìÅÁõ¥ËææÔºåÁäÄÊµ¶Á´ôÂá∫ÂèëÔºåÂèØÈÄâÊã©ÂâçÂ±±ÊàñÂêéÂ±±\nÂâçÂ±±ÔºöÂØ∫Â∫ô‰πãÁ±ª„ÄÅ‰ΩìÈ™åÈÅìÂÆ∂ÊñáÂåñ\nÂêéÂ±±ÔºöÈ£éÊôØ","l":"","lt":"","imgs":[],"trans":"üöÑ È´òÈìÅ"}]}]},
            {"id":"p1763809470975","name":"C: ÁªèÂÖ∏ÂøÖÊâìÂç°","days":[{"title":"ÁªèÂÖ∏‰∏ÄÊó•Ê∏∏","items":[{"t":"10:00","tit":"Èî¶Èáå/ÂÆΩÁ™ÑÂ∑∑Â≠ê","desc":"","l":"","lt":"","imgs":[],"trans":""},{"t":"12:00","tit":"ÂçàÈ•≠","desc":"Èöè‰æøÊâæÂÆ∂ËãçËùáÈ¶ÜÂ≠ê","l":"","lt":"","imgs":[],"trans":""},{"t":"14:00","tit":"‰∫∫Ê∞ëÂÖ¨Âõ≠","desc":"ÂñùËå∂","l":"","lt":"","imgs":[],"trans":""},{"t":"17:00","tit":"ÊôöÈ§ê","desc":"","l":"","lt":"","imgs":[],"trans":""}]}]},
            {"id":"p1763816913109","name":"D: ÁÜäÁå´ & ÁîµÂΩ±","days":[{"title":"ÁÜäÁå´ & ÁîúÂìÅ","items":[{"t":"09:30","tit":"ÁÜäÁå´Âü∫Âú∞(ÂçóÈó®)","desc":"ÊâìËΩ¶Áõ¥ËææÂçóÈó®Ôºå‰∏çÊéíÈòü„ÄÇ","l":"https://ditu.amap.com/search?query=ÁÜäÁå´Âü∫Âú∞ÂçóÈó®","lt":"üìç ÂØºËà™","imgs":[],"trans":""},{"t":"16:00","tit":"Â∞±ËøëÂ∏ÇÂå∫ÂêÉÈ•≠","desc":"","l":"https://ditu.amap.com/search?query=Â•éÊòüÊ•ºË°ó","lt":"üìç ÂØºËà™","imgs":[],"trans":""},{"t":"18:00","tit":"ÁúãÁîµÂΩ±","desc":"ÁñØÁãÇÂä®Áâ©ÂüéÔºàËÆ∞Âæó‰π∞imaxÂéüÂ£∞Ôºâ","l":"","lt":"","imgs":[],"trans":""}]}]},
            {"id":"p1763816971141","name":"E: ÊñáËâ∫ÊâìÂç°","days":[{"title":"ÊñáËâ∫ÊàêÈÉΩ","items":[{"t":"10:00","tit":"‰∫∫Ê∞ëÂÖ¨Âõ≠","desc":"ÂñùËå∂ÔºåÊÑüÂèóÊàêÈÉΩ‰∫∫Ê∞ëÊÖ¢ÁîüÊ¥ª","l":"","lt":"","imgs":[],"trans":""},{"t":"13:00","tit":"ÂÆΩÁ™ÑÂ∑∑Â≠ê","desc":"","l":"","lt":"","imgs":[],"trans":""},{"t":"16:00","tit":"‰∏úÈÉäËÆ∞ÂøÜ","desc":"ÁâπËâ≤Â∑•‰∏öÂõ≠Âå∫ÔºåÊãçÁÖßÂá∫Áâá","l":"","lt":"","imgs":[],"trans":""},{"t":"18:00","tit":"Âª∫ËÆæË∑Ø","desc":"ÈõÜÁªìÂêÑÁßçÂ∞èÂêÉÔºåËæπÈÄõËæπÂêÉ","l":"","lt":"","imgs":[],"trans":""}]}]},
            {"id":"p1763817288235","name":"F: Êâã‰ΩúÊó∂ÂÖâ","days":[{"title":"ÂÆâÈùôÂçàÂêé","items":[{"t":"10:00","tit":"ÊâãÂ∑•DIY","desc":"Èì∂È•∞/Èô∂Ëâ∫","l":"","lt":"","imgs":[],"trans":""}]}]},
            {"id":"p1763828749511","name":"G: ÁâπÁßçÂÖµ(‰º™) Day1","days":[{"title":"ÁÜäÁå´ & Â•éÊòüÊ•º","items":[{"t":"07:30","tit":"Â§ßÁÜäÁå´Âü∫Âú∞(ÂçóÈó®)","desc":"‚ö†Ô∏èÈáçÁÇπÔºö‰∏ÄÂÆöË¶ÅËµ∞ÂçóÈó®ÔºÅËøõÈó®ÂÅöÊëÜÊ∏°ËΩ¶Áõ¥ÂÜ≤ÊúÄ‰∏äÈù¢ÔºåÁÑ∂ÂêéËµ∞‰∏ãÊù•Áúã„ÄÇ\nÂøÖÁúãÔºöËä±Ëä±ÔºàÊéíÈòü‰πÖÔºâ„ÄÅËêåÂÖ∞„ÄÇ\nÂª∫ËÆÆÔºöÊó©ÂéªÔºåÁÜäÁå´‰∏≠ÂçàÂ∞±Áù°Ëßâ‰∫Ü„ÄÇ","l":"","trans":"üöó ÊâìËΩ¶ 40min","imgs":[],"lt":""},{"t":"12:30","tit":"Âª∫ËÆæË∑Ø/Â•éÊòüÊ•º","desc":"ÁúãÂÆåÁÜäÁå´È•ø‰∫ÜÁõ¥Êé•ÂéªÂêÉÔºÅ\nÊé®ËçêÔºöÂÜíÊ§íÁÅ´Ëæ£„ÄÅËõãÁÉòÁ≥ï„ÄÅÂÜ∞Á≤â„ÄÇ\nÈÅøÈõ∑Ôºö‰∏çË¶Å‰π∞Ë∑ØËæπÁöÑÈáëË•øÊ¢ÖÔºàÊüìËâ≤ÁöÑÔºâ„ÄÇ","l":"","trans":"üöá Âú∞ÈìÅ3Âè∑Á∫ø","imgs":[],"lt":""},{"t":"15:30","tit":"ÂÆΩÁ™ÑÂ∑∑Â≠ê","desc":"Âè™ÈÄõ‰∏ç‰π∞ÔºÅÊÑüÂèó‰∏Ä‰∏ãÂª∫Á≠ëÈ£éÊ†ºÂ∞±Ë°å„ÄÇ\nÊ∏∏ÂÆ¢ÁÖßÊâìÂç°ÁÇπÔºåÂïÜ‰∏öÂåñÊØîËæÉÈáçÔºå‰∏çÂª∫ËÆÆÂú®ÈáåÈù¢ÂêÉÈ•≠„ÄÇ","l":"","trans":"üö∂ Ê≠•Ë°å","imgs":[],"lt":""},{"t":"19:00","tit":"Â∞èÈæôÂùé/ËúÄÂ§ß‰æ†","desc":"Êôö‰∏äÊï¥È°øÊ≠£ÂÆóÁÅ´ÈîÖ„ÄÇ\nÊèêÁ§∫Ôºö‰∏çËÉΩÂêÉËæ£ÁÇπÂæÆËæ£+ÂîØÊÄ°Ë±ÜÂ•∂„ÄÇ","l":"Â∞èÈæôÂùéËÄÅÁÅ´ÈîÖ(Êò•ÁÜôË∑ØÂ∫ó)","trans":"üöó ÊâìËΩ¶","imgs":[],"lt":""}]}]},
            {"id":"p1763828750759","name":"H: Á•àÁ¶è & Â§™Âè§Èáå","days":[{"title":"Á•àÁ¶è & Â§™Âè§Èáå","items":[{"t":"10:00","tit":"ÊñáÊÆäÈô¢","desc":"Á∫¢Â¢ôÊãçÁÖßÂ∑®Âá∫ÁâáÔºÅ\nÁâπËâ≤ÔºöÊë∏‚ÄúÁ¶è‚ÄùÂ≠óÔºåÂêÉÊ¥ûÂ≠êÂè£Âº†ËÄÅ‰∫åÂáâÁ≤âÔºàÁîúÊ∞¥Èù¢‰∏ÄÁªùÔºâ„ÄÇ\n‰∏çÁî®Èó®Á•®ÔºåÈó®Âè£ÂèØ‰ª•È¢ÜÈ¶ô„ÄÇ","l":"ÊñáÊÆäÈô¢","trans":"üöá Âú∞ÈìÅ1Âè∑Á∫ø","imgs":[],"lt":""},{"t":"14:00","tit":"IFS & Â§™Âè§Èáå","desc":"ÂøÖÊâìÂç°ÔºöIFSÊ•º‰∏ãÁöÑÁÜäÁå´Â±ÅËÇ°Ôºà‰∏çÁî®‰∏äÊ•ºÊéíÈòüÔºâ„ÄÇ\nÂ§ßÊÖàÂØ∫ÔºöÂ∞±Âú®Â§™Âè§ÈáåÈáåÈù¢ÔºåÈóπ‰∏≠ÂèñÈùôÔºåÂñù‰∏™ÁõñÁ¢óËå∂„ÄÇ","l":"IFSÂõΩÈôÖÈáëËûç‰∏≠ÂøÉ","trans":"üöá Âú∞ÈìÅ2Âè∑Á∫ø","imgs":[],"lt":""},{"t":"19:00","tit":"‰πùÁúºÊ°•/ÂÆâÈ°∫ÂªäÊ°•","desc":"ÁúãÂ§úÊôØÁªùÁªùÂ≠êÔºÅ\nÂèØ‰ª•Âú®Ê≤≥ËæπÁöÑÂ∞èÈÖíÈ¶ÜÂùêÂùêÔºåÂêπÂêπÊôöÈ£éÔºåÈÄÇÂêàÊÉÖ‰æ£„ÄÇ","l":"ÂÆâÈ°∫ÂªäÊ°•","trans":"üöó ÊâìËΩ¶ 15ÂÖÉ","imgs":[],"lt":""}]}]},
            {"id":"p1763829583148","name":"I: ÊÖ¢ÁîüÊ¥ª Day1","days":[{"title":"‰∫∫Ê∞ëÂÖ¨Âõ≠ & ÁéâÊûó","items":[{"t":"10:30","tit":"‰∫∫Ê∞ëÂÖ¨Âõ≠","desc":"Ê†∏ÂøÉÔºö‰ΩìÈ™åÊàêÈÉΩÊÖ¢ÁîüÊ¥ª„ÄÇ\nÂøÖÂÅöÔºöÈπ§È∏£Ëå∂Á§æÂñùËå∂Ôºà30ÂÖÉ/ÊùØÔºâÔºå‰ΩìÈ™åÈááËÄ≥ÔºàËàíÁàΩÔºâ„ÄÇ\nÈÅøÈõ∑ÔºöÊôØÂå∫Èó®Âè£ÁöÑ‚Äú‰∏âÂ§ßÁÇÆ‚Äù‰∏çÁî®‰π∞„ÄÇ","l":"‰∫∫Ê∞ëÂÖ¨Âõ≠","trans":"üöá Âú∞ÈìÅ","imgs":[],"lt":""},{"t":"13:30","tit":"ÊàêÈÉΩÂçöÁâ©È¶Ü","desc":"Êñ∞È¶ÜÈùûÂ∏∏ÈúáÊíºÔºå‰∫ÜËß£ËúÄÊñáÂåñ„ÄÇ\n‚ö†Ô∏èÊ≥®ÊÑèÔºöÈúÄË¶ÅÊèêÂâçÂú®ÂÖ¨‰ºóÂè∑È¢ÑÁ∫¶ÔºÅÂë®‰∏ÄÈó≠È¶Ü„ÄÇ","l":"ÊàêÈÉΩÂçöÁâ©È¶ÜÊñ∞È¶Ü","trans":"üö∂ Ê≠•Ë°åÂèØËææ","imgs":[],"lt":""},{"t":"18:00","tit":"ÁéâÊûóË∑ØÂ∞èÈÖíÈ¶Ü","desc":"„ÄäÊàêÈÉΩ„ÄãÊ≠åÈáåÁöÑÁéâÊûóË∑Ø„ÄÇ\nÂæàÂ§öÁâπËâ≤BistroÂíåÂ∞èÂêÉÔºå‰∏çÂÉèÂ§™Âè§ÈáåÈÇ£‰πàÂïÜ‰∏öÔºåÂæàÊúâÁÉüÁÅ´Ê∞î„ÄÇ","l":"Â∞èÈÖíÈ¶Ü(ÁéâÊûóÂ∫ó)","trans":"üöó ÊâìËΩ¶","imgs":[],"lt":""}]}]},
            {"id":"p1763829708510","name":"J: ÊÖ¢ÁîüÊ¥ª Day2","days":[{"title":"‰∏úÈÉäËÆ∞ÂøÜ & Âª∫ËÆæË∑Ø","items":[{"t":"11:00","tit":"‰∏úÈÉäËÆ∞ÂøÜ","desc":"ÂéüÊú¨ÁöÑÂ∑•ÂéÇÊîπÂª∫ÁöÑÔºåÁ±ª‰ººÂåó‰∫¨798„ÄÇ\nÈùûÂ∏∏ÈÄÇÂêàÁªôÂ•≥ÊúãÂèãÊãçÁÖßÔºÅÊúâÂæàÂ§öÂ§çÂè§ÁöÑÂ¢ôÁªòÂíåË£ÖÁΩÆ„ÄÇ","l":"‰∏úÈÉäËÆ∞ÂøÜ","trans":"üöó ÊâìËΩ¶","imgs":[],"lt":""},{"t":"15:00","tit":"Âª∫ËÆæË∑ØÂ∞èÂêÉË°ó","desc":"ÂÖ®ÊàêÈÉΩÊéíÈòüÊúÄÁã†ÁöÑÂ∞èÂêÉË°ó„ÄÇ\nÊé®ËçêÔºöÁÉ§Áå™ËπÑ„ÄÅÈîÖÂ∑¥ÂúüË±Ü„ÄÅÈ∏°ÁøÖÂåÖËÇ•ËÇ†„ÄÇ\nÂª∫ËÆÆÔºö‰∏§‰∏™‰∫∫ÂàÜÂ§¥ÊéíÈòüÔºåÊïàÁéáÁøªÂÄç„ÄÇ","l":"Âª∫ËÆæË∑ØÂ∞èÂêÉË°ó","trans":"üö∂ Ê≠•Ë°å","imgs":[],"lt":""},{"t":"20:00","tit":"339ÁîµËßÜÂ°î","desc":"ÊàêÈÉΩÁöÑÂú∞Ê†áÂ°îÔºåÊôö‰∏ä‰∫ÆÁÅØÂæàÂ•ΩÁúã„ÄÇÈôÑËøëÊúâÂæàÂ§öÊ∏ÖÂêß„ÄÇ","l":"339ÁîµËßÜÂ°î","trans":"üöó ÊâìËΩ¶","imgs":[],"lt":""}]}]},
            {"id":"p1763829720206","name":"K: ÂéÜÂè≤ÊñáÂåñ","days":[{"title":"Ê≠¶‰æØÁ•† & Èî¶Èáå","items":[{"t":"13:00","tit":"Ê≠¶‰æØÁ•†","desc":"Á∫¢Â¢ôÁ´πÂΩ±ÔºåÈùûÂ∏∏ÊúâÂéÜÂè≤ÊÑü„ÄÇ\nÈÄÇÂêàÊÖ¢ÊÖ¢ÈÄõÔºåÂê¨Âê¨ËÆ≤Ëß£„ÄÇ","l":"Ê≠¶‰æØÁ•†","trans":"üöó ÊâìËΩ¶","imgs":[],"lt":""},{"t":"16:00","tit":"Èî¶ÈáåÂè§Ë°ó","desc":"Â∞±Âú®Ê≠¶‰æØÁ•†ÈöîÂ£Å„ÄÇ\nÂª∫ËÆÆÔºöÂÇçÊôöÂéªÔºåÁ∫¢ÁÅØÁ¨º‰∫ÆËµ∑Êù•ÂæàÁæé„ÄÇÂ∞èÂêÉÂÅèË¥µÔºåÂ∞ùÂ∞ùÂ∞±Ë°å„ÄÇ","l":"Èî¶ÈáåÂè§Ë°ó","trans":"üö∂ Ê≠•Ë°å","imgs":[],"lt":""},{"t":"19:00","tit":"Ëä≥ËçâË°ó","desc":"Á¶ªÈî¶Èáå‰∏çËøúÔºåÂæàÂ§öÂæàÂ§öÂ•ΩÂêÉÁöÑËãçËùáÈ¶ÜÂ≠êÔºåÊØîÊôØÂå∫‰æøÂÆúÂ•ΩÂêÉ„ÄÇ","l":"Ëä≥ËçâË°ó","trans":"üö≤ ÂÖ±‰∫´ÂçïËΩ¶","imgs":[],"lt":""}]}]},
            {"id":"p_xhs_j_ren","name":"üî• L: J‰∫∫ÈúáÊíºÊîªÁï• (ÂÖ®4Â§©)","days":[
                {"title":"Day1: Êó∂Â∞ö‰∏éÂ§úÊôØ","items":[
                    {"t":"10:00","tit":"Êò•ÁÜôË∑Ø","desc":"ÊàêÈÉΩÊúÄÁπÅÂçéÁöÑÂïÜ‰∏öË°óÔºåÊâìÂç°Âú∞Ê†á„ÄÇ\nÊé®ËçêÁæéÈ£üÔºöË•øÊúàÂüéË∞≠Ë±ÜËä±ÔºàÂ∞èÂêÉÔºâ„ÄÇ","l":"Êò•ÁÜôË∑Ø","lt":"","imgs":[],"trans":"üöá Âú∞ÈìÅ2/3Âè∑Á∫ø"},
                    {"t":"11:30","tit":"IFSÂõΩÈôÖÈáëËûç‰∏≠ÂøÉ","desc":"ÂøÖÊâìÂç°ÔºöÁà¨Ê•ºÁÜäÁå´Ôºà7Ê•ºÁ©∫‰∏≠Ëä±Âõ≠Ôºâ„ÄÇ\nÂèØ‰ª•ÊãçÂà∞ÁÜäÁå´Ê≠£ËÑ∏„ÄÇ","l":"ÊàêÈÉΩIFS","lt":"","imgs":[],"trans":"üö∂ Ê≠•Ë°å"},
                    {"t":"13:00","tit":"Â§™Âè§Èáå & Â§ßÊÖàÂØ∫","desc":"Êó∂Â∞ö‰∏éÂè§ËÄÅÁªìÂêà„ÄÇÂ§ßÊÖàÂØ∫Â∞±Âú®Â§™Âè§ÈáåÈáåÈù¢ÔºåÁ∫¢Â¢ôÊãçÁÖßÂæàÂ•ΩÁúã„ÄÇ\nÂçàÈ§êÂèØ‰ª•Âú®ÈôÑËøëËß£ÂÜ≥„ÄÇ","l":"ËøúÊ¥ãÂ§™Âè§Èáå","lt":"","imgs":[],"trans":"üö∂ Ê≠•Ë°å"},
                    {"t":"16:00","tit":"ÊúõÂπ≥Ë°ó","desc":"Ê≤øÊ≤≥ÁöÑÁΩëÁ∫¢Ë°óÂå∫ÔºåÂæàÂ§öÂíñÂï°Â∫ó„ÄÅÈõÜÂ∏ÇÔºåÈÄÇÂêàCitywalk„ÄÇ","l":"ÊúõÂπ≥Ë°ó","lt":"","imgs":[],"trans":"üöó ÊâìËΩ¶/Ê≠•Ë°å"},
                    {"t":"19:30","tit":"ÂÆâÈ°∫ÂªäÊ°•","desc":"‰πùÁúºÊ°•ÈôÑËøëÔºåÁúãÂ§úÊôØÁªùÁªùÂ≠êÔºÅ\nÈÄÇÂêàÂêπÊôöÈ£éÔºåÂéªÈÖíÂêßË°óÂùêÂùê„ÄÇ","l":"ÂÆâÈ°∫ÂªäÊ°•","lt":"","imgs":[],"trans":"üö∂ Ê≤øÊ≤≥Ê≠•Ë°å"}
                ]},
                {"title":"Day2: ÁÜäÁå´‰∏éÂéÜÂè≤","items":[
                    {"t":"07:30","tit":"Â§ßÁÜäÁå´Âü∫Âú∞(ÂçóÈó®)","desc":"‚ö†Ô∏èÈáçÁÇπÔºö‰∏ÄÂÆöË¶ÅËµ∞ÂçóÈó®ÔºÅÊéíÈòü‰∫∫Â∞ë„ÄÇ\nÂøÖÁúãÔºöËä±Ëä±„ÄÅËêåÂÖ∞„ÄÇ\nÂª∫ËÆÆÊó©Ëµ∑ÔºåÁÜäÁå´‰∏äÂçàÊ¥ªË∑É„ÄÇ","l":"ÊàêÈÉΩÂ§ßÁÜäÁå´ÁπÅËÇ≤Á†îÁ©∂Âü∫Âú∞(ÂçóÈó®)","lt":"","imgs":[],"trans":"üöó ÊâìËΩ¶ÂâçÂæÄ"},
                    {"t":"12:30","tit":"ÊñáÊÆäÈô¢","desc":"ÂÖçÈó®Á•®„ÄÇÁ∫¢Â¢ôÊãçÁÖßÂá∫ÁâáÔºåÂèØ‰ª•Êë∏‚ÄúÁ¶è‚ÄùÂ≠ó„ÄÇ\nÂøÖÂêÉÔºöÈó®Âè£ÁöÑÂÆ´Âª∑Á≥ïÁÇπ„ÄÅÊ¥ûÂ≠êÂè£Âº†ËÄÅ‰∫åÂáâÁ≤â„ÄÇ","l":"ÊñáÊÆäÈô¢","lt":"","imgs":[],"trans":"üöá Âú∞ÈìÅ"},
                    {"t":"15:00","tit":"ÊùúÁî´ËçâÂ†Ç & Êµ£Ëä±Ê∫™","desc":"ÊÑüÂèóËØóÂú£ÊÉÖÊÄÄÔºåÁ∫¢Â¢ôÁ´πÊûóÂæàÁæé„ÄÇ\nÊµ£Ëä±Ê∫™ÂÖ¨Âõ≠Â∞±Âú®ÊóÅËæπÔºåÁéØÂ¢ÉÊ∏ÖÂπΩ„ÄÇ","l":"ÊùúÁî´ËçâÂ†Ç","lt":"","imgs":[],"trans":"üöó ÊâìËΩ¶"},
                    {"t":"17:30","tit":"Ê≠¶‰æØÁ•†","desc":"‰∏âÂõΩËø∑ÂøÖÂéªÔºåËëóÂêçÁöÑ‚ÄúÁ∫¢Â¢ôÁ´πÂΩ±‚ÄùÊú∫‰ΩçÂ∞±Âú®ËøôÈáå„ÄÇ","l":"Ê≠¶‰æØÁ•†","lt":"","imgs":[],"trans":"üöá Âú∞ÈìÅ/ÊâìËΩ¶"},
                    {"t":"19:30","tit":"Èî¶ÈáåÂè§Ë°ó","desc":"Â∞±Âú®Ê≠¶‰æØÁ•†ÈöîÂ£Å„ÄÇÊôö‰∏ä‰∫ÆÁÅØÂêéÂæàÊºÇ‰∫ÆÔºåÈÄÇÂêàÁúãÂ§úÊôØ„ÄÇ\nÂ∞èÂêÉÂÅèË¥µÔºåÂª∫ËÆÆÂè™ÈÄõ‰∏çÂêÉÊàñÂ∞ëÂêÉ„ÄÇ","l":"Èî¶ÈáåÂè§Ë°ó","lt":"","imgs":[],"trans":"üö∂ Ê≠•Ë°å"}
                ]},
                {"title":"Day3: ÊÖ¢Ê¥ª‰∏éÊñáËâ∫","items":[
                    {"t":"09:30","tit":"‰∫∫Ê∞ëÂÖ¨Âõ≠","desc":"ÂøÖÂÅöÔºöÈπ§È∏£Ëå∂Á§æÂñùÁõñÁ¢óËå∂Ôºå‰ΩìÈ™åÈááËÄ≥„ÄÇ\nÊÑüÂèóÊàêÈÉΩÁúüÊ≠£ÁöÑÊÖ¢ÁîüÊ¥ª„ÄÇ","l":"‰∫∫Ê∞ëÂÖ¨Âõ≠","lt":"","imgs":[],"trans":"üöá Âú∞ÈìÅ"},
                    {"t":"11:30","tit":"ÂÆΩÁ™ÑÂ∑∑Â≠ê","desc":"Ê†áÂøóÊÄßÊôØÁÇπÔºåÁúãÁúãËÄÅÂª∫Á≠ë„ÄÇ\n‰∫∫Â§öÂïÜ‰∏öÂåñÈáçÔºåÈÄõÈÄõÂ∞±Ë°å„ÄÇ","l":"ÂÆΩÁ™ÑÂ∑∑Â≠ê","lt":"","imgs":[],"trans":"üö∂ Ê≠•Ë°å"},
                    {"t":"14:00","tit":"ÊàêÈÉΩÂçöÁâ©È¶Ü","desc":"‚ö†Ô∏èÈúÄÊèêÂâçÂú®ÂÖ¨‰ºóÂè∑È¢ÑÁ∫¶ÔºÅ\nÈùûÂ∏∏ÂÄºÂæó‰∏ÄÁúãÔºå‰∫ÜËß£ÊàêÈÉΩÂéÜÂè≤ÊñáÂåñ„ÄÇ","l":"ÊàêÈÉΩÂçöÁâ©È¶ÜÊñ∞È¶Ü","lt":"","imgs":[],"trans":"üö∂ Ê≠•Ë°å"},
                    {"t":"16:30","tit":"‰∏úÈÉäËÆ∞ÂøÜ","desc":"ÊóßÂ∑•ÂéÇÊîπÂª∫ÁöÑÂàõÊÑèÂõ≠Âå∫ÔºåÂ∑•‰∏öÈ£éÊª°Êª°„ÄÇ\nÈùûÂ∏∏ÈÄÇÂêàÊãçÁÖßÔºåÊúâÂæàÂ§öÂ§çÂè§Ë£ÖÁΩÆ„ÄÇ","l":"‰∏úÈÉäËÆ∞ÂøÜ","lt":"","imgs":[],"trans":"üöó ÊâìËΩ¶"},
                    {"t":"18:30","tit":"Âª∫ËÆæË∑ØÂ∞èÂêÉË°ó","desc":"ÂêÉË¥ßÂ§©Â†ÇÔºÅ\nÊé®ËçêÔºöÁÉ§Áå™ËπÑ„ÄÅÈîÖÂ∑¥ÂúüË±Ü„ÄÅÈ∏°ÁøÖÂåÖËÇ•ËÇ†„ÄÇ\nÂª∫ËÆÆÔºö‰∏§‰∏™‰∫∫ÂàÜÂ§¥ÊéíÈòüÔºåÊïàÁéáÁøªÂÄç„ÄÇ","l":"Âª∫ËÆæË∑ØÂ∞èÂêÉË°ó","lt":"","imgs":[],"trans":"üöó ÊâìËΩ¶"},
                    {"t":"20:30","tit":"ÁéâÊûóË∑Ø","desc":"„ÄäÊàêÈÉΩ„ÄãÊ≠åÈáåÁöÑÂú∞Êñπ„ÄÇ\nÂæàÂ§öÂ∞èÈÖíÈ¶ÜÂíåBistroÔºåÊÑüÂèóÊàêÈÉΩÁöÑÁÉüÁÅ´Ê∞î„ÄÇ","l":"ÁéâÊûóË•øË∑Ø","lt":"","imgs":[],"trans":"üöó ÊâìËΩ¶"}
                ]},
                {"title":"Day4: ÈÉΩÊ±üÂ†∞‰∏ÄÊó•","items":[
                    {"t":"09:00","tit":"‰ª∞Â§©Á™ùÂπøÂú∫","desc":"ÊâìÂç°Ëø™‰∏ΩÁÉ≠Â∑¥ÂêåÊ¨æ‚ÄúËá™ÊãçÂ§ßÁÜäÁå´‚Äù„ÄÇ\nÂª∫ËÆÆÈ´òÈìÅÂùêÂà∞„ÄêÁ¶ªÂ†ÜÂÖ¨Âõ≠Á´ô„Äë„ÄÇ","l":"‰ª∞Â§©Á™ùÂπøÂú∫","lt":"","imgs":[],"trans":"üöÑ È´òÈìÅ"},
                    {"t":"10:30","tit":"ÁÜäÁå´Ë∞∑","desc":"ÂèØ‰ª•ÁúãÂà∞Êï£ÂÖªÁöÑÂ∞èÁÜäÁå´Ôºå‰∫∫ÊØîÂü∫Âú∞Â∞ëÂæàÂ§öÔºå‰ΩìÈ™åÊõ¥Â•Ω„ÄÇ","l":"ÁÜäÁå´Ë∞∑","lt":"","imgs":[],"trans":"üöó ÊâìËΩ¶"},
                    {"t":"13:00","tit":"ÁÅåÂéøÂè§Âüé","desc":"ÂêÉÂçàÈ•≠ÔºåÈÄõÂè§Âüé„ÄÇÊé®ËçêÔºöÂåóË°óÁ±≥Á∫ø„ÄÅÂè∂Â©ÜÂ©ÜË±ÜÊµÜÈ¶çÈ¶ç„ÄÇ","l":"ÁÅåÂéøÂè§Âüé","lt":"","imgs":[],"trans":"üöó ÊâìËΩ¶"},
                    {"t":"15:00","tit":"ÈÉΩÊ±üÂ†∞ÊôØÂå∫","desc":"‚ÄúÊãúÊ∞¥ÈÉΩÊ±üÂ†∞‚ÄùÔºåÈúáÊíºÁöÑÊ∞¥Âà©Â∑•Á®ã„ÄÇ\nÂª∫ËÆÆË∑ØÁ∫øÔºöÁ¶ªÂ†ÜÂÖ¨Âõ≠ÂÖ•Âè£Ëøõ -> ‰ºèÈæôËßÇ -> ÂÆùÁì∂Âè£ -> È£ûÊ≤ôÂ†∞ -> È±ºÂò¥ -> ÂÆâÊæúÁ¥¢Ê°•„ÄÇ","l":"ÈÉΩÊ±üÂ†∞ÊôØÂå∫","lt":"","imgs":[],"trans":"üö∂ Ê≠•Ë°å"},
                    {"t":"18:00","tit":"ÊñáÂ∫ôË°ó","desc":"ÊúâÂæàÂ§öÊóßÁâ©‰ª∂ÂíåÂ§çÂè§Â∫óÈì∫ÔºåÊãçÁÖßÂæàÊúâÊÑüËßâ„ÄÇ","l":"ÊñáÂ∫ôË°ó","lt":"","imgs":[],"trans":"üö∂ Ê≠•Ë°å"},
                    {"t":"20:00","tit":"ÂçóÊ°•","desc":"ÂøÖÁúãÔºÅÊôö‰∏äÂºÄÁÅØÂêéÁöÑ‚ÄúËìùÁúºÊ≥™‚ÄùÂ§úÊôØÔºåÈùûÂ∏∏ÈúáÊíº„ÄÇ","l":"ÂçóÊ°•","lt":"","imgs":[],"trans":"üö∂ Ê≠•Ë°å"}
                ]}
            ]},
            {"id":"p_citywalk_autumn","name":"M: üçÇ Èì∂ÊùèÁ∫¢Âè∂CitywalkÊï£Ê≠•ÊåáÂçó","days":[
                {"title":"ÈáëËâ≤ËÄÅË°óÂ∑∑ÂºÑ‰∏ÄÊó•Êº´Ê≠•","items":[
                    {"t":"10:00","tit":"ÊúõÊ±üÊ•ºÂÖ¨Âõ≠","desc":"‰ª•Ê∏ÖÂπΩÂè§ÈõÖÁöÑÊ∞õÂõ¥ÂºÄÂêØ‰∏ÄÂ§©ÁöÑÊº´Ê≠•„ÄÇËøôÈáåÊúâÊ†áÂøóÊÄßÁöÑÁ∫¢Â¢ôÁ´πÂΩ±ÔºåÂú®ÁßãÂ§©‰∏éÈáëÈªÑÁöÑÈì∂Êùè‰∫§ÁªáÔºåÂè§È£éÊ∞õÂõ¥ÊÑüÂçÅË∂≥„ÄÇ","l":"ÊúõÊ±üÊ•ºÂÖ¨Âõ≠","trans":"üöó ÊâìËΩ¶ÊàñÂÖ¨‰∫§Áõ¥Ëææ","imgs":[],"lt":""},
                    {"t":"12:30","tit":"ÂçàÈ§êÔºöÈì∂ÊùèË∑ØÂë®Ëæπ","desc":"Âú®ÂâçÂæÄÈì∂ÊùèË∑ØÁöÑÈÄî‰∏≠ÊàñÈôÑËøëÊâæ‰∏ÄÂÆ∂ÂÆâÈùôÁöÑÈ§êÂéÖÊàñÂíñÂï°È¶ÜÔºå‰∫´Âèó‰ºëÈó≤ÁöÑÂçàÈ§êÊó∂ÂÖâ„ÄÇ","l":"Èì∂ÊùèË∑ØÔºàÂë®ËæπÈ§êÂéÖÔºâ","trans":"üö∂ Ê≠•Ë°å","imgs":[],"lt":""},
                    {"t":"14:00","tit":"Èì∂ÊùèË∑ØÊº´Ê≠•","desc":"Êï¥Êù°Ë°óË¢´ÈáëÈªÑÁöÑÈì∂ÊùèÂè∂Ë¶ÜÁõñÔºåÁæéÂà∞ÂèëÂÖâ„ÄÇÂª∫ËÆÆÊîæÊÖ¢ËÑöÊ≠•ÔºåÊÑüÂèóËêΩÂè∂‰∏çÊâ´ÁöÑÊµ™Êº´ÔºåË∏©‰∏äÂéªÊ≤ôÊ≤ô‰ΩúÂìç„ÄÇ","l":"Èì∂ÊùèË∑Ø","trans":"üö∂ Ê≠•Ë°å","imgs":[],"lt":""},
                    {"t":"15:30","tit":"ÁôæËä±Â∑∑Êé¢Áßò","desc":"Â∞è‰ºó‰∏îÂÖÖÊª°ÁîüÊ¥ªÊ∞îÊÅØÁöÑÂ∑∑Â≠êÔºåÂ±ãÊ™ê‰∏ãÊåÇÊª°Ëó§ËîìÁßãÂè∂„ÄÇÂú®ËøôÈáåÂèØ‰ª•ÂÅ∂ÈÅáÊôíÂ§™Èò≥ÁöÑÁå´Áå´Ôºå‰ΩìÈ™åËÄÅÊàêÈÉΩÁöÑÊÖ¢ÁîüÊ¥ª„ÄÇ","l":"ÁôæËä±Â∑∑","trans":"üö∂ Ê≠•Ë°å","imgs":[],"lt":""},
                    {"t":"16:30","tit":"Èî¶Áª£Ê°•ËµèÊôØ","desc":"Ê°•ËæπÁöÑÊ¢ßÊ°êÂè∂‰∏éÈì∂ÊùèÂè∂ÂΩ¢ÊàêÂèåÊãºËâ≤ÊôØËßÇÔºåËßÜËßâÊïàÊûúÊûÅ‰Ω≥„ÄÇÁ¨îËÆ∞‰∏≠ÊèêÂà∞‰∏ãÂçà4ÁÇπÂÖâÂΩ±ÁªùÁæéÔºåÊòØÁªù‰Ω≥ÁöÑÊãçÁÖßÊó∂Èó¥„ÄÇ","l":"Èî¶Áª£Ê°•","trans":"üö∂ Ê≠•Ë°å","imgs":[],"lt":""},
                    {"t":"18:00","tit":"ÈùíÁæäÂÆ´ÂñùËå∂","desc":"Âú®Âè§ËÄÅÁöÑÈÅìËßÇ‰∏≠‰ºëÊÅØÔºåÁÇπ‰∏ÄÁ¢óÁõñÁ¢óËå∂ÔºåÊÑüÂèóÂè§Èì∂ÊùèÊ†ë‰∏ãÁöÑÁ¶ÖÊÑè„ÄÇËå∂Ë¥πÈÄöÂ∏∏Âè™ÈúÄ10ÂÖÉÔºåÈùûÂ∏∏‰ºëÈó≤„ÄÇ","l":"ÈùíÁæäÂÆ´","trans":"üöó ÊâìËΩ¶ÊàñÂÖ¨‰∫§","imgs":[],"lt":""},
                    {"t":"19:30","tit":"ÊôöÈ§êÔºöÊñáÊÆäÈô¢Âë®ËæπÁ¥†È£ü/Â∞èÂêÉ","desc":"ÊôöÈ§êÂèØÂú®ÈùíÁæäÂÆ´ÊàñÊñáÊÆäÈô¢Ôºà‰∏ã‰∏ÄÁ´ôÈôÑËøëÔºâÂë®ËæπÂØªÊâæÁâπËâ≤Â∞èÂêÉÊàñÁ¥†È£üÈ¶ÜÔºå‰ΩìÈ™å‰∏çÂêåÁöÑÊàêÈÉΩÂë≥ÈÅì„ÄÇ","l":"ÊñáÊÆäÈô¢Âë®ËæπÁæéÈ£ü","trans":"üö∂ Ê≠•Ë°å","imgs":[],"lt":""},
                    {"t":"20:30","tit":"ÊñáÊÆäÈô¢Â§úÊôØ/ËµèÁßãÊî∂Â∞æ","desc":"Á∫¢Â¢ôÈªõÁì¶‰∏éÂçÉÂπ¥Èì∂ÊùèÁõ∏ÈÖçÔºåÊòØÁßãÊó•Êµ™Êº´ÁöÑÂÆåÁæéÊî∂Â∞æ„ÄÇÂèØÂú®Ê≠§ÁªìÊùü‰∏ÄÂ§©ÁöÑËµèÁßãcitywalk„ÄÇ","l":"ÊñáÊÆäÈô¢","trans":"üö∂ Ê≠•Ë°å/ÊâìËΩ¶ËøîÁ®ã","imgs":[],"lt":""}
                ]}
            ]}
        ];

        const DEFAULT_PLANS = RAW_DATA.map(p => ({
            id: p.id,
            name: p.name,
            startDate: new Date().toISOString().split('T')[0],
            days: p.days.map((d, dIdx) => ({
                id: `d_${p.id}_${dIdx}`,
                customTitle: d.title,
                items: d.items.map((i, iIdx) => ({
                    id: `i_${p.id}_${dIdx}_${iIdx}`,
                    time: i.t,
                    title: i.tit,
                    description: i.desc,
                    location: extractLocation(i.l, i.tit),
                    type: detectType(i.tit, i.desc),
                    transportDetail: i.trans,
                    images: [],
                    skipMap: false 
                }))
            }))
        }));

        const STORAGE_KEY = 'chengdu_love_trip_data_v29';
        const savePlans = (plans) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(plans)); } catch (e) { console.error("Storage error"); } };
        const loadPlans = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || DEFAULT_PLANS; } catch { return DEFAULT_PLANS; } };
        const fileToBase64 = (file) => new Promise((resolve) => { const r = new FileReader(); r.onload = () => resolve(r.result); r.readAsDataURL(file); });

        // --- UTILS: AMAP ---
        const AMAP_KEY = '85b427e744386038421b5b0bdb657f30';
        
        const loadAMap = () => {
            if (window.AMap && window.AMap.Map) return Promise.resolve();
            if (window.__amap_init_promise) return window.__amap_init_promise;
            const promise = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `https://webapi.amap.com/maps?v=2.0&key=${AMAP_KEY}&plugin=AMap.Scale,AMap.ToolBar,AMap.Geocoder,AMap.Polyline,AMap.Marker,AMap.Weather,AMap.Geolocation,AMap.CitySearch`;
                script.onload = () => resolve();
                script.onerror = () => reject("Failed to load AMap");
                document.head.appendChild(script);
            });
            window.__amap_init_promise = promise;
            return promise;
        };

        const getAmapWeatherIcon = (type) => {
            if(!type) return 'üå§Ô∏è';
            if(type.includes('Êô¥')) return '‚òÄÔ∏è';
            if(type.includes('Èò¥') || type.includes('‰∫ë')) return '‚òÅÔ∏è';
            if(type.includes('Èõ®')) return 'üåßÔ∏è';
            if(type.includes('Èõ™')) return '‚ùÑÔ∏è';
            if(type.includes('Èõ∑')) return '‚õàÔ∏è';
            return 'üå§Ô∏è';
        };

        // --- COMPONENTS ---

        // NEW: Export Template Components
        const ExportItem = ({ item }) => (
            <div className={`relative flex gap-4 group mb-4 break-inside-avoid`}>
                <div className="flex flex-col items-center w-14 shrink-0 pt-2">
                    <span className="text-sm font-bold font-mono text-gray-800">{item.time}</span>
                    <div className="w-0.5 h-full bg-gray-200 mt-2 rounded-full" />
                </div>
                <div className="flex-1 bg-white rounded-2xl p-4 border border-gray-100 shadow-sm">
                    <div className="flex justify-between items-start mb-2">
                        <span className="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-[10px] font-bold uppercase">{item.type}</span>
                    </div>
                    <h3 className="font-bold text-lg mb-1 flex items-center gap-2 text-gray-900">{item.title} {item.skipMap && <span className="text-xs font-normal text-gray-400 bg-gray-100 px-1.5 rounded">ÊöÇÂÆö</span>}</h3>
                    <div className="flex items-center gap-1.5 text-xs text-gray-500 mb-3">
                        <MapPin size={12} />
                        <span className={item.skipMap ? "line-through opacity-50" : ""}>{item.location}</span>
                    </div>
                    {item.transportDetail && (
                        <div className="flex items-center gap-1.5 text-xs text-gray-500 mb-3">
                            <MoveVertical size={12} />
                            <span>{item.transportDetail}</span>
                        </div>
                    )}
                    <p className="text-sm text-gray-600 whitespace-pre-wrap leading-relaxed">{item.description}</p>
                    {item.images.length > 0 && (
                        <div className="mt-4 grid grid-cols-3 gap-2">
                            {item.images.map((img, idx) => (
                                <div key={idx} className="relative aspect-square rounded-lg overflow-hidden bg-gray-100">
                                    <img src={img} className="w-full h-full object-cover" />
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );

        const PlanExportView = ({ plan }) => {
            // Check if it's a single day or a full plan for the title
            const isSingleDay = !plan.name && plan.customTitle; 

            return (
                <div className="bg-[#F2F2F7] p-8 w-[600px] mx-auto min-h-screen">
                    <div className="text-center mb-10">
                        {isSingleDay ? (
                            <>
                                <h1 className="text-3xl font-bold text-gray-900 mb-2">{plan.customTitle}</h1>
                                <p className="text-gray-500">ÂçïÊó•Ë°åÁ®ãÊ∏ÖÂçï</p>
                            </>
                        ) : (
                            <>
                                <h1 className="text-3xl font-bold text-gray-900 mb-2">{plan.name}</h1>
                                <p className="text-gray-500">Ë°åÁ®ãËßÑÂàíÊ∏ÖÂçï</p>
                            </>
                        )}
                    </div>
                    
                    <div className="space-y-10">
                        {/* Render based on if it's a full plan (plan.days) or a single day (plan.items) */}
                        {(isSingleDay ? [{ customTitle: plan.customTitle, items: plan.items }] : plan.days).map((day, index) => (
                            <div key={day.id || index} className="relative">
                                <div className="flex items-center gap-4 mb-6">
                                    <div className="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold text-lg shadow-md z-10">
                                        Day {isSingleDay ? 1 : index + 1}
                                    </div>
                                    <div className="font-bold text-xl text-gray-800">{day.customTitle}</div>
                                    <div className="h-px bg-gray-300 flex-1 ml-4"></div>
                                </div>
                                <div className="pl-2">
                                    {day.items.map((item, idx) => (
                                        <ExportItem key={item.id} item={item} />
                                    ))}
                                    {day.items.length === 0 && <div className="text-center text-gray-400 py-4">Êú¨Êó•ÊöÇÊó†ÂÆâÊéí</div>}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="mt-12 text-center text-gray-400 text-sm border-t border-gray-200 pt-6">
                        Generated by XingChenAnPai
                    </div>
                </div>
            );
        };

        // 0. TimePicker Component (New Scrolling Design)
        const TimePicker = ({ value, onChange, onClose }) => {
            const [hour, setHour] = useState(parseInt(value.split(':')[0]) || 9);
            const [minute, setMinute] = useState(parseInt(value.split(':')[1]) || 0);
            const hours = Array.from({ length: 24 }, (_, i) => i);
            const minutes = Array.from({ length: 60 }, (_, i) => i);

            const handleConfirm = () => {
                const h = hour.toString().padStart(2, '0');
                const m = minute.toString().padStart(2, '0');
                onChange(`${h}:${m}`);
                onClose();
            };

            const hourRef = useRef(null);
            const minuteRef = useRef(null);

            // Auto scroll to current value
            useEffect(() => {
                if (hourRef.current) hourRef.current.scrollTop = hour * 40;
                if (minuteRef.current) minuteRef.current.scrollTop = minute * 40;
            }, []);

            return (
                <div className="fixed inset-0 z-[10001] flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm ui-control" onClick={onClose}>
                    <div className="bg-white w-full max-w-xs rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-[slideUp_0.2s_ease-out]" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg">ÈÄâÊã©Êó∂Èó¥</h3>
                            <button onClick={handleConfirm} className="text-ios-blue font-bold px-4 py-1 rounded-full bg-blue-50">Á°ÆÂÆö</button>
                        </div>
                        <div className="flex h-48 relative">
                            {/* Selection Highlight Bar */}
                            <div className="absolute inset-x-0 top-1/2 -translate-y-1/2 h-10 border-t border-b border-gray-200 pointer-events-none bg-gray-50/30"></div>
                            
                            {/* Hours Column */}
                            <div ref={hourRef} className="flex-1 overflow-y-auto no-scrollbar time-scroll-col text-center scroll-smooth" 
                                 onScroll={(e) => {
                                     const h = Math.round(e.target.scrollTop / 40);
                                     if(h >=0 && h<=23) setHour(h);
                                 }}>
                                <div className="h-[80px]"></div> 
                                {hours.map(h => (
                                    <div key={h} className={`h-10 flex items-center justify-center text-lg transition-all ${h === hour ? 'text-black font-bold scale-110' : 'text-gray-300'}`}>
                                        {h.toString().padStart(2, '0')}
                                    </div>
                                ))}
                                <div className="h-[80px]"></div>
                            </div>

                            <div className="w-4 flex items-center justify-center font-bold pb-1 text-gray-400">:</div>

                            {/* Minutes Column */}
                            <div ref={minuteRef} className="flex-1 overflow-y-auto no-scrollbar time-scroll-col text-center scroll-smooth" 
                                 onScroll={(e) => {
                                     const m = Math.round(e.target.scrollTop / 40);
                                     if(m >=0 && m<=59) setMinute(m);
                                 }}>
                                <div className="h-[80px]"></div>
                                {minutes.map(m => (
                                    <div key={m} className={`h-10 flex items-center justify-center text-lg transition-all ${m === minute ? 'text-black font-bold scale-110' : 'text-gray-300'}`}>
                                        {m.toString().padStart(2, '0')}
                                    </div>
                                ))}
                                <div className="h-[80px]"></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 1. WeatherWidget (AMap Official + Robust Fallback)
        const WeatherWidget = ({ date, onWeatherUpdate }) => {
            const [weatherData, setWeatherData] = useState(null);
            const [location, setLocation] = useState({ id: 1, name: 'ÊàêÈÉΩ', adcode: '510100' });
            const [isSearching, setIsSearching] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const fetchWeather = (cityName) => {
                if (!window.AMap) return;
                setIsLoading(true);
                window.AMap.plugin('AMap.Weather', function() {
                    var weather = new window.AMap.Weather();
                    weather.getForecast(cityName, function(err, data) {
                        setIsLoading(false);
                        if (!err && data.forecasts && data.forecasts.length > 0) {
                            setWeatherData(data);
                            if(onWeatherUpdate) onWeatherUpdate({ location: location.name, weather: data.forecasts[0] });
                        }
                    });
                });
            };

            useEffect(() => {
                loadAMap().then(() => fetchWeather(location.name)).catch(console.error);
            }, []);

            const handleLocate = () => {
                setIsLoading(true);
                loadAMap().then(() => {
                    window.AMap.plugin('AMap.Geolocation', function() {
                        var geolocation = new window.AMap.Geolocation({
                            enableHighAccuracy: true,
                            timeout: 3000, 
                        });
                        geolocation.getCurrentPosition(function(status, result) {
                            if (status === 'complete') {
                                const comp = result.addressComponent;
                                let displayName = comp.district || '';
                                if (comp.township) displayName += ' ' + comp.township;
                                else if (comp.street) displayName += ' ' + comp.street;
                                if (!displayName) displayName = result.formattedAddress;

                                const newName = displayName;
                                setLocation({ name: newName, id: Date.now(), adcode: comp.adcode });
                                fetchWeather(comp.adcode); 
                            } else {
                                window.AMap.plugin('AMap.CitySearch', function() {
                                    var citySearch = new window.AMap.CitySearch();
                                    citySearch.getLocalCity(function(status, result) {
                                        if (status === 'complete' && result.info === 'OK') {
                                            const cityName = result.city; 
                                            setLocation({ name: cityName, id: Date.now(), adcode: result.adcode });
                                            fetchWeather(cityName);
                                        } else {
                                            alert("ÂÆö‰ΩçÂ§±Ë¥•ÔºåËØ∑ÊâãÂä®ËæìÂÖ•ÂüéÂ∏Ç");
                                            setIsLoading(false);
                                        }
                                    });
                                });
                            }
                        });
                    });
                });
            };

            const handleSearch = (e) => {
                e.preventDefault();
                if(!searchQuery.trim()) return;
                setIsLoading(true);
                setLocation(prev => ({ ...prev, name: searchQuery }));
                fetchWeather(searchQuery);
                setIsSearching(false);
            };

            return (
                <div className="glass-card p-5 rounded-3xl mb-6 text-ios-text relative overflow-hidden group transition-all">
                    <div className="flex justify-between items-start mb-4">
                        <div onClick={() => setIsSearching(!isSearching)} className="cursor-pointer">
                            <div className="flex items-center gap-1.5">
                                <MapPin size={14} className="text-ios-blue"/>
                                <span className="font-bold truncate max-w-[180px]">{location.name}</span>
                                {isLoading && <Loader2 size={12} className="animate-spin text-gray-400"/>}
                            </div>
                            <div className="text-xs text-ios-subtext mt-0.5">{new Date(date).toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' })}</div>
                        </div>
                        
                        {!isSearching && (
                            <div className="flex items-center gap-3 ui-control">
                                <div className="flex gap-2">
                                    <button onClick={handleLocate} className="p-2 bg-gray-100 rounded-full hover:bg-blue-50 text-gray-500 hover:text-blue-600 transition-colors" title="ÂÆö‰ΩçÂΩìÂâç‰ΩçÁΩÆ"><Navigation size={14}/></button>
                                    <button onClick={() => fetchWeather(location.name)} className="p-2 bg-gray-100 rounded-full hover:bg-blue-50 text-gray-500 hover:text-blue-600 transition-colors" title="Âà∑Êñ∞Â§©Ê∞î"><RotateCw size={14}/></button>
                                </div>
                                {weatherData && weatherData.forecasts && weatherData.forecasts[0] && (
                                    <div className="text-right">
                                        <div className="text-3xl font-bold">
                                            {weatherData.forecasts[0].dayTemp}¬∞ <span className="text-lg text-ios-subtext">/ {weatherData.forecasts[0].nightTemp}¬∞</span>
                                        </div>
                                        <div className="text-sm opacity-80">{weatherData.forecasts[0].dayWeather}</div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {!isSearching && weatherData && weatherData.forecasts && (
                        <div className="mt-4 pt-4 border-t border-gray-100/50">
                            <div className="flex gap-6 overflow-x-auto no-scrollbar pb-2">
                                {weatherData.forecasts.map((day, i) => {
                                    const dateObj = new Date(day.date);
                                    const dayName = i === 0 ? '‰ªäÂ§©' : i === 1 ? 'ÊòéÂ§©' : dateObj.toLocaleDateString('zh-CN', {weekday: 'short'});
                                    return (
                                        <div key={i} className={`flex flex-col items-center shrink-0 space-y-1 ${i === 0 ? 'opacity-100 scale-110 font-bold' : 'opacity-60'}`}>
                                            <span className="text-[10px] uppercase">{dayName}</span>
                                            <span className="text-2xl drop-shadow-sm">{getAmapWeatherIcon(day.dayWeather)}</span>
                                            <span className="text-xs whitespace-nowrap">{day.dayTemp}¬∞/{day.nightTemp}¬∞</span>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {isSearching && (
                        <div className="absolute inset-0 bg-white/95 z-20 p-4 flex flex-col">
                            <form onSubmit={handleSearch} className="flex gap-2 mb-4">
                                <input className="flex-1 bg-gray-100 rounded-xl px-4 py-2 text-sm" placeholder="ËæìÂÖ•ÂüéÂ∏Ç..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} autoFocus/>
                                <button type="button" onClick={() => setIsSearching(false)} className="p-2"><X size={16}/></button>
                            </form>
                            <div className="text-xs text-gray-400 text-center mt-4">ÊåâÂõûËΩ¶ÊêúÁ¥¢ (Êï∞ÊçÆÊù•Ê∫ê: È´òÂæ∑)</div>
                        </div>
                    )}
                </div>
            );
        };

        const ScheduleView = ({ day, isEditing, onUpdateDay, onImageUpload, setIsEditing }) => {
            const fileInputRefs = useRef({});
            const [timePickerTarget, setTimePickerTarget] = useState(null);

            const updateItem = (id, field, val) => onUpdateDay({ ...day, items: day.items.map(i => i.id === id ? { ...i, [field]: val } : i) });
            
            return (
                <div className="space-y-6 pb-24 relative">
                    {day.items.map((item, index) => (
                        <React.Fragment key={item.id}>
                            <div className={`relative flex gap-4 group ${item.skipMap ? 'opacity-70' : ''}`}>
                                <div className="flex flex-col items-center w-14 shrink-0 pt-2">
                                    {isEditing ? (
                                        <div 
                                            className="w-full text-sm font-bold bg-white border border-blue-300 rounded px-1 py-1 text-center cursor-pointer hover:bg-blue-50 text-ios-blue"
                                            onClick={() => setTimePickerTarget({ id: item.id, value: item.time })}
                                        >
                                            {item.time}
                                        </div>
                                    ) : (
                                        <span className="text-sm font-bold font-mono">{item.time}</span>
                                    )}
                                    <div className="w-0.5 h-full bg-gray-200 mt-2 rounded-full group-last:hidden" />
                                </div>
                                <div className={`flex-1 glass-card rounded-2xl p-4 transition-all ${isEditing ? 'border border-dashed border-ios-blue/50' : 'border-transparent border'}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-[10px] font-bold uppercase">{item.type}</span>
                                        {isEditing && (
                                            <div className="flex gap-2">
                                                <label className="flex items-center gap-1 cursor-pointer bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">
                                                    <input type="checkbox" checked={!!item.skipMap} onChange={(e) => updateItem(item.id, 'skipMap', e.target.checked)} className="rounded text-blue-500 focus:ring-0"/>
                                                    <span className="text-[10px] font-bold text-gray-600">ÊöÇÂÆö</span>
                                                </label>
                                                <button onClick={() => { if(confirm("Âà†Èô§?")) onUpdateDay({...day, items: day.items.filter(i => i.id !== item.id)}) }} className="text-red-400"><Trash2 size={14}/></button>
                                            </div>
                                        )}
                                    </div>
                                    {isEditing ? <input value={item.title} onChange={e => updateItem(item.id, 'title', e.target.value)} className="w-full font-bold text-lg bg-white/50 rounded mb-1" placeholder="Ê†áÈ¢ò" /> : <h3 className="font-bold text-lg mb-1 flex items-center gap-2">{item.title} {item.skipMap && <span className="text-xs font-normal text-gray-400 bg-gray-100 px-1.5 rounded">ÊöÇÂÆö</span>}</h3>}
                                    <div className="flex items-center gap-1.5 text-xs text-ios-subtext mb-1">
                                        {item.skipMap ? <MapPinOff size={12} className="text-gray-300"/> : <MapPin size={12} className={isEditing ? "text-ios-blue" : ""}/>}
                                        {isEditing ? <input value={item.location} onChange={e => updateItem(item.id, 'location', e.target.value)} className="bg-white/50 rounded w-full" placeholder={item.skipMap ? "ÊöÇ‰∏çÂÆö‰ΩçÔºå‰ªÖÂÅöËÆ∞ÂΩï" : "Âú∞ÂõæÊêúÁ¥¢ÂÖ≥ÈîÆËØç"} disabled={item.skipMap} /> : <span className={item.skipMap ? "line-through opacity-50" : ""}>{item.location}</span>}
                                    </div>
                                    
                                    {/* NEW TRANSPORT DETAIL INPUT */}
                                    {isEditing && (
                                        <div className="flex items-center gap-1.5 text-xs text-ios-subtext mb-3">
                                            <MoveVertical size={12} className="text-gray-500" />
                                            <input 
                                                value={item.transportDetail} 
                                                onChange={e => updateItem(item.id, 'transportDetail', e.target.value)} 
                                                className="bg-white/50 border border-gray-200 rounded w-full p-1 text-xs text-gray-700" 
                                                placeholder="‰∫§ÈÄöÂ§áÊ≥® (e.g., Âú∞ÈìÅ2Âè∑Á∫ø/ÊâìËΩ¶/Ê≠•Ë°å)" 
                                            />
                                        </div>
                                    )}
                                    {/* ---------------------------------- */}
                                    
                                    {isEditing ? <textarea value={item.description} onChange={e => updateItem(item.id, 'description', e.target.value)} className="w-full text-sm bg-white/50 rounded min-h-[60px]" placeholder={item.skipMap ? "Âú®Ê≠§Â§áÊ≥®ÊöÇÂÆöÂéüÂõ†..." : "Ê∑ªÂä†ÊèèËø∞..."}/> : <p className="text-sm text-ios-subtext whitespace-pre-wrap leading-relaxed">{item.description}</p>}
                                    <div className="mt-4 grid grid-cols-3 gap-2">
                                        {item.images.map((img, idx) => (
                                            <div key={idx} className="relative aspect-square rounded-lg overflow-hidden bg-gray-100"><img src={img} className="w-full h-full object-cover" />{isEditing && <button onClick={() => updateItem(item.id, 'images', item.images.filter((_, i) => i !== idx))} className="absolute top-0.5 right-0.5 bg-black/50 text-white p-0.5 rounded-full"><Trash2 size={10}/></button>}</div>
                                        ))}
                                        {isEditing && <button onClick={() => fileInputRefs.current[item.id]?.click()} className="aspect-square rounded-lg border-2 border-dashed flex flex-col items-center justify-center text-gray-400"><Camera size={20}/><span className="text-[10px]">Ê∑ªÂä†</span></button>}
                                        <input type="file" className="hidden" multiple accept="image/*" ref={el => fileInputRefs.current[item.id] = el} onChange={e => onImageUpload(item.id, e.target.files)} />
                                    </div>
                                </div>
                            </div>
                        </React.Fragment>
                    ))}
                    {isEditing && <button onClick={() => {
                        onUpdateDay({...day, items: [...day.items, { id: Date.now().toString(), time: '18:00', title: 'Êñ∞Ê¥ªÂä®', location: 'ÂæÖÂÆö', type: 'spot', images: [], skipMap: false }]});
                    }} className="w-full py-3 rounded-2xl border-2 border-dashed text-gray-400 font-bold hover:border-ios-blue hover:text-ios-blue transition-all">+ Ê∑ªÂä†Ê¥ªÂä®</button>}
                    
                    {/* TIME PICKER MODAL */}
                    {timePickerTarget && (
                        <TimePicker 
                            value={timePickerTarget.value} 
                            onChange={(newTime) => updateItem(timePickerTarget.id, 'time', newTime)}
                            onClose={() => setTimePickerTarget(null)}
                        />
                    )}
                </div>
            );
        };

        const TrafficView = ({ day }) => {
            const mapContainerRef = useRef(null);
            const mapInstance = useRef(null);
            const geoCache = useRef({}); 
            const markersRef = useRef({}); // New: Store markers for clicking
            const [status, setStatus] = useState({ total: 0, current: 0, msg: '', done: true });
            const [validCount, setValidCount] = useState(0);
            const [mapError, setMapError] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [resolvedCoords, setResolvedCoords] = useState({}); 
            const [failedLocs, setFailedLocs] = useState(new Set());

            useEffect(() => {
                const initMap = async () => {
                    try {
                        await loadAMap();
                        if (!window.AMap) throw new Error("AMap not found");
                        
                        if (!mapInstance.current && mapContainerRef.current) {
                            mapInstance.current = new window.AMap.Map(mapContainerRef.current, { 
                                zoom: 11, 
                                center: [104.06, 30.67],
                                viewMode: '2D',
                                features: ['bg', 'road', 'building', 'point'],
                                showLabel: true,
                                preserveDrawingBuffer: true
                            });
                            mapInstance.current.addControl(new window.AMap.Scale());
                            mapInstance.current.addControl(new window.AMap.ToolBar({ position: 'RB', offset: new window.AMap.Pixel(10, 20) }));
                        }
                        setIsLoading(false);
                        updateMapMarkers();
                    } catch(e) {
                        console.error(e);
                        setMapError(true);
                        setErrorMessage(e.message);
                        setIsLoading(false);
                    }
                };
                initMap();
            }, [day]);

            const updateMapMarkers = async () => {
                if (!mapInstance.current || !window.AMap) return;
                const map = mapInstance.current;
                const AMap = window.AMap;
                map.clearMap();
                markersRef.current = {}; // Reset markers cache
                
                if (!AMap.Geocoder) await new Promise(r => AMap.plugin('AMap.Geocoder', r));
                const geocoder = new AMap.Geocoder({ city: "ÊàêÈÉΩ" });

                const items = day.items;
                setStatus({ total: items.length, current: 0, msg: 'ÂºÄÂßã...', done: false });
                const coords = [];
                const newResolvedCoords = {}; 
                const failures = new Set();

                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    setStatus(prev => ({ ...prev, current: i + 1, msg: item.location }));
                    
                    if (item.skipMap) continue;

                    const isVague = /(ÈÖíÂ∫ó|‰ΩèÂÆø|ÂêÉÈ•≠|ÂçàÈ§ê|ÊôöÈ§ê|ÂæÖÂÆö|‰ºëÊÅØ|ËøîÁ®ã|Áù°Ëßâ|ÊöÇÂÆö)/.test(item.location) && item.location.length < 5;
                    if (isVague) continue;

                    try {
                        let loc = null;
                        if (geoCache.current[item.location]) {
                            loc = geoCache.current[item.location];
                        } else if (/^\d+(\.\d+)?,\s*\d+(\.\d+)?$/.test(item.location)) {
                             const [lng, lat] = item.location.split(',').map(Number);
                             loc = [lng, lat];
                             geoCache.current[item.location] = loc;
                        } else {
                            await new Promise(r => setTimeout(r, 150)); 
                            const result = await new Promise(r => geocoder.getLocation(item.location, (s, res) => r(s === 'complete' ? res : null)));
                            if (result && result.geocodes.length) {
                                loc = [result.geocodes[0].location.lng, result.geocodes[0].location.lat];
                                geoCache.current[item.location] = loc; 
                            } else {
                                failures.add(item.id);
                            }
                        }

                        if (loc) {
                            coords.push(loc);
                            newResolvedCoords[item.id] = { lng: loc[0], lat: loc[1], name: item.location }; 
                            const content = `<div style="display:flex;flex-direction:column;align-items:center;"><div style="background:#007AFF;color:white;font-size:10px;padding:2px 6px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">${i+1}.${item.title}</div><div style="width:10px;height:10px;background:#007AFF;border:2px solid white;border-radius:50%;"></div></div>`;
                            const marker = new AMap.Marker({ 
                                position: loc, 
                                content, 
                                anchor: 'bottom-center', 
                                offset: new AMap.Pixel(0, 0), 
                                zIndex: 100 + i 
                            });
                            map.add(marker);
                            markersRef.current[item.id] = marker; // Store reference
                        }
                    } catch (e) { failures.add(item.id); }
                }

                if (coords.length > 1) {
                    map.add(new AMap.Polyline({ path: coords, strokeColor: "#007AFF", strokeWeight: 8, isOutline: true, outlineColor: '#fff', showDir: true, zIndex: 50 }));
                }
                if (coords.length) map.setFitView(null, false, [40, 40, 40, 40]);
                
                setStatus(prev => ({ ...prev, done: true }));
                setValidCount(coords.length);
                setResolvedCoords(newResolvedCoords); 
                setFailedLocs(failures);
            };

            const focusMarker = (id) => {
                const marker = markersRef.current[id];
                if (marker && mapInstance.current) {
                    mapInstance.current.setZoomAndCenter(16, marker.getPosition());
                }
            };

            const getNextValidIndex = (currentIndex, items) => {
                for (let i = currentIndex + 1; i < items.length; i++) {
                    const item = items[i];
                    const isVague = /(ÈÖíÂ∫ó|‰ΩèÂÆø|ÂêÉÈ•≠|ÂçàÈ§ê|ÊôöÈ§ê|ÂæÖÂÆö|‰ºëÊÅØ|ËøîÁ®ã|Áù°Ëßâ|ÊöÇÂÆö)/.test(item.location) && item.location.length < 5;
                    if (!item.skipMap && !isVague && !failedLocs.has(item.id)) {
                        return i;
                    }
                }
                return -1;
            };

            const handleRetry = () => { window.location.reload(); };
            const openFullMap = () => { const query = day.items.map(i => i.location).filter(l => l && l !== 'ÂæÖÂÆö').join('|'); window.open(`https://www.amap.com/search?query=${encodeURIComponent(query)}`, '_blank'); };
            const forceCenter = () => { if(mapInstance.current) mapInstance.current.setFitView(null, false, [40, 40, 40, 40]); };

            return (
                <div className="flex flex-col w-full md:h-full">
                    <div className="w-full h-[40vh] md:h-1/2 md:flex-1 shrink-0 relative bg-gray-100 rounded-3xl overflow-hidden shadow-inner border border-white/50 isolate group">
                        <div ref={mapContainerRef} className="w-full h-full absolute inset-0 z-0 bg-[#f5f5f5]" />
                        
                        {mapError && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-500 bg-gray-50 z-20 p-4 text-center">
                                <MapIcon size={48} className="mb-2 opacity-20 text-red-500" />
                                <p className="font-bold text-lg mb-1 text-gray-700">Âú∞ÂõæÂä†ËΩΩÂ§±Ë¥•</p>
                                <div className="flex gap-2">
                                    <button onClick={handleRetry} className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 shadow-sm rounded-full text-sm font-bold text-gray-800 hover:bg-gray-100 active:scale-95 transition-all"><RefreshCw size={14} /> ÈáçËØï</button>
                                    <button onClick={openFullMap} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white shadow-sm rounded-full text-sm font-bold hover:bg-blue-700 active:scale-95 transition-all"><ExternalLink size={14} /> ÊâìÂºÄÈ´òÂæ∑</button>
                                </div>
                            </div>
                        )}
                        {isLoading && !mapError && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center bg-gray-50/80 backdrop-blur-sm z-20">
                                <Loader2 className="w-8 h-8 text-ios-blue animate-spin mb-2" />
                                <p className="text-xs text-ios-subtext font-medium">Ê≠£Âú®ËøûÊé•È´òÂæ∑Âú∞Âõæ...</p>
                            </div>
                        )}
                        <div className="absolute top-4 right-4 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                             <button onClick={forceCenter} className="bg-white p-2 rounded-lg shadow-md text-gray-600 hover:text-blue-600 active:scale-95 transition-transform" title="ÈáçÊñ∞ËÅöÁÑ¶"><LocateFixed size={20}/></button>
                        </div>
                        <div className="absolute bottom-2 right-2 bg-white/80 px-2 py-1 rounded text-[10px] z-20 shadow-sm">Â∑≤ËøûÊé• {validCount} ÁÇπ</div>
                    </div>
                    
                    <div className="mt-4 px-2 md:px-4 md:pb-4 md:max-h-[25vh] md:overflow-y-auto custom-scrollbar shrink-0 bg-white z-10">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="font-bold text-gray-400 text-xs uppercase tracking-wider">‰ªäÊó•Ë∑ØÁ∫ø</h3>
                            <button onClick={openFullMap} className="flex items-center gap-1 text-[10px] text-ios-blue font-bold bg-blue-50 px-2 py-1 rounded hover:bg-blue-100 transition-colors">ÊâìÂºÄÈ´òÂæ∑ APP <ExternalLink size={10} /></button>
                        </div>
                        <div className="space-y-3 pb-8 md:pb-0">
                            {day.items.map((item, idx) => {
                                if (item.skipMap) return null;

                                const isFailed = failedLocs.has(item.id);
                                const nextValidIdx = getNextValidIndex(idx, day.items);
                                const showNavButton = nextValidIdx !== -1 && !isFailed;
                                const startCoords = resolvedCoords[item.id];
                                const endCoords = showNavButton ? resolvedCoords[day.items[nextValidIdx].id] : null;
                                const canNav = startCoords && endCoords;

                                return (
                                    <React.Fragment key={item.id}>
                                        <div 
                                            onClick={() => !isFailed && focusMarker(item.id)}
                                            className={`flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border group transition-colors cursor-pointer active:bg-blue-50 ${isFailed ? 'border-red-200 bg-red-50' : 'border-gray-100 hover:border-blue-200'} ${item.skipMap ? 'opacity-50 grayscale' : ''}`}
                                        >
                                            <div className="flex items-center gap-3 overflow-hidden">
                                                <div className={`w-6 h-6 shrink-0 rounded-full flex items-center justify-center text-xs font-bold border ${isFailed ? 'bg-red-100 text-red-600 border-red-200' : 'bg-blue-50 text-blue-600 border-blue-100'}`}>{idx + 1}</div>
                                                <div className="min-w-0 flex-1">
                                                    <div className="font-bold text-sm text-gray-800 truncate flex items-center">
                                                        {item.location} 
                                                        {item.skipMap && <span className="text-xs font-normal text-gray-400 ml-1">(ÊöÇÂÆö)</span>}
                                                        {isFailed && <span className="text-[10px] text-red-500 bg-red-100 px-1.5 rounded ml-2 flex items-center gap-0.5 border border-red-200"><AlertCircle size={10}/> ÈúÄ‰øÆÊîπ</span>}
                                                    </div>
                                                    <div className={`text-xs truncate ${isFailed ? 'text-red-400' : 'text-gray-400'}`}>{isFailed ? 'üìç Âú∞ÁÇπÊú™ÊâæÂà∞ÔºåËØ∑ÁÇπÂáªÁºñËæëËæìÂÖ•Ê≠£Á°ÆÂú∞ÂùÄ' : (item.transportDetail || 'ÂâçÂæÄÊ≠§Â§Ñ')}</div>
                                                </div>
                                            </div>
                                            <button onClick={(e) => { e.stopPropagation(); window.open(`https://www.amap.com/search?query=${item.location}`, '_blank'); }} className="p-2 text-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 shrink-0 transition-colors active:scale-90"><Navigation2 size={16} /></button>
                                        </div>
                                        
                                        {showNavButton && canNav && (
                                            <div className="flex justify-center -my-1.5 relative z-10">
                                                <button 
                                                    onClick={() => {
                                                        const uri = `https://uri.amap.com/navigation?from=${startCoords.lng},${startCoords.lat},${startCoords.name}&to=${endCoords.lng},${endCoords.lat},${endCoords.name}&mode=car&callnative=1`;
                                                        window.location.href = uri;
                                                    }} 
                                                    className="flex items-center gap-1 px-3 py-1 bg-white text-blue-600 rounded-full text-[10px] font-bold border border-blue-100 shadow-sm hover:bg-blue-50 hover:shadow-md transition-all"
                                                >
                                                    <ArrowDown size={10} /> ÂØºËà™Âà∞‰∏ã‰∏ÄÁ´ô
                                                </button>
                                            </div>
                                        )}
                                    </React.Fragment>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // NEW: Day Import Modal Component
        const DayImportModal = ({ dayData, plans, onConfirm, onCancel }) => {
            const [selectedPlanIdx, setSelectedPlanIdx] = useState(0);
            const [selectedDayIdx, setSelectedDayIdx] = useState(0);
            const [mode, setMode] = useState('append'); // 'new' or 'append'

            const targetPlan = plans[selectedPlanIdx];

            const handleAppend = () => {
                if (!targetPlan || targetPlan.days.length === 0) return alert("ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÊúâÊïàÁöÑÁõÆÊ†áÊñπÊ°àÂíåÊó•Êúü„ÄÇ");

                const targetPlanId = targetPlan.id;
                const targetDayId = targetPlan.days[selectedDayIdx].id;
                
                onConfirm({
                    type: 'append',
                    targetPlanId,
                    targetDayId,
                    newItems: dayData.items
                });
            };

            const handleNewPlan = () => {
                onConfirm({
                    type: 'new',
                    newDay: dayData
                });
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[10004] flex items-center justify-center p-4" onClick={onCancel}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative space-y-4" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-xl text-blue-600">ÂØºÂÖ•ÂçïÊó•Ë°åÁ®ã</h3>
                            <button onClick={onCancel} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                        </div>
                        
                        <p className="text-sm text-gray-700">ÊÇ®Ê≠£Âú®ÂØºÂÖ• **{dayData.customTitle || "Êú™ÂëΩÂêçÂçïÊó•Ë°åÁ®ã"}** ÁöÑÊâÄÊúâÊ¥ªÂä®„ÄÇ</p>

                        {/* MODE SELECTION */}
                        <div className="flex bg-gray-100 rounded-xl p-1 text-sm font-bold">
                            <button 
                                onClick={() => setMode('append')}
                                className={`flex-1 py-2 rounded-lg transition-colors ${mode === 'append' ? 'bg-white shadow-sm text-black' : 'text-gray-500'}`}
                            >
                                ËøΩÂä†Âà∞Áé∞ÊúâÊó•Êúü
                            </button>
                            <button
                                onClick={() => setMode('new')}
                                className={`flex-1 py-2 rounded-lg transition-colors ${mode === 'new' ? 'bg-white shadow-sm text-black' : 'text-gray-500'}`}
                            >
                                ÂàõÂª∫‰∏∫Êñ∞ÊñπÊ°à
                            </button>
                        </div>

                        {/* APPEND MODE UI */}
                        {mode === 'append' && (
                            <div className="space-y-4 pt-2">
                                <p className="text-xs text-gray-500">ÈÄâÊã©ÊÇ®ÊÉ≥Â∞ÜËøô‰∫õÊ¥ªÂä®ËøΩÂä†Âà∞Âì™‰∏™ÊñπÊ°àÁöÑÂì™‰∏ÄÂ§©Ôºö</p>
                                
                                <div>
                                    <label className="text-xs font-bold text-gray-600 block mb-1">ÁõÆÊ†áÊñπÊ°à</label>
                                    <select 
                                        value={selectedPlanIdx}
                                        onChange={e => { setSelectedPlanIdx(Number(e.target.value)); setSelectedDayIdx(0); }}
                                        className="w-full p-3 border border-gray-300 rounded-xl bg-gray-50 font-bold"
                                    >
                                        {plans.map((p, index) => (
                                            <option key={p.id} value={index}>{p.name}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="text-xs font-bold text-gray-600 block mb-1">ÁõÆÊ†áÊó•Êúü</label>
                                    <select 
                                        value={selectedDayIdx}
                                        onChange={e => setSelectedDayIdx(Number(e.target.value))}
                                        className="w-full p-3 border border-gray-300 rounded-xl bg-gray-50"
                                    >
                                        {targetPlan?.days.map((d, index) => (
                                            <option key={d.id} value={index}>{d.customTitle || `Day ${index + 1}`}</option>
                                        ))}
                                    </select>
                                </div>

                                <button onClick={handleAppend} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">
                                    ËøΩÂä†Âà∞ {targetPlan?.days[selectedDayIdx]?.customTitle || 'ÈÄâÂÆöÊó•Êúü'}
                                </button>
                            </div>
                        )}

                        {/* NEW PLAN MODE UI */}
                        {mode === 'new' && (
                            <div className="space-y-4 pt-2">
                                <p className="text-xs text-gray-500">Â∞ÜÂØºÂÖ•ÁöÑÂçïÊó•Ë°åÁ®ã‰øùÂ≠ò‰∏∫‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑÊñπÊ°à„ÄÇ</p>
                                <button onClick={handleNewPlan} className="w-full bg-black text-white py-3 rounded-xl font-bold hover:opacity-80">
                                    ÂàõÂª∫Êñ∞ÊñπÊ°à
                                </button>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const App = () => {
            const [plans, setPlans] = useState([]);
            const [activePlanIdx, setActivePlanIdx] = useState(0);
            const [dayIdx, setDayIdx] = useState(0);
            const [mode, setMode] = useState('schedule');
            const [isEditing, setIsEditing] = useState(false);
            const [menu, setMenu] = useState(null); 
            const [showDatePicker, setShowDatePicker] = useState(false);
            const [showTips, setShowTips] = useState(false);
            const [currentWeather, setCurrentWeather] = useState(null); 
            const [isExporting, setIsExporting] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [exportData, setExportData] = useState(null); 
            const [dayDataToImport, setDayDataToImport] = useState(null); // NEW: State for single day import

            const captureRef = useRef(null);
            const exportRef = useRef(null);

            useEffect(() => { setPlans(loadPlans()); }, []);
            useEffect(() => { if (plans.length) savePlans(plans); }, [plans]);

            if (!plans.length) return <div className="flex h-screen items-center justify-center"><Loader2 className="animate-spin"/></div>;
            
            const activePlan = plans[activePlanIdx];
            const activeDay = activePlan.days[dayIdx];
            
            let dateStr = "Êó•ÊúüÈîôËØØ";
            let activeDateObj = new Date();
            try {
                if(activePlan.startDate) {
                    activeDateObj = new Date(new Date(activePlan.startDate).getTime() + dayIdx * 86400000);
                    if(!isNaN(activeDateObj.getTime())) {
                        dateStr = activeDateObj.toLocaleDateString('zh-CN', {month:'short', day:'numeric', weekday:'short'});
                    }
                }
            } catch(e) {}

            const updatePlanName = (name) => {
                const newPlans = [...plans];
                newPlans[activePlanIdx].name = name;
                setPlans(newPlans);
            };

            // --- NEW: TRIGGER EXPORT (Handles both Plan and Day) ---
            const triggerExport = (type) => {
                setMenu(null);
                if (type === 'all') {
                    setExportData({
                        title: 'Â§á‰ªΩÊâÄÊúâÊï∞ÊçÆ',
                        desc: 'ÂåÖÂê´ÊâÄÊúâË°åÁ®ãÊñπÊ°àÔºåÂèØÁî®‰∫éÊÅ¢Â§ç„ÄÇ',
                        data: plans,
                        filename: `chengdu_backup_${new Date().toISOString().slice(0,10)}.json`
                    });
                } else if (type === 'current_day') {
                    // Exporting a single day
                    const dayToExport = activeDay.items.map(item => ({
                        t: item.time,
                        tit: item.title,
                        desc: item.description,
                        l: item.location,
                        trans: item.transportDetail,
                        imgs: item.images,
                        skipMap: item.skipMap
                    }));

                    setExportData({
                        title: `ÂàÜ‰∫´: ${activeDay.customTitle}`,
                        desc: '‰ªÖÂåÖÂê´ÂΩìÂâçÈÄâÂÆöÊó•ÊúüÔºàÂçïÊó•Ë°åÁ®ãÔºâÁöÑÊ¥ªÂä®ÂàóË°®„ÄÇ',
                        data: { 
                            customTitle: activeDay.customTitle, 
                            items: dayToExport 
                        },
                        filename: `day_export_${activePlan.name}_Day${dayIdx + 1}.json`
                    });

                } else {
                    // Exporting the entire current plan
                    setExportData({
                        title: `ÂàÜ‰∫´: ${activePlan.name}`,
                        desc: '‰ªÖÂåÖÂê´ÂΩìÂâçÊòæÁ§∫ÁöÑÊñπÊ°à„ÄÇ',
                        data: activePlan,
                        filename: `plan_${activePlan.name.replace(/\s+/g, '_')}.json`
                    });
                }
            };

            // --- NEW: GENERIC IMPORT PROCESSOR ---
            const processImport = (jsonContent) => {
                try {
                    const parsed = typeof jsonContent === 'string' ? JSON.parse(jsonContent) : jsonContent;

                    // --- CHECK 1: Single Day Import ---
                    if (parsed.items && !parsed.days) {
                        // Normalize single day structure to match internal Day object format
                        const normalizedDay = {
                            id: `d_${Date.now()}_import`,
                            customTitle: parsed.customTitle || parsed.title || "ÂØºÂÖ•ÁöÑÂçïÊó•Ë°åÁ®ã",
                            items: (parsed.items || []).map(i => ({
                                id: i.id || `i_${Date.now()}_${Math.random()}`,
                                time: i.time || i.t || "09:00",
                                title: i.title || i.tit || "Êú™ÂëΩÂêçÊ¥ªÂä®",
                                description: i.description || i.desc || "",
                                location: i.location || (i.l ? extractLocation(i.l, i.tit) : "ÂæÖÂÆö"),
                                type: i.type || detectType(i.title||i.tit||"", i.description||i.desc||""),
                                transportDetail: i.transportDetail || i.trans || "",
                                images: i.images || [],
                                skipMap: i.skipMap !== undefined ? i.skipMap : false
                            }))
                        };
                        setDayDataToImport(normalizedDay);
                        return true; // Stop here, go to DayImportModal
                    }


                    // --- CHECK 2: Full Plan or Full Backup Import ---
                    let newPlansToAdd = [];

                    // Helper to normalize a single plan object
                    const normalizePlan = (p) => {
                        return {
                            id: p.id || `p_${Date.now()}_${Math.random()}`,
                            name: (p.name || "ÂØºÂÖ•ÊñπÊ°à") + " (ÂØºÂÖ•)",
                            startDate: p.startDate || new Date().toISOString().split('T')[0],
                            days: (p.days || []).map((d, dIdx) => ({
                                id: d.id || `d_${Date.now()}_${dIdx}`,
                                customTitle: d.customTitle || d.title || `Day ${dIdx+1}`,
                                items: (d.items || []).map((i, iIdx) => ({
                                    id: i.id || `i_${Date.now()}_${dIdx}_${iIdx}`,
                                    // Handle both shorthand (RAW_DATA style) and full keys
                                    time: i.time || i.t || "09:00",
                                    title: i.title || i.tit || "Êú™ÂëΩÂêçÊ¥ªÂä®",
                                    description: i.description || i.desc || "",
                                    location: i.location || (i.l ? extractLocation(i.l, i.tit) : "ÂæÖÂÆö"),
                                    type: i.type || detectType(i.title||i.tit||"", i.description||i.desc||""),
                                    transportDetail: i.transportDetail || i.trans || "",
                                    images: i.images || [],
                                    skipMap: i.skipMap !== undefined ? i.skipMap : false
                                }))
                            }))
                        };
                    };

                    if (Array.isArray(parsed)) {
                         if (confirm("ËØÜÂà´Âà∞Â§öÊù°ÊñπÊ°àÊï∞ÊçÆ„ÄÇÁÇπÂáª[Á°ÆÂÆö]Ë¶ÜÁõñÂΩìÂâçÊâÄÊúâÊñπÊ°àÔºåÁÇπÂáª[ÂèñÊ∂à]‰ªÖËøΩÂä†Âà∞Áé∞ÊúâÂàóË°®„ÄÇ")) {
                             setPlans(parsed.map(normalizePlan));
                             setActivePlanIdx(0);
                             setDayIdx(0);
                             alert("Â∑≤Ë¶ÜÁõñÊâÄÊúâÊñπÊ°àÔºÅ");
                             return true;
                         } else {
                             newPlansToAdd = parsed.map(normalizePlan);
                         }
                    } else if (parsed.days) {
                        newPlansToAdd = [normalizePlan(parsed)];
                    } else {
                         alert("Êï∞ÊçÆÊ†ºÂºèÊó†Ê≥ïËØÜÂà´");
                         return false;
                    }

                    if (newPlansToAdd.length > 0) {
                        setPlans(prev => [...prev, ...newPlansToAdd]);
                        setActivePlanIdx(plans.length); 
                        setDayIdx(0);
                        alert(`ÊàêÂäüÂØºÂÖ• ${newPlansToAdd.length} ‰∏™ÊñπÊ°àÔºÅ`);
                        return true;
                    }
                } catch (e) {
                    console.error(e);
                    alert("ÂØºÂÖ•Â§±Ë¥•ÔºöÊï∞ÊçÆÊ†ºÂºèÈîôËØØ„ÄÇ\n" + e.message);
                    return false;
                }
            };


            // --- NEW: HANDLE DAY IMPORT FINALIZATION ---
            const handleDayImportFinalize = ({ type, targetPlanId, targetDayId, newItems, newDay }) => {
                const newPlans = [...plans];

                if (type === 'new') {
                    // Option 1: Create as a new plan
                    const newPlan = {
                        id: `p_${Date.now()}`,
                        name: newDay.customTitle,
                        startDate: new Date().toISOString().split('T')[0],
                        days: [
                            {
                                id: `d_${Date.now()}_0`,
                                customTitle: newDay.customTitle,
                                items: newDay.items
                            }
                        ]
                    };
                    newPlans.push(newPlan);
                    setActivePlanIdx(newPlans.length - 1);
                    setDayIdx(0);
                    alert(`Â∑≤ÂàõÂª∫Êñ∞ÊñπÊ°àÔºö${newDay.customTitle}`);

                } else if (type === 'append') {
                    // Option 2: Append to existing day
                    const planIdx = newPlans.findIndex(p => p.id === targetPlanId);
                    const dayIdx = newPlans[planIdx].days.findIndex(d => d.id === targetDayId);

                    if (planIdx !== -1 && dayIdx !== -1) {
                        const targetDay = newPlans[planIdx].days[dayIdx];
                        targetDay.items.push(...newItems);
                        
                        // Switch view to the modified day
                        setActivePlanIdx(planIdx);
                        setDayIdx(dayIdx);
                        alert(`Â∑≤ÊàêÂäüËøΩÂä† ${newItems.length} ‰∏™Ê¥ªÂä®Âà∞ ${targetDay.customTitle}`);
                    }
                }

                setPlans(newPlans);
                setDayDataToImport(null);
            };


            // --- EXISTING HANDLERS (RE-USED) ---

            const handleFileImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const success = processImport(event.target.result);
                    if (success && !dayDataToImport) setShowImportModal(false);
                };
                reader.readAsText(file);
            };

            const handleTextImport = (e) => {
                e.preventDefault();
                const text = e.target.elements.importText.value;
                if (!text.trim()) return;
                const success = processImport(text);
                if (success && !dayDataToImport) setShowImportModal(false);
            };

            // --- REVISED SCREENSHOT LOGIC ---
            const screenshot = async () => {
                setIsExporting(true);
                // Wait for the render to happen
                await new Promise(r => setTimeout(r, 800));

                try {
                    const target = exportRef.current;
                    if (!target) throw new Error("Export container not found");

                    // Set plan for single day export view (if sharing current day)
                    const isSingleDayExport = exportData && exportData.data.customTitle && !exportData.data.days;
                    const planToRender = isSingleDayExport ? exportData.data : activePlan;
                    
                    const canvas = await window.html2canvas(target, { 
                        scale: 2, 
                        useCORS: true, 
                        allowTaint: true,
                        logging: false,
                        backgroundColor: '#F2F2F7',
                        width: target.offsetWidth,
                        height: target.scrollHeight,
                        windowWidth: target.offsetWidth,
                        windowHeight: target.scrollHeight
                    });
                    
                    const link = document.createElement('a');
                    link.download = `Ë°åÁ®ãÈïøÂõæ-${planToRender.name || planToRender.customTitle}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } catch(e) { 
                    console.error(e);
                    alert("ÁîüÊàêÂ§±Ë¥•: " + e.message); 
                } finally {
                    setIsExporting(false);
                }
            };
            
            const handleAddDay = () => {
                const newPlans = [...plans];
                newPlans[activePlanIdx].days.push({ id: Date.now(), customTitle: `Day ${newPlans[activePlanIdx].days.length+1}`, items: [] });
                setPlans(newPlans);
                setDayIdx(newPlans[activePlanIdx].days.length - 1);
            };

            const handleDeleteDay = () => {
                if (activePlan.days.length <= 1) return alert("Ëá≥Â∞ë‰øùÁïô‰∏ÄÂ§©ÔºÅ");
                if (!confirm("Âà†Èô§ËøôÂ§©ÁöÑË°åÁ®ãÔºü")) return;
                const newPlans = [...plans];
                newPlans[activePlanIdx].days.splice(dayIdx, 1);
                setPlans(newPlans);
                setDayIdx(d => Math.max(0, d - 1));
            };

            const handleDeletePlan = () => {
                if (plans.length <= 1) return alert("Ëá≥Â∞ë‰øùÁïô‰∏Ä‰∏™ÊñπÊ°àÔºÅ");
                if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÊñπÊ°à \"${activePlan.name}\" ÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ`)) return;
                
                const newPlans = plans.filter((_, i) => i !== activePlanIdx);
                setPlans(newPlans);
                setActivePlanIdx(prev => Math.min(prev, newPlans.length - 1));
                setDayIdx(0);
                setMenu(null);
                alert("ÊñπÊ°àÂ∑≤Âà†Èô§");
            };

            const updateStartDate = (date) => {
                if(!date) return; 
                const newPlans = [...plans];
                newPlans[activePlanIdx].startDate = date;
                setPlans(newPlans);
                setShowDatePicker(false);
            };

            // DYNAMIC TIPS LOGIC
            const getTips = () => {
                const tips = [];

                if (currentWeather) {
                    const { weather } = currentWeather;
                    const maxTemp = parseInt(weather.dayTemp);
                    const minTemp = parseInt(weather.nightTemp);
                    const type = weather.dayWeather;
                    let diff = maxTemp - minTemp;

                    let clothingText = "";
                    if (minTemp < 10) {
                        clothingText = "ÁæΩÁªíÊúç„ÄÅÂéöÂ§ßË°£„ÄÅÂõ¥Â∑æ (Êó©ÊôöÂæàÂÜ∑ÔºåÈ£éÂæàÂ§ßÔºåËÆ∞ÂæóÂ§öÂ∏¶‰ª∂ÂéöÂ§ñÂ•óÂì¶)";
                    } else if (minTemp < 15) {
                        clothingText = "È£éË°£„ÄÅÂç´Ë°£„ÄÅËñÑÊØõË°£ (Ê¥ãËë±Á©øË°£Ê≥ïÔºåÁÉ≠‰∫ÜËÑ±ÂÜ∑‰∫ÜÁ©ø)";
                    } else if (minTemp < 22) {
                        clothingText = "ÈïøË¢ñTÊÅ§„ÄÅË°¨Ë°´„ÄÅÂçïË£§ (ËàíÈÄÇ‰∏∫‰∏ª)";
                    } else {
                        clothingText = "Áü≠Ë¢ñ„ÄÅË£ôÂ≠ê (ËÆ∞ÂæóÈò≤Êôí)";
                    }
                    
                    if (type.includes('Èõ®')) {
                        clothingText += "ÔºåËÆ∞ÂæóÁ©øÈò≤ÊªëÈò≤Ê∞¥ÁöÑÈûãÂ≠ê„ÄÇ";
                    }

                    tips.push({ 
                        title: "üëó Á©øË°£Êé®Ëçê", 
                        content: `${clothingText} (ÂΩìÂâçÈ¢ÑÊä•Ôºö${minTemp}¬∞-${maxTemp}¬∞)` 
                    });
                } else {
                    tips.push({ title: "üëó Á©øË°£Êé®Ëçê", content: "Ê≠£Âú®Ëé∑ÂèñÂÆûÊó∂Â§©Ê∞î‰ª•Êé®ËçêÁ©øË°£..." });
                }

                if (currentWeather && currentWeather.weather.dayWeather.includes('Èõ®')) {
                    tips.push({ title: "üåßÔ∏è ‰∏ãÈõ®Â§áÂøò", content: "ÂåÖÈáåÂæóÂ∏∏Â§á‰∏ÄÊääËΩª‰æøÊäòÂè†‰ºûÔºåÊó¢ËÉΩÈÅÆÈò≥ÂèàËÉΩÊå°Èõ®„ÄÇ" });
                }

                tips.push({ title: "üå∂Ô∏è ÊàêÈÉΩËÉÉ", content: "Â¶ÇÊûú‰∏çÂ§™ËÉΩÂêÉËæ£ÔºåÂèàÊÉ≥ËØïËØïÔºåÈÇ£Êàë‰ª¨Â∞±È∏≥È∏ØÈîÖÔºåÂÆûÂú®‰∏çË°åÂîØÊÄ°Ë±ÜÂ•∂Ëß£Ëæ£ÂìàÂìàÂìà" });
                tips.push({ title: "üêº ÁÜäÁå´Êó©Ëµ∑", content: "Ë≤å‰ººÁúãËä±Ëä±Âª∫ËÆÆÊó©‰∏ä7:30ÂâçÂà∞ÂçóÈó®ÊéíÈòüÔºåÊôö‰∫ÜÂè™ËÉΩÁúã‰∫∫Â§¥„ÄÇ" });
                tips.push({ title: "üëü ËàíÈÄÇÂá∫Ë°å", content: "Ë°åÁ®ãÂèØËÉΩË¶ÅËµ∞‰∏çÂ∞ëË∑ØÔºåÁ©øÂèåËàíÊúçÁöÑÂπ≥Â∫ïÈûãÂì¶„ÄÇÁ¥Ø‰∫ÜÊàë‰ª¨Â∞±Êâæ‰∏™Ëå∂È¶ÜÂùêÂùêÔºü" });

                return tips;
            };

            // MAIN LAYOUT WRAPPER (Target for PC screenshot - captureRef IS THE PARENT)
            return (
                <div className="h-screen w-full bg-[#F2F2F7] md:flex md:justify-center md:py-10">
                    <div ref={captureRef} className="w-full h-full md:max-w-6xl md:h-[90vh] md:flex md:gap-6 md:px-6">
                        {/* LEFT PANEL: Schedule */}
                        <div className="w-full md:max-w-md bg-white md:rounded-[40px] relative h-full flex flex-col overflow-hidden shadow-2xl">
                            <div className="relative z-50 p-6 pb-2 border-b border-gray-100 flex justify-between items-center ui-control bg-white">
                                <div>
                                    {isEditing ? (
                                        <input 
                                            value={activePlan.name} 
                                            onChange={(e) => updatePlanName(e.target.value)}
                                            className="font-bold text-xl bg-gray-50 border border-gray-200 p-1.5 -ml-1 rounded w-full max-w-[240px] text-ios-text focus:ring-2 ring-blue-500 outline-none"
                                        />
                                    ) : (
                                        <div onClick={() => setMenu('plans')} className="font-bold text-xl flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 -ml-1 rounded">{activePlan.name} <ChevronRight size={16}/></div>
                                    )}
                                    <div className="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                        <button onClick={() => setDayIdx(d => Math.max(0, d-1))} disabled={dayIdx===0}><ChevronLeft size={14}/></button>
                                        <span onClick={() => setShowDatePicker(true)} className="font-mono bg-gray-100 px-2 py-1 rounded cursor-pointer flex items-center gap-1 hover:bg-gray-200">{dateStr} <CalendarDays size={10}/></span>
                                        <button onClick={() => setDayIdx(d => Math.min(activePlan.days.length-1, d+1))} disabled={dayIdx===activePlan.days.length-1}><ChevronRight size={14}/></button>
                                        
                                        {/* NEW: Share Day Button */}
                                        {!isEditing && (
                                            <button onClick={() => triggerExport('current_day')} className="ml-2 px-2 py-1 bg-blue-50 text-blue-600 rounded-lg font-bold text-[10px] flex items-center gap-1 hover:bg-blue-100 transition-colors">
                                                <Share2 size={10} /> ÂàÜ‰∫´ÂΩìÂ§©
                                            </button>
                                        )}
                                        
                                        {/* Strict Edit Mode Controls */}
                                        {isEditing && (
                                            <>
                                                <div className="w-px h-3 bg-gray-300 mx-1"></div>
                                                <button onClick={handleAddDay} className="text-blue-500 p-1 hover:bg-blue-50 rounded"><Plus size={14}/></button>
                                                {activePlan.days.length > 1 && <button onClick={handleDeleteDay} className="text-red-400 p-1 hover:bg-red-50 rounded"><Trash2 size={14}/></button>}
                                            </>
                                        )}
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowTips(true)} className="p-2 bg-orange-50 text-orange-500 rounded-full hover:bg-orange-100"><Lightbulb size={18}/></button>
                                    <button onClick={() => setMode(m => m==='schedule'?'traffic':'schedule')} className="p-2 bg-gray-100 rounded-full md:hidden">{mode==='schedule'?<Map size={18}/>:<Calendar size={18}/>}</button>
                                    <button onClick={() => setMenu('settings')} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><Settings size={18}/></button>
                                </div>
                            </div>

                            <div className="flex-1 overflow-y-auto px-6 py-4 pb-24 md:custom-scrollbar">
                                <div className="md:hidden">
                                    <WeatherWidget date={activeDateObj.toISOString().split('T')[0]} onWeatherUpdate={setCurrentWeather} />
                                    {mode === 'schedule' ? 
                                        <ScheduleView day={activeDay} isEditing={isEditing} setIsEditing={setIsEditing} onUpdateDay={d => { const p = [...plans]; p[activePlanIdx].days[dayIdx] = d; setPlans(p); }} onImageUpload={async (id, fs) => {
                                            const imgs = []; for(let f of fs) imgs.push(await fileToBase64(f));
                                            const p = [...plans];
                                            const items = p[activePlanIdx].days[dayIdx].items;
                                            items.find(i=>i.id===id).images.push(...imgs);
                                            setPlans(p);
                                        }} /> 
                                    : <TrafficView day={activeDay} />}
                                </div>
                                <div className="hidden md:block">
                                     <ScheduleView day={activeDay} isEditing={isEditing} setIsEditing={setIsEditing} onUpdateDay={d => { const p = [...plans]; p[activePlanIdx].days[dayIdx] = d; setPlans(p); }} onImageUpload={async (id, fs) => {
                                            const imgs = []; for(let f of fs) imgs.push(await fileToBase64(f));
                                            const p = [...plans];
                                            const items = p[activePlanIdx].days[dayIdx].items;
                                            items.find(i=>i.id===id).images.push(...imgs);
                                            setPlans(p);
                                        }} />
                                </div>
                            </div>

                            <div className="absolute bottom-6 left-0 right-0 flex justify-center ui-control pointer-events-none z-40">
                                <button onClick={() => setIsEditing(!isEditing)} className="pointer-events-auto bg-black text-white px-6 py-3 rounded-full font-bold shadow-xl flex gap-2 items-center hover:scale-105 transition-transform">
                                    {isEditing ? <Check size={18}/> : <Edit3 size={18}/>} {isEditing ? 'ÂÆåÊàê' : 'ÁºñËæë'}
                                </button>
                            </div>
                        </div>

                        {/* RIGHT PANEL: Map (PC Only) */}
                        <div className="hidden md:flex flex-col flex-1 gap-6 h-full">
                            <WeatherWidget date={activeDateObj.toISOString().split('T')[0]} onWeatherUpdate={setCurrentWeather} />
                            <div className="flex-1 bg-white rounded-[40px] shadow-xl overflow-hidden p-1">
                                <TrafficView day={activeDay} />
                            </div>
                        </div>
                    </div>

                    {/* HIDDEN EXPORT CONTAINER (Uses PlanExportView which handles single day data) */}
                    {isExporting && (
                        <div className="fixed top-0 left-[-9999px] z-[-1]" ref={exportRef}>
                            <PlanExportView plan={exportData?.data || activePlan} />
                        </div>
                    )}
                    
                    {/* LOADING OVERLAY */}
                    {isExporting && (
                        <div className="fixed inset-0 z-[10002] bg-black/60 backdrop-blur-sm flex flex-col items-center justify-center text-white">
                            <Loader2 className="w-12 h-12 animate-spin mb-4" />
                            <p className="font-bold text-lg">Ê≠£Âú®ÁîüÊàêË°åÁ®ãÈïøÂõæ...</p>
                            <p className="text-sm opacity-70 mt-2">ÂåÖÂê´ÊâÄÊúâÂ§©Êï∞ÔºåËá™Âä®Â±ïÂºÄËØ¶ÊÉÖ</p>
                        </div>
                    )}

                    {/* MENUS - Z-Index 10000 (Fix Overlap) */}
                    {menu === 'plans' && (
                        <div className="fixed inset-0 bg-black/40 z-[10000] flex items-center justify-center p-8" onClick={() => setMenu(null)}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg">ÂàáÊç¢ÊñπÊ°à</h3>
                                    <button onClick={() => setMenu(null)} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                                </div>
                                <div className="max-h-[60vh] overflow-y-auto space-y-2">
                                    {plans.map((p, i) => (
                                        <button key={p.id} onClick={() => { setActivePlanIdx(i); setDayIdx(0); setMenu(null); }} className={`w-full text-left p-4 rounded-xl font-bold transition-colors ${activePlanIdx===i ? 'bg-black text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                                            {p.name} <span className="text-xs font-normal opacity-60 ml-2">{p.days.length}Â§©</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {menu === 'settings' && (
                        <div className="fixed inset-0 bg-black/40 z-[10000] flex items-center justify-center p-8" onClick={() => setMenu(null)}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl space-y-3 relative" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-bold text-lg">ËÆæÁΩÆ & Â§á‰ªΩ</h3>
                                    <button onClick={() => setMenu(null)} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                                </div>
                                {/* Note: 'current_day' export is now handled outside the settings menu for faster access */}
                                <button onClick={() => triggerExport('current')} className="w-full flex gap-3 items-center p-4 bg-blue-50 text-blue-600 rounded-xl font-bold hover:bg-blue-100"><Share2 size={18}/> ÂàÜ‰∫´ÂΩìÂâçÊñπÊ°à (ÂÖ®ÈÉ®)</button>
                                <button onClick={() => triggerExport('all')} className="w-full flex gap-3 items-center p-4 bg-gray-100 rounded-xl font-bold hover:bg-gray-200"><Copy size={18}/> Â§á‰ªΩÊâÄÊúâÊï∞ÊçÆ</button>
                                
                                <button onClick={() => { setMenu(null); setShowImportModal(true); }} className="w-full flex gap-3 items-center p-4 bg-blue-50 text-blue-600 rounded-xl font-bold hover:bg-blue-100 border border-blue-200"><Download size={18}/> ÂØºÂÖ•ÊñπÊ°à / ÊÅ¢Â§çÂ§á‰ªΩ</button>
                                
                                <hr className="border-gray-100"/>
                                <button onClick={handleDeletePlan} className="w-full flex gap-3 items-center p-4 bg-red-50 text-red-500 rounded-xl font-bold hover:bg-red-100"><Trash2 size={18}/> Âà†Èô§ÂΩìÂâçÊñπÊ°à</button>
                                <button onClick={screenshot} className="w-full flex gap-3 items-center p-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-bold hover:opacity-90 shadow-md"><Image size={18}/> ÁîüÊàêË°åÁ®ãÈïøÂõæ (ÂÖ®Ëßà)</button>
                                <button onClick={() => { if(confirm("Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÔºü")) { localStorage.clear(); location.reload(); }}} className="w-full flex gap-3 items-center p-4 bg-gray-100 text-gray-500 rounded-xl font-bold hover:bg-gray-200"><Trash2 size={18}/> ÈáçÁΩÆÊâÄÊúâÊï∞ÊçÆ</button>
                            </div>
                        </div>
                    )}

                    {/* NEW: IMPORT MODAL */}
                    {showImportModal && (
                        <div className="fixed inset-0 bg-black/40 z-[10003] flex items-center justify-center p-4" onClick={() => setShowImportModal(false)}>
                            <div className="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-lg flex items-center gap-2"><Download size={20}/> ÂØºÂÖ•Êï∞ÊçÆ</h3>
                                    <button onClick={() => setShowImportModal(false)} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                                </div>
                                
                                <div className="space-y-6">
                                    {/* Option 1: File Upload (Mobile Friendly) */}
                                    <div className="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                        <div className="font-bold text-blue-800 mb-2 flex items-center gap-2"><FileUp size={18}/> ÊñπÂºè1Ôºö‰∏ä‰º† JSON Êñá‰ª∂ (Êé®Ëçê)</div>
                                        <p className="text-xs text-blue-600 mb-3">ÊâãÊú∫Á´ØÈ¶ñÈÄâÔºÅÂ∞ÜÊîªÁï•‰øùÂ≠ò‰∏∫ .json Êñá‰ª∂Âêé‰∏ä‰º†ÔºåÊó†ÈúÄÂ§çÂà∂Á≤òË¥¥„ÄÇ</p>
                                        <label className="block w-full cursor-pointer bg-white border-2 border-dashed border-blue-300 rounded-xl p-4 text-center hover:bg-blue-50 transition-colors">
                                            <span className="text-blue-500 font-bold">ÁÇπÂáªÈÄâÊã©Êñá‰ª∂</span>
                                            <input type="file" accept=".json,.txt" onChange={handleFileImport} className="hidden" />
                                        </label>
                                    </div>

                                    <div className="flex items-center gap-4">
                                        <div className="h-px bg-gray-200 flex-1"></div>
                                        <span className="text-gray-400 text-xs font-bold">OR</span>
                                        <div className="h-px bg-gray-200 flex-1"></div>
                                    </div>

                                    {/* Option 2: Paste Text (Better UI) */}
                                    <form onSubmit={handleTextImport} className="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                                        <div className="font-bold text-gray-700 mb-2 flex items-center gap-2"><FileText size={18}/> ÊñπÂºè2ÔºöÁ≤òË¥¥ÊñáÊú¨</div>
                                        <textarea name="importText" className="w-full h-32 p-3 text-xs font-mono bg-white border border-gray-200 rounded-xl focus:ring-2 ring-blue-500 outline-none resize-none" placeholder='Âú®Ê≠§Á≤òË¥¥ JSON Êï∞ÊçÆ...'></textarea>
                                        <button type="submit" className="w-full mt-3 bg-black text-white py-3 rounded-xl font-bold hover:opacity-80">Á°ÆËÆ§ÂØºÂÖ•</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* NEW: DAY IMPORT MODAL (Appears after single day data is processed) */}
                    {dayDataToImport && (
                        <DayImportModal 
                            dayData={dayDataToImport}
                            plans={plans}
                            onConfirm={handleDayImportFinalize}
                            onCancel={() => setDayDataToImport(null)}
                        />
                    )}

                    {/* NEW: EXPORT MODAL */}
                    {exportData && (
                        <div className="fixed inset-0 bg-black/40 z-[10003] flex items-center justify-center p-4" onClick={() => setExportData(null)}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg">{exportData.title}</h3>
                                    <button onClick={() => setExportData(null)} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                                </div>
                                <p className="text-sm text-gray-500 mb-6">{exportData.desc}</p>
                                
                                <div className="space-y-3">
                                    <button onClick={() => {
                                        const blob = new Blob([JSON.stringify(exportData.data, null, 2)], {type: "application/json"});
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = exportData.filename;
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                        URL.revokeObjectURL(url);
                                        setExportData(null);
                                    }} className="w-full flex items-center justify-center gap-2 p-4 bg-blue-50 text-blue-600 rounded-xl font-bold hover:bg-blue-100 border border-blue-200">
                                        <FileDown size={20}/> ‰øùÂ≠ò‰∏∫ JSON Êñá‰ª∂
                                    </button>
                                    
                                    <button onClick={() => {
                                        navigator.clipboard.writeText(JSON.stringify(exportData.data));
                                        alert("Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ");
                                        setExportData(null);
                                    }} className="w-full flex items-center justify-center gap-2 p-4 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200">
                                        <Copy size={20}/> Â§çÂà∂ÊñáÊú¨ÂÜÖÂÆπ
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* DYNAMIC TIPS MODAL */}
                    {showTips && (
                        <div className="fixed inset-0 bg-black/40 z-[10000] flex items-center justify-center p-8" onClick={() => setShowTips(false)}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative animate-[fadeIn_0.2s_ease-out]" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg flex items-center gap-2">üí° Ë¥¥ÂøÉÂ∞èÂª∫ËÆÆ</h3>
                                    <button onClick={() => setShowTips(false)} className="p-2 bg-gray-100 rounded-full"><X size={16}/></button>
                                </div>
                                <div className="space-y-3 text-sm text-gray-600 leading-relaxed">
                                    {getTips().map((tip, i) => (
                                        <div key={i} className={`p-3 rounded-xl border ${i%3===0?'bg-orange-50 border-orange-100 text-orange-800':i%3===1?'bg-blue-50 border-blue-100 text-blue-800':'bg-green-50 border-green-100 text-green-800'}`}>
                                            <span className="font-bold block mb-1">{tip.title}</span>
                                            {tip.content}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* DATE PICKER */}
                    {showDatePicker && (
                        <div className="fixed inset-0 bg-black/40 z-[10000] flex items-center justify-center p-8" onClick={() => setShowDatePicker(false)}>
                            <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setShowDatePicker(false)} className="absolute top-4 right-4 p-2 bg-gray-100 rounded-full"><X size={14}/></button>
                                <h3 className="font-bold text-lg mb-4">ËÆæÁΩÆÂá∫ÂèëÊó•Êúü</h3>
                                <input type="date" value={activePlan.startDate || ''} onChange={(e) => updateStartDate(e.target.value)} className="w-full p-4 bg-gray-100 rounded-xl font-bold outline-none focus:ring-2 ring-blue-500" />
                                <p className="text-xs text-gray-400 mt-2">‰øÆÊîπÂêéÔºåÂêéÁª≠Ë°åÁ®ã‰ºöËá™Âä®È°∫Âª∂„ÄÇ</p>
                            </div>
                        </div>
                    )}
                </div>
            )
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>